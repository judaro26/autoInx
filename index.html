<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catalog & Ordering System</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  body { font-family: 'Inter', sans-serif; }

  /* Custom scrollbar */
  .custom-scrollbar::-webkit-scrollbar { width: 6px; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #6366f1; border-radius: 3px; }
  .custom-scrollbar::-webkit-scrollbar-track { background-color: #e5e7eb; }

  /* Modal background overlay */
  .modal-overlay { background-color: rgba(0,0,0,0.5); }
</style>

<script type="module">
  // --- FIREBASE IMPORTS ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { 
      getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, 
      signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword 
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Utility
  import { checkIPRange } from './js/utilities/utils.js';

  // --- GLOBAL STATE ---
  const state = {
      view: 'user',
      catalogs: [],
      items: [],
      cart: {},
      email: '',
      message: null,
      loading: false,
      isAdminIP: false,
      configLoaded: false,
      isModalOpen: false,
      modalMode: 'login',
      modalType: 'standard',
      userName: null,
      isMaintenanceMode: false,
      chatWidgetEnabled: false,
      productSearchTerm: '',
      selectedCategoryId: 'all'
  };

  const GET_CONFIG_FUNCTION = '/.netlify/functions/getAdminConfig';
  const CONFIG_CLIENT_FUNCTION = '/.netlify/functions/getClientFirebaseConfig';
  const CATALOGS_COLLECTION = `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/catalogs`;
  const ITEMS_COLLECTION = `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/items`;

  let app, db, auth;
  let userId = null;
  let isAuthReady = false;
  let explicitSignOutOccurred = false;
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // --- UTILITY FUNCTIONS ---
  const formatPrice = price => `$${(price / 100).toFixed(2)}`;
  const getTotalCartPrice = () => Object.values(state.cart).reduce((total, entry) => total + (entry.item.price || 0) * entry.quantity, 0);

  function showMessage(type, text, duration = 4000) {
      state.message = { type, text };
      render();
      setTimeout(() => { state.message = null; render(); }, duration);
  }

  function getFilteredAndCategorizedItems() {
      let filtered = state.items;
      const term = state.productSearchTerm.toLowerCase();
      if (term) filtered = filtered.filter(item => item.name.toLowerCase().includes(term) || item.description.toLowerCase().includes(term));
      if (state.selectedCategoryId !== 'all') filtered = filtered.filter(item => item.catalogId === state.selectedCategoryId);
      return filtered;
  }

  // --- RENDER FUNCTIONS ---
  function render() {
      const appEl = document.getElementById('app');
      if (!appEl) return;

      const totalCartPrice = getTotalCartPrice();

      appEl.innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50">

              <!-- Header -->
              <header class="bg-white shadow-lg sticky top-0 z-40">
                  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                      <h1 class="text-3xl font-bold text-indigo-700">Product Catalog</h1>
                      <div class="flex items-center space-x-4">
                          ${renderCartLink()}
                          ${renderAuthToggle()}
                      </div>
                  </div>
              </header>

              <!-- Main Content -->
              <main class="container mx-auto px-4 py-8">
                  ${state.view === 'admin' ? renderAdminView() : renderUserView()}
              </main>

              <!-- Messages -->
              ${renderMessage()}

              <!-- Modal -->
              ${renderModal()}

              <!-- Chat Widget -->
              ${renderChatWidget()}
          </div>
      `;
  }

  function renderCartLink() {
      const itemCount = Object.values(state.cart).reduce((sum, e) => sum + e.quantity, 0);
      if (!itemCount) return '';
      return `<a href="/checkout.html" onclick="window.module.continueToCheckout()" class="relative px-3 py-2 rounded-lg font-semibold text-white bg-pink-600 hover:bg-pink-700 transition duration-150 shadow-md flex items-center">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                  <span class="ml-2 hidden sm:inline">Checkout</span>
                  <span class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white">${itemCount}</span>
              </a>`;
  }

  function renderAuthToggle() {
      if (!state.configLoaded || !isAuthReady || (state.isMaintenanceMode && !state.userName)) return '';

      if (state.view === 'admin') {
          return `<button onclick="window.module.toggleView()" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 shadow-md">Exit Admin View</button>`;
      }

      if (state.userName) {
          return `<div class="flex items-center space-x-4">
                      <span class="text-gray-600 font-medium text-sm hidden sm:inline">Welcome, ${state.userName}</span>
                      ${state.isAdminIP ? `<a href="/admin.html" class="px-4 py-2 rounded-lg font-semibold text-white bg-yellow-500 hover:bg-yellow-600 shadow-md">Admin Dashboard</a>` : ''}
                      <button onclick="window.module.handleSignOut()" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 shadow-md">Sign Out</button>
                  </div>`;
      }

      const buttons = `
          <button onclick="window.module.registerUser()" class="text-sm font-medium text-gray-500 hover:text-indigo-600 transition">Sign Up</button>
          <button onclick="window.module.requestPasswordReset()" class="text-sm font-medium text-gray-500 hover:text-indigo-600 transition">Forgot Password?</button>`;

      return `<div class="flex items-center space-x-4">
                  ${buttons}
                  <button onclick="window.module.toggleView('standard')" class="px-4 py-2 rounded-lg font-semibold text-white bg-indigo-500 hover:bg-indigo-600 shadow-md">Login</button>
              </div>`;
  }

  function renderModal() {
      if (!state.isModalOpen) return '';
      const isLogin = state.modalMode === 'login';
      const title = isLogin ? 'Login' : 'Register';
      const submitText = isLogin ? 'Login' : 'Register';
      const emailField = `<input type="email" id="email-input" placeholder="Email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">`;
      const passwordField = `<input type="password" id="password-input" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">`;

      return `<div class="fixed inset-0 z-50 flex items-center justify-center modal-overlay" onclick="window.module.closeModal()">
                  <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm relative" onclick="event.stopPropagation()">
                      <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">${title}</h2>
                      <form onsubmit="window.module.handleStandardLogin(event)" class="space-y-4">
                          ${emailField}${passwordField}
                          <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 shadow-md mt-4">${submitText}</button>
                      </form>
                      <button onclick="window.module.closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                      </button>
                  </div>
              </div>`;
  }

  function renderMessage() {
      if (!state.message) return '';
      const colors = { success:'bg-green-500', error:'bg-red-500', warning:'bg-yellow-500', info:'bg-blue-500' };
      const icons = { success:'✅', error:'❌', warning:'⚠️', info:'ℹ️' };
      const { type, text } = state.message;
      return `<div class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white ${colors[type] || colors.info} flex items-center">${icons[type] || icons.info}<span class="ml-2">${text}</span></div>`;
  }

  function renderChatWidget() {
      if (!state.chatWidgetEnabled || state.isMaintenanceMode || state.view === 'admin') return '';
      return `<div class="fixed bottom-6 right-6 z-50">
                  <button class="w-14 h-14 bg-indigo-600 rounded-full text-white shadow-xl hover:bg-indigo-700 flex items-center justify-center">
                      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                  </button>
              </div>`;
  }

  function renderCategorySidebar() {
      const categories = [{ id:'all', name:'All Products', count: state.items.length }]
          .concat(state.catalogs.map(c => ({ id:c.id, name:c.name, count: state.items.filter(i=>i.catalogId===c.id).length })));
      return `<div class="md:col-span-1">
                  <div class="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-indigo-500 sticky top-4">
                      <h3 class="text-xl font-bold mb-4 text-indigo-700">Categories</h3>
                      <div class="space-y-2 max-h-96 custom-scrollbar overflow-y-auto">
                          ${categories.map(cat => `<button onclick="window.module.selectCategory('${cat.id}')" class="w-full text-left p-2 rounded-lg transition duration-150 ${state.selectedCategoryId===cat.id?'bg-indigo-600 text-white':'text-gray-700 hover:bg-gray-100'}">${cat.name} (${cat.count})</button>`).join('')}
                      </div>
                  </div>
              </div>`;
  }

  function renderProductGrid() {
      const items = getFilteredAndCategorizedItems();
      if (!items.length) return `<div class="p-8 text-center bg-white rounded-xl shadow-lg"><p class="text-gray-500 text-lg">No products match filters.</p></div>`;
      return `<div class="grid grid-cols-1 sm:grid-cols-2 gap-6">${items.map(item => `
                  <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
                      <img src="${item.imageUrl}" alt="${item.name}" class="w-full h-48 object-cover" onerror="this.src='https://placehold.co/400x300/a3a3a3/ffffff?text=Image+Missing';">
                      <div class="p-4">
                          <h4 class="text-xl font-semibold text-gray-800 truncate">${item.name}</h4>
                          <p class="text-2xl text-indigo-600 font-extrabold mt-1">${formatPrice(item.price)}</p>
                          <button onclick="window.module.addToCart(${JSON.stringify(item).replace(/"/g,'&quot;')})" class="mt-3 w-full bg-pink-500 text-white py-2 rounded-lg font-semibold hover:bg-pink-600 transition duration-150 shadow-md flex items-center justify-center">
                              Add to Cart
                          </button>
                      </div>
                  </div>`).join('')}</div>`;
  }

  function renderCartSidebar(totalCartPrice) {
      return `<div class="md:col-span-1 mt-8 md:mt-0">
                  <div class="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-pink-500 sticky top-4">
                      <h3 class="text-2xl font-bold mb-4 text-pink-600 flex items-center">Shopping Cart</h3>
                      <div class="space-y-3 max-h-60 custom-scrollbar overflow-y-auto pr-2">
                          ${Object.values(state.cart).length ? Object.values(state.cart).map(entry => `<div class="flex justify-between items-center border-b pb-2">
                              <div class="flex-1 min-w-0">
                                  <p class="text-sm font-medium text-gray-900 truncate">${entry.item.name}</p>
                                  <p class="text-xs text-gray-500">${formatPrice(entry.item.price)} each</p>
                              </div>
                              <div class="flex items-center space-x-2">
                                  <button onclick="window.module.updateCartQuantity('${entry.item.id}',-1)" class="text-gray-500 hover:text-red-500 font-bold p-1 rounded-full">-</button>
                                  <span class="text-sm font-semibold w-5 text-center">${entry.quantity}</span>
                                  <button onclick="window.module.updateCartQuantity('${entry.item.id}',1)" class="text-gray-500 hover:text-green-500 font-bold p-1 rounded-full">+</button>
                              </div>
                              <span class="text-sm font-bold ml-4">${formatPrice(entry.item.price*entry.quantity)}</span>
                          </div>`).join('') : '<p class="text-gray-500 italic">Your cart is empty.</p>'}
                      </div>
                      <div class="pt-4 mt-4 border-t border-gray-200 flex justify-between font-bold text-xl text-gray-800">
                          <span>Total:</span><span>${formatPrice(totalCartPrice)}</span>
                      </div>
                  </div>
              </div>`;
  }

  function renderAdminView() {
      return `<div class="space-y-10 p-6 bg-gray-50 rounded-xl shadow-inner md:flex md:space-x-10"><p class="text-xl font-semibold text-gray-700">Redirecting to Admin Dashboard...</p></div>`;
  }

  function renderUserView() {
      if (state.isMaintenanceMode) return `<div class="p-10 text-center text-gray-600"><h2 class="text-2xl font-bold mt-4">System Under Maintenance</h2><p class="mt-2">Scheduled maintenance ongoing. Only administrators can access.</p></div>`;
      return `<div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                  ${renderCategorySidebar()}
                  <div class="md:col-span-2 space-y-8">
                      <div class="sticky top-0 bg-gray-100 z-10 py-2 -mt-2 -mx-4 md:m-0 md:p-0">
                          <input type="text" value="${state.productSearchTerm}" placeholder="Search..." oninput="window.module.handleProductSearchInput(event)" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                      </div>
                      ${renderProductGrid()}
                  </div>
                  ${renderCartSidebar(getTotalCartPrice())}
              </div>`;
  }

  // --- EVENT HANDLERS ---
  function handleProductSearchInput(e) { state.productSearchTerm = e.target.value; render(); }
  function selectCategory(catId) { state.selectedCategoryId = catId; state.productSearchTerm = ''; render(); }

  function addToCart(item) {
      if (state.isMaintenanceMode) { showMessage('warning','Store under maintenance'); return; }
      const current = state.cart[item.id];
      state.cart[item.id] = { item, quantity: current ? current.quantity + 1 : 1 };
      showMessage('success', `${item.name} added to cart`);
      render();
  }

  function updateCartQuantity(itemId, delta) {
      const entry = state.cart[itemId];
      if (!entry) return;
      entry.quantity += delta;
      if (entry.quantity <= 0) delete state.cart[itemId];
      render();
  }

  function handleSignOut() {
      explicitSignOutOccurred = true;
      signOut(auth).then(() => {
          state.userName = null;
          render();
      }).catch(err => showMessage('error', err.message));
  }

  function openModal(mode = 'login') {
      state.isModalOpen = true;
      state.modalMode = mode;
      render();
  }

  function closeModal() {
      state.isModalOpen = false;
      render();
  }

  function handleStandardLogin(event) {
      event.preventDefault();
      const email = document.getElementById('email-input').value;
      const password = document.getElementById('password-input').value;
      if (!email || !password) { showMessage('warning','Email and password required'); return; }

      if (state.modalMode === 'login') {
          signInWithEmailAndPassword(auth, email, password)
              .then(userCredential => {
                  state.userName = userCredential.user.email;
                  closeModal();
                  render();
              })
              .catch(err => showMessage('error', err.message));
      } else {
          createUserWithEmailAndPassword(auth, email, password)
              .then(userCredential => {
                  state.userName = userCredential.user.email;
                  closeModal();
                  render();
              })
              .catch(err => showMessage('error', err.message));
      }
  }

  function registerUser() { openModal('register'); }

  function requestPasswordReset() {
      const email = prompt("Enter your email for password reset:");
      if (!email) return;
      auth.sendPasswordResetEmail(email).then(() => showMessage('success','Password reset email sent'))
          .catch(err => showMessage('error', err.message));
  }

  // --- MODULE EXPORTS ---
  window.module = {
      render,
      addToCart,
      updateCartQuantity,
      handleSignOut,
      openModal,
      closeModal,
      handleStandardLogin,
      registerUser,
      requestPasswordReset,
      selectCategory,
      handleProductSearchInput,
  };

  // --- INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', async () => {
      try {
          const configResp = await fetch(CONFIG_CLIENT_FUNCTION);
          const config = await configResp.json();
          app = initializeApp(config);
          auth = getAuth(app);
          db = getFirestore(app);

          // Listen for auth changes
          onAuthStateChanged(auth, user => {
              isAuthReady = true;
              if (user && !explicitSignOutOccurred) {
                  state.userName = user.email || 'Anonymous';
              }
              render();
          });

          // Load catalogs
          const catalogsSnap = await fetch(`/.netlify/functions/getCatalogs`);
          state.catalogs = await catalogsSnap.json();

          // Load items
          const itemsSnap = await fetch(`/.netlify/functions/getItems`);
          state.items = await itemsSnap.json();

          state.configLoaded = true;
          render();
      } catch (err) {
          console.error('Initialization error:', err);
          showMessage('error', 'Failed to load application');
      }
  });
</script>
</head>

<body class="bg-gray-50">
  <div id="app"></div>
</body>
</html>

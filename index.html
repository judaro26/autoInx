<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoInx Market Portal</title>
    
    <link rel="icon" type="image/x-icon" href="/images/AutoInx logo.ico">
    
    <link rel="icon" type="image/png" sizes="32x32" href="/images/AutoInx logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
</head>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoInx Bringing the world closer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for better appearance */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #6366f1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #e5e7eb; }
        /* Modal background */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Import IP Check Utility for Admin Gate
        import { checkIPRange } from './js/utilities/utils.js';
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const RECAPTCHA_SITE_KEY = '6LdiVx4sAAAAAJR3votlSI8nB61NMFmh5YZokFQ-';
        const CAPTCHA_VERIFY_FUNCTION = '/.netlify/functions/verifyCaptcha';
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let explicitSignOutOccurred = false;
        let currentLang = 'es'; // Initialized here, updated in setupFirebase
        
        // --- LANGUAGE TEXT MAPPING (MODIFIED) ---
        const TEXT = {
            es: {
                logoTitle: 'Catálogo', welcome: 'Bienvenido,', signOut: 'Cerrar Sesión', adminDashboard: 'Panel Admin', adminLogin: 'Acceso Admin', standardLogin: 'Ingresa a mi cuenta', signUp: 'Registrarse', forgotPassword: '¿Olvidaste la Contraseña?', searchPlaceholder: 'Buscar productos por nombre o descripción...', categoriesHeader: 'Categorías', productsVisible: 'visibles', allProducts: 'Todos los Productos', noProducts: 'No se encontraron productos que coincidan con tus filtros.', shoppingCart: 'Carrito de Compras', cartEmpty: 'Tu carrito está vacío.', maintenanceTitle: 'Sistema en Mantenimiento', maintenanceMsg: 'Estamos realizando mantenimiento programado. Disculpa las molestias.', exitAdminView: 'Salir de la Vista Admin', loginSuccessful: '¡Inicio de sesión exitoso!', registerSuccessful: '¡Registro exitoso! Ya has iniciado sesión.', loginUser: 'Acceso de Usuario', loginAdmin: 'Acceso de Administrador (Seguro)', registerNew: 'Registrar Cuenta Nueva', loginBtn: 'Acceder', registerBtn: 'Registrar', needAccount: '¿Necesitas una cuenta? Regístrate', alreadyRegistered: '¿Ya estás registrado? Accede', adminSetupNote: 'Las cuentas de administrador deben ser configuradas por un administrador.', checkout: 'Finalizar Compra',
                // NEW MISSING LABELS ADDED HERE:
                emailLabel: 'Correo Electrónico',
                passwordLabel: 'Contraseña',
                perUnit: 'por unidad',
                total: 'Total',
                acceptTOS: 'Acepto los <a href="/terms.html" target="_blank" class="font-semibold text-indigo-500 hover:text-indigo-700">Términos y Condiciones</a> y la Política de Privacidad.',
                eConsentRequired: 'Debe aceptar los Términos y Condiciones para registrarse.',
                captchaRequired: 'Por favor, complete la validación anti-bot.',
                eConsentStoreFail: 'Error al registrar el consentimiento. Intente nuevamente.',
                viewOrders: 'Ver mis pedidos',
                // FIX: Update product button text
                addToCart: 'Añadir al Carrito', 
            },
            en: {
                logoTitle: 'Catalog', welcome: 'Welcome,', signOut: 'Sign Out', adminDashboard: 'Admin Dashboard', adminLogin: 'Admin Login', standardLogin: 'Login', signUp: 'Sign Up', forgotPassword: 'Forgot Password?', searchPlaceholder: 'Search products by name or description...', categoriesHeader: 'Categories', productsVisible: 'visible', allProducts: 'All Products', noProducts: 'No products match your current filters.', shoppingCart: 'Shopping Cart', cartEmpty: 'Your cart is empty.', maintenanceTitle: 'System Under Maintenance', maintenanceMsg: 'We are performing scheduled maintenance. We apologize for any inconvenience.', exitAdminView: 'Exit Admin View', loginSuccessful: 'Login successful!', registerSuccessful: 'Registration successful! You are now logged in.', loginUser: 'User Login', loginAdmin: 'Admin Login (Secure)', registerNew: 'Register New Account', loginBtn: 'Login', registerBtn: 'Register', needAccount: 'Need an account? Register', alreadyRegistered: 'Already registered? Login', adminSetupNote: 'Admin accounts must be set up by an administrator.', checkout: 'Checkout',
                // NEW MISSING LABELS ADDED HERE:
                emailLabel: 'Email Address',
                passwordLabel: 'Password',
                perUnit: 'per unit',
                total: 'Total',
                acceptTOS: 'I agree to the <a href="/terms.html" target="_blank" class="font-semibold text-indigo-500 hover:text-indigo-700">Terms and Conditions</a> and Privacy Policy.',
                eConsentRequired: 'You must accept the Terms and Conditions to register.',
                captchaRequired: 'Please complete the anti-bot validation.',
                eConsentStoreFail: 'Failed to record consent. Please try again.',
                viewOrders: 'View my orders',
                // FIX: Update product button text
                addToCart: 'Add to Cart',
            }
        };

        const t = key => TEXT[currentLang][key] || TEXT['es'][key];

        function setLanguage(lang) {
            // FIX: Persist language setting
            localStorage.setItem('siteLang', lang);
            currentLang = lang;
            render();
        }
        
        // --- GLOBAL STATE (MODIFIED) ---
        const state = {
            view: 'user', 
            catalogs: [],
            items: [],
            cart: {}, 
            email: '',
            message: null,
            loading: false,
            isAdminIP: false, 
            configLoaded: false, 
            isModalOpen: false, 
            modalMode: 'login', 
            modalType: 'standard', 
            userName: null, 
            isMaintenanceMode: false, 
            chatWidgetEnabled: false, 
            productSearchTerm: '', 
            selectedCategoryId: 'all', 
            selectedItem: null,
            captchaToken: null
        };
        
        const GET_CONFIG_FUNCTION = '/.netlify/functions/getAdminConfig';
        const GET_PUBLIC_CONFIG_FUNCTION = '/.netlify/functions/getPublicConfig'; // <-- Use a new public endpoint
        const GET_SECURE_CONFIG_FUNCTION = '/.netlify/functions/getAdminConfig'; // <-- Keep for secure admin use
        const CONFIG_CLIENT_FUNCTION = '/.netlify/functions/getClientFirebaseConfig'; 
        const GET_CLIENT_IP_FUNCTION = '/.netlify/functions/getClientIp'; 
        
        // --- RENDER FUNCTIONS (MODIFIED FOR I18N) ---
        function render() {
            const appElement = document.getElementById('app');
            if (!appElement) return;
            
            const loadingState = document.getElementById('loadingState');
            if (loadingState && (state.configLoaded && isAuthReady)) {
                loadingState.remove();
            }
        
            appElement.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-100 to-indigo-50">
                    <header class="bg-white shadow-lg sticky top-0 z-40">
                        <div class="container mx-auto px-4 py-3">
                            
                            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-2">  
                                <div class="flex items-center space-x-2">
                                    <img src="images/AutoInx logo.png" alt="AutoInx Logo" class="h-8 w-auto">
                                    <h1 class="text-2xl sm:text-3xl font-bold text-indigo-700">${t('logoTitle')}</h1>
                                </div>
                                <div class="flex items-center space-x-3">
                                    ${renderCartLink()}
                                    ${renderAuthToggle()}
                                </div>
                            </div>
                            
                            <nav class="flex flex-wrap justify-center sm:justify-start gap-x-6 gap-y-2 text-sm sm:text-base font-semibold border-t pt-3 mt-1">
                                <a href="index.html" class="text-indigo-600 border-b-2 border-indigo-600 pb-1">Catálogo</a>
                                <a href="checkout.html" class="text-gray-600 hover:text-indigo-600 transition">Mi Carrito</a>
                                <a href="contact.html" class="text-gray-600 hover:text-indigo-600 transition">Contacto</a>
                                <a href="about.html" class="text-gray-600 hover:text-indigo-600 transition">Sobre Nosotros</a>
                            </nav>
                        </div>
                    </header>
        
                    <main class="container mx-auto px-4 py-6">
                        ${state.view === 'admin' ? renderAdminView() : renderUserView()}
                    </main>
        
                    ${renderMessage()}
                    ${renderModal()}
                    ${renderItemDetailModal()}
                    ${renderChatWidget()}
                </div>
            `;
        
            // Re-bind T&C link logic
            const tosLabel = document.querySelector('label[for="accept-tos"]');
            if (tosLabel) {
                tosLabel.innerHTML = t('acceptTOS');
            }
        }

        // --- NEW UTILITY FUNCTIONS ---
        
        // This function is called by the reCAPTCHA script when validation is successful
        function handleCaptchaSuccess(token) {
            console.log("reCAPTCHA successful. Token:", token);
            state.captchaToken = token;
        }
        
        // Function to log e-consent to Firestore
        async function logEconsent(userId, email, ipAddress, tosVersion = 'v1') {
            if (!db) return console.error("Firestore not initialized for e-consent logging.");
        
            try {
                const econsentDocRef = doc(db, 'users', userId, 'econsent', tosVersion);
                await setDoc(econsentDocRef, {
                    email: email,
                    tosAccepted: true,
                    tosVersion: tosVersion, // Use a version identifier for T&C changes
                    ipAddress: ipAddress,
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent
                });
                console.log("E-Consent logged successfully for user:", userId);
                return true;
            } catch (error) {
                console.error("Error logging e-consent:", error);
                return false;
            }
        }
        
        
        async function verifyCaptcha(token) {
            if (!token) return false;
        
            // Save token locally before clearing the global state
            const currentToken = state.captchaToken; 
            state.captchaToken = null; // Clear immediately to prevent accidental reuse
        
            try {
                const response = await fetch(CAPTCHA_VERIFY_FUNCTION, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Use the locally saved token, but this is the original code structure:
                    body: JSON.stringify({ token }) 
                });
        
                if (!response.ok) throw new Error('Network response was not ok');
        
                const result = await response.json();
                // The Netlify function should return { success: true/false }
                return result.success; // The server determines success
        
            } catch (error) {
                console.error("Error verifying reCAPTCHA:", error);
                return false;
            }
        }       
        
        function renderItemDetailModal() {
            if (!state.selectedItem) return '';
            
            const item = state.selectedItem;
            const catalog = state.catalogs.find(c => c.id === item.catalogId);
            const categoryName = catalog ? catalog.name : 'Uncategorized';
            
            // Ensure we have an array to work with
            const images = item.imageUrls && item.imageUrls.length > 0 
                ? item.imageUrls 
                : [item.imageUrl || 'https://placehold.co/400x300/a3a3a3/ffffff?text=Image+Missing'];
        
            return `
                <div class="fixed inset-0 z-50 flex items-center justify-center modal-overlay" onclick="window.module.closeItemDetailModal()">
                    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl relative max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        
                        <button onclick="window.module.closeItemDetailModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
        
                        <div class="flex flex-col lg:flex-row gap-8">
                            <div class="w-full lg:w-1/2 space-y-4">
                                <div class="relative aspect-square overflow-hidden rounded-lg shadow-inner bg-gray-100">
                                    <img id="main-modal-image" src="${images[0]}" alt="${item.name}"
                                         class="w-full h-full object-contain transition-opacity duration-300">
                                </div>
                                
                                ${images.length > 1 ? `
                                <div class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                                    ${images.map((img, idx) => `
                                        <img src="${img}" 
                                             onclick="document.getElementById('main-modal-image').src='${img}'"
                                             class="h-16 w-16 object-cover rounded border-2 border-transparent hover:border-indigo-500 cursor-pointer transition-all flex-shrink-0"
                                             onerror="this.style.display='none'">
                                    `).join('')}
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="flex-grow">
                                <h2 class="text-3xl font-extrabold text-indigo-700 mb-2">${item.name}</h2>
                                <p class="text-2xl font-bold text-pink-600 mb-4">${formatPrice(item.price)}</p>
                                
                                <div class="mb-4 text-sm text-gray-500">
                                    <span class="font-semibold">${t('categoriesHeader')}:</span> ${categoryName}
                                </div>
                                
                                <div class="border-t pt-4">
                                    <h3 class="text-lg font-bold text-gray-800 mb-2">Description</h3>
                                    <p class="text-gray-600 leading-relaxed text-sm">${item.description}</p>
                                </div>
        
                                <button onclick="window.module.addToCart(${JSON.stringify(item).replace(/"/g, '&quot;')})"
                                        class="mt-8 w-full bg-pink-500 text-white py-4 rounded-lg font-bold hover:bg-pink-600 transition shadow-lg flex items-center justify-center uppercase tracking-wider">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                    ${t('addToCart')}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function loadRecaptchaScript() {
            if (document.getElementById('recaptcha-script')) return; // Already loaded
        
            const script = document.createElement('script');
            script.id = 'recaptcha-script';
            // Use the globally defined RECAPTCHA_SITE_KEY from your script
            const RECAPTCHA_SITE_KEY = '6LdiVx4sAAAAAJR3votlSI8nB61NMFmh5YZokFQ-'; 
            // Pass the handleCaptchaSuccess function as the callback
            script.src = `https://www.google.com/recaptcha/enterprise.js?render=${RECAPTCHA_SITE_KEY}&onload=onloadRecaptchaCallback`;
            script.async = true;
            document.head.appendChild(script);
            console.log("reCAPTCHA script injected.");
        }
        // function to display the product
        function renderProductCard(item) {
            const itemJson = JSON.stringify(item).replace(/'/g, "\\'").replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); 
            
            // Pick the first image from array, or fallback to the single imageUrl
            const displayImg = (item.imageUrls && item.imageUrls.length > 0) 
                ? item.imageUrls[0] 
                : (item.imageUrl || 'https://placehold.co/400x300/a3a3a3/ffffff?text=Image+Missing');
        
            return `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden transform hover:scale-[1.02] transition duration-300 border border-gray-100 flex flex-col">
                    <div class="relative cursor-pointer group" onclick="window.module.openItemDetailModal(JSON.parse(this.parentElement.querySelector('h4').dataset.item))">
                        <img src="${displayImg}" alt="${item.name}" class="w-full h-48 object-cover transition-transform duration-500 group-hover:scale-110" 
                             onerror="this.onerror=null;this.src='https://placehold.co/400x300/a3a3a3/ffffff?text=Image+Missing';">
                        ${item.imageUrls && item.imageUrls.length > 1 ? `
                            <div class="absolute bottom-2 right-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded-md backdrop-blur-sm">
                                +${item.imageUrls.length - 1} fotos
                            </div>
                        ` : ''}
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h4 onclick="window.module.openItemDetailModal(JSON.parse(this.dataset.item))"
                            class="text-xl font-semibold text-gray-800 truncate cursor-pointer hover:text-indigo-600 transition"
                            data-item='${itemJson}'>
                            ${item.name}
                        </h4>
                        
                        <p class="text-2xl text-indigo-600 font-extrabold mt-1">${formatPrice(item.price)}</p>
                        
                        <div class="mt-auto pt-3">
                            <button onclick="window.module.addToCart(JSON.parse(this.dataset.item))"
                                     data-item='${itemJson}'
                                     class="w-full bg-pink-500 text-white py-2 rounded-lg font-semibold hover:bg-pink-600 transition duration-150 shadow-md flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                ${t('addToCart')}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderCartLink() {
            const itemCount = Object.values(state.cart).reduce((total, entry) => total + entry.quantity, 0);
            
            if (itemCount === 0) return '';
            return `
                <a href="/checkout.html" onclick="event.preventDefault(); window.module.continueToCheckout()"
                   class="relative px-3 py-2 rounded-lg font-semibold text-white bg-pink-600 hover:bg-pink-700 transition duration-150 shadow-md flex items-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span class="ml-2 hidden sm:inline">${t('checkout')}</span>
                    <span class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white">${itemCount}</span>
                </a>
            `;
        }
        function renderAuthToggle() {
            // Condition reads: If not loaded, OR (if Maintenance AND not logged in AND not whitelisted), then return ''.
            if (!state.configLoaded || !isAuthReady || (state.isMaintenanceMode && !state.userName && !state.isAdminIP)) return '';
        
            if (state.view === 'admin') {
                return `
                    <button onclick="window.module.toggleView()" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition duration-150 shadow-md">
                        ${t('exitAdminView')}
                    </button>
                `;
            }
            
            // This block determines the "logged-in status" (MODIFIED)
            if (state.userName) {
                return `
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600 font-medium text-sm hidden sm:inline">${t('welcome')} ${state.userName}</span>
                        
                        <a href="/myOrders.html" class="px-4 py-2 rounded-lg font-semibold text-white bg-indigo-500 hover:bg-indigo-600 transition duration-150 shadow-md">
                            ${t('viewOrders')}
                        </a>
                        
                        ${state.isAdminIP ?
                            `<a href="/admin.html" class="px-4 py-2 rounded-lg font-semibold text-white bg-yellow-500 hover:bg-yellow-600 transition duration-150 shadow-md">
                                ${t('adminDashboard')}
                            </a>` : ''}
                        <button onclick="window.module.handleSignOut()" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition duration-150 shadow-md">
                            ${t('signOut')}
                        </button>
                        <button onclick="window.module.setLanguage('${currentLang === 'es' ? 'en' : 'es'}')"
                                 class="px-3 py-1 text-sm rounded-full bg-gray-100 hover:bg-gray-200">
                            ${currentLang === 'es' ? 'English' : 'Español'}
                        </button>
                    </div>
                `;
            }
            
            // This block determines the "logged-out status"
            const commonButtons = `
                <button onclick="window.module.registerUser()"
                        class="text-sm font-medium text-gray-500 hover:text-indigo-600 transition duration-150">
                    ${t('signUp')}
                </button>
                <button onclick="window.module.requestPasswordReset()"
                        class="text-sm font-medium text-gray-500 hover:text-indigo-600 transition duration-150">
                    ${t('forgotPassword')}
                </button>
            `;
            
            if (state.isAdminIP) {
                return `
                    <div class="flex items-center space-x-4">
                        ${commonButtons}
                        <button onclick="window.module.showLoginModal('admin', 'login')" class="px-4 py-2 rounded-lg font-semibold text-white bg-yellow-500 hover:bg-yellow-600 transition duration-150 shadow-md">
                            ${t('adminLogin')}
                        </button>
                        <button onclick="window.module.setLanguage('${currentLang === 'es' ? 'en' : 'es'}')"
                                 class="px-3 py-1 text-sm rounded-full bg-gray-100 hover:bg-gray-200">
                            ${currentLang === 'es' ? 'English' : 'Español'}
                        </button>
                    </div>
                `;
            } else {
                return `
                    <div class="flex items-center space-x-4">
                        ${commonButtons}
                        <button onclick="window.module.showLoginModal('standard', 'login')" class="px-4 py-2 rounded-lg font-semibold text-white bg-indigo-500 hover:bg-indigo-600 transition duration-150 shadow-md">
                            ${t('standardLogin')}
                        </button>
                        <button onclick="window.module.setLanguage('${currentLang === 'es' ? 'en' : 'es'}')"
                                 class="px-3 py-1 text-sm rounded-full bg-gray-100 hover:bg-gray-200">
                            ${currentLang === 'es' ? 'English' : 'Español'}
                        </button>
                    </div>
                `;
            }
        }
        function renderModal() {
            if (!state.isModalOpen) return '';
            
            const isLogin = state.modalMode === 'login';
            const isStandard = state.modalType === 'standard';
            const isRegister = state.modalMode === 'register';
            const isAdminLogin = state.modalType === 'admin' && isLogin;
            const title = isLogin ? (isStandard ? t('loginUser') : t('loginAdmin')) : t('registerNew');
            const submitText = isLogin ? t('loginBtn') : t('registerBtn');
            const switchModeText = isLogin ? t('needAccount') : t('alreadyRegistered');
            
            let emailField = `<input type="email" id="email-input" placeholder="${t('emailLabel') || 'Email'}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">`;
            let passwordField = `<input type="password" id="password-input" placeholder="${t('passwordLabel') || 'Password'}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">`;
                                
            // NEW: T&C and CAPTCHA fields for registration
            let registerFields = '';
            if (isRegister) {
                registerFields = `
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <input type="checkbox" id="accept-tos" required class="mt-1 mr-2 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="accept-tos" class="text-sm text-gray-600" id="tos-label-container">${t('acceptTOS')}</label>
                        </div>
                        <div id="captcha-container"></div> 
                    </div>
                `;
            }
            
            const googleAuthButton = (isStandard || isRegister) ? `
                <div class="my-4 flex items-center">
                    <hr class="flex-grow border-gray-300">
                    <span class="px-2 text-gray-500 text-sm">OR</span>
                    <hr class="flex-grow border-gray-300">
                </div>
                <button type="button" onclick="window.module.handleGoogleSignIn()" class="w-full bg-white text-gray-700 py-3 rounded-lg font-semibold border border-gray-300 hover:bg-gray-50 transition duration-150 shadow-sm flex items-center justify-center">
                    ${isLogin ? 'Sign in with Google' : 'Register with Google'}
                </button>
            ` : '';
            
            const switchModeSection = isAdminLogin ?
                `<p class="w-full mt-4 text-sm text-gray-400 text-center">${t('adminSetupNote')}</p>` :
                `<button type="button" onclick="window.module.showLoginModal(state.modalType, state.modalMode === 'login' ? 'register' : 'login')"
                        class="w-full mt-4 text-sm text-indigo-600 hover:text-indigo-800 transition text-center">
                    ${switchModeText}
                </button>`;
        
            return `
                <div class="fixed inset-0 z-50 flex items-center justify-center modal-overlay" onclick="window.module.closeModal()">
                    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm relative" onclick="event.stopPropagation()">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">${title}</h2>
                        <div id="auth-message" class="text-red-500 text-sm mb-4 text-center font-medium"></div>
                        
                        <form onsubmit="window.module.handleStandardAuth(event)" class="space-y-4" novalidate>
                            <div class="space-y-4">
                                ${emailField}
                                ${passwordField}
                                ${registerFields}
                            </div>
                            <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md mt-4">
                                ${submitText}
                            </button>
                            ${googleAuthButton}
                        </form>
                        ${switchModeSection}
                        <button onclick="window.module.closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
            `;
        }
        function renderMessage() {
            if (!state.message) return '';
            const { type, text } = state.message;
            let bgColor, icon;
            if (type === 'success') { bgColor = 'bg-green-500'; icon = '✅'; }
            else if (type === 'error') { bgColor = 'bg-red-500'; icon = '❌'; }
            else if (type === 'warning') { bgColor = 'bg-yellow-500'; icon = '⚠️'; }
            else { bgColor = 'bg-blue-500'; icon = 'ℹ️'; }
            return `
                <div class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white ${bgColor} transition-opacity duration-300">
                    <div class="flex items-center">
                        <span class="text-xl mr-2">${icon}</span>
                        <span>${text}</span>
                    </div>
                </div>
            `;
        }
        // --- RENDER CHAT WIDGET (MODIFIED) ---
        function renderChatWidget() {
            // Check 1: If Chat is globally disabled, or if the view is explicitly 'admin', hide it.
            if (!state.chatWidgetEnabled || state.view === 'admin') return '';
            
            // NOTE: The WhatsApp number from checkout.html is used here: +57 300 123 4567
        
            return `
                <div id="chatWidget" class="fixed bottom-6 right-6 z-50">
                    <a href="https://wa.me/573001234567" target="_blank" rel="noopener"
                        class="block w-14 h-14 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full shadow-xl hover:shadow-2xl transform hover:scale-110 transition-all duration-300 flex items-center justify-center animate-pulse"
                        aria-label="Open WhatsApp Chat">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.297-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.265c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488z"/>
                        </svg>
                    </a>
                </div>
            `;
        }
        // function to render how the categories display
        function renderCategorySidebar() {
            const itemsToCount = getFilteredAndCategorizedItems();
            const allCategories = [{ id: 'all', name: t('allProducts'), count: state.items.length }]
                .concat(state.catalogs.map(c => ({
                    id: c.id,
                    name: c.name,
                    count: state.items.filter(i => i.catalogId === c.id).length
                })))
                .filter(c => c.count > 0 || c.id === 'all');
                
            return `
                <div class="col-span-1 md:col-span-1">
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg border-t-4 border-indigo-500 sticky top-20 md:top-24">
                        <h3 class="text-lg font-bold mb-3 text-indigo-700 hidden md:block">${t('categoriesHeader')}</h3>
                        <div class="flex flex-row md:flex-col overflow-x-auto md:overflow-y-auto space-x-2 md:space-x-0 md:space-y-2 pb-2 md:pb-0 custom-scrollbar">
                            ${allCategories.map(cat => {
                                const isActive = state.selectedCategoryId === cat.id;
                                return `
                                    <button onclick="window.module.selectCategory('${cat.id}')"
                                             class="whitespace-nowrap text-xs md:text-sm text-left px-3 py-2 rounded-lg transition-all
                                             ${isActive ? 'bg-indigo-600 text-white font-bold shadow-md' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'}">
                                        ${cat.name} <span class="opacity-70">(${cat.count})</span>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        function renderProductGrid() {
            const itemsToDisplay = getFilteredAndCategorizedItems();
            if (itemsToDisplay.length === 0) {
                return `
                    <div class="p-8 text-center bg-white rounded-xl shadow-lg">
                        <p class="text-gray-500 text-lg">${t('noProducts')}</p>
                    </div>
                `;
            }
            const itemsByCatalog = itemsToDisplay.reduce((acc, item) => {
                const catalogName = state.catalogs.find(c => c.id === item.catalogId)?.name || 'Uncategorized';
                if (!acc[catalogName]) acc[catalogName] = [];
                acc[catalogName].push(item);
                return acc;
            }, {});
            return Object.keys(itemsByCatalog).map(catalogName => `
                <div>
                    ${state.selectedCategoryId === 'all' ? `<h3 class="text-2xl font-bold mb-4 text-indigo-700">${catalogName}</h3>` : ''}
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        ${itemsByCatalog[catalogName].map(item => renderProductCard(item)).join('')}
                    </div>
                </div>
            `).join('<hr class="my-8 border-indigo-200">');
        }
        
        function renderCartSidebar(totalCartPrice) {
            return `
                <div class="md:col-span-1 mt-8 md:mt-0">
                    <div class="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-pink-500 sticky top-4">
                        <h3 class="text-2xl font-bold mb-4 text-pink-600 flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43c.18.72.744 1.3 1.488 1.49l7.058 1.884c.732.195 1.57-.10 1.83-.75l2.3-5.75A.999.999 0 0017 9H7a1 1 0 010-2h11.234c.328 0 .633.203.774.512l1.745 4.363a2 2 0 01-1.928 2.575l-7.058-1.884a2 2 0 00-1.97.262l-1.358 5.43A.997.997 0 005.418 19H17a1 1 0 100-2H5.418a1 1 0 00-.986 1.157l1.4 5.6A3 3 0 113.1 20.157L2.5 17.5A1 1 0 003 16h14a1 1 0 100-2H6.22l-.305-1.222A2 2 0 005.418 9H17a1 1 0 100-2H4.22L3.915 3H3zM6 21a2 2 0 100-4 2 2 0 000 4zm11 0a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                            ${t('shoppingCart')}
                        </h3>
                        <div class="space-y-3 max-h-60 custom-scrollbar overflow-y-auto pr-2">
                            ${Object.values(state.cart).length > 0
                                ? Object.values(state.cart).map(entry => `
                                    <div class="flex justify-between items-center border-b pb-2">
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 truncate">${entry.item.name}</p>
                                            <p class="text-xs text-gray-500">${formatPrice(entry.item.price)} ${t('perUnit') || 'each'}</p>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="window.module.updateCartQuantity('${entry.item.id}', -1)"
                                                     class="text-gray-500 hover:text-red-500 font-bold p-1 rounded-full transition">-</button>
                                            <span class="text-sm font-semibold w-5 text-center">${entry.quantity}</span>
                                            <button onclick="window.module.updateCartQuantity('${entry.item.id}', 1)"
                                                     class="text-gray-500 hover:text-green-500 font-bold p-1 rounded-full transition">+</button>
                                        </div>
                                        <span class="text-sm font-bold ml-4">${formatPrice(entry.item.price * entry.quantity)}</span>
                                    </div>
                                `).join('')
                                : `<p class="text-gray-500 italic">${t('cartEmpty')}</p>`
                            }
                        </div>
                        <div class="pt-4 mt-4 border-t border-gray-200">
                            <div class="flex justify-between font-bold text-xl text-gray-800">
                                <span>${t('total') || 'Total'}:</span>
                                <span>${formatPrice(totalCartPrice)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderAdminView() {
            if (state.view !== 'admin') return '';
            return `
                <div class="space-y-10 p-6 bg-gray-50 rounded-xl shadow-inner md:flex md:space-y-0 md:space-x-10">
                    <p class="text-xl font-semibold text-gray-700">Redirecting to Admin Dashboard...</p>
                </div>
            `;
        }
        
        function renderUserView() {
            if (state.isMaintenanceMode && !state.isAdminIP) {
                return `<div class="p-10 text-center text-gray-600">
                    <h2 class="text-2xl font-bold mt-4">${t('maintenanceTitle')}</h2>
                    <p class="mt-2">${t('maintenanceMsg')}</p>
                </div>`;
            }
            
            return `
                <div class="flex flex-col md:grid md:grid-cols-4 gap-6">
                    
                    <div class="md:col-span-1">
                        ${renderCategorySidebar()}
                    </div>
        
                    <div class="md:col-span-2 space-y-6">
                        <div class="sticky top-[135px] md:top-24 bg-indigo-50/80 backdrop-blur-md z-10 py-2 -mx-2 px-2 rounded-xl">
                            <input type="text"
                                   oninput="window.module.handleProductSearchInput(event)"
                                   value="${state.productSearchTerm}"
                                   placeholder="${t('searchPlaceholder')}"
                                   class="w-full p-3 border border-indigo-300 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-500 bg-white">
                        </div>
                        ${renderProductGrid()}
                    </div>
        
                    <div class="md:col-span-1">
                        ${renderCartSidebar(getTotalCartPrice())}
                    </div>
                </div>
            `;
        }
        // --- HELPER FUNCTIONS ---
        const formatPrice = (price) => `$${(price / 100).toFixed(2)}`;
        const getTotalCartPrice = () => Object.values(state.cart).reduce((total, entry) => total + (entry.item.price || 0) * entry.quantity, 0);
        function showMessage(type, text, duration = 4000) {
            state.message = { type, text };
            render();
            setTimeout(() => {
                state.message = null;
                render();
            }, duration);
        }
        
        function getFilteredAndCategorizedItems() {
            let filtered = state.items;
            const term = state.productSearchTerm.toLowerCase();
            if (term) {
                filtered = filtered.filter(item =>
                    item.name.toLowerCase().includes(term) ||
                    item.description.toLowerCase().includes(term)
                );
            }
            if (state.selectedCategoryId && state.selectedCategoryId !== 'all') {
                filtered = filtered.filter(item => item.catalogId === state.selectedCategoryId);
            }
            return filtered;
        }
        
        function handleProductSearchInput(e) {
            state.productSearchTerm = e.target.value;
            render();
        }
        function selectCategory(categoryId) {
            state.selectedCategoryId = categoryId;
            state.productSearchTerm = '';
            render();
        }
        // --- FIREBASE CONFIGURATION LOAD (3-Tier Fallback) ---
        async function loadFirebaseConfig() {
            if (typeof __firebase_config !== 'undefined' && __firebase_config && Object.keys(JSON.parse(__firebase_config)).length > 0) {
                console.log("Tier 1: Loaded config from Canvas environment.");
                return JSON.parse(__firebase_config);
            }
            try {
                const response = await fetch(CONFIG_CLIENT_FUNCTION);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch config from Netlify Function (Status: ${response.status})`);
                }
                const config = await response.json();
                console.log("Tier 2: Public config loaded successfully.");
                return config;
            } catch (error) {
                console.error("Tier 2 Failed. Falling back to empty config.", error);
                return {};
            }
        }
        
        // --- FETCH GLOBAL CONFIG AFTER FIREBASE IS READY ---
                async function fetchAndApplyGlobalConfig() {
            try {
                // FIX: Use the new public function path
                const response = await fetch(GET_PUBLIC_CONFIG_FUNCTION);
                if (!response.ok) throw new Error('Failed to fetch global config.');
                
                const config = await response.json();
                
                // Ensure chat widget honors the current maintenance state
                state.chatWidgetEnabled = (config.chatWidgetEnabled === true) && (state.isMaintenanceMode === false);
                
            } catch (error) {
                console.error("Error fetching global config:", error);
                state.chatWidgetEnabled = false;
            }
        }
        // --- FIRESTORE COLLECTION PATHS ---
        const CATALOGS_COLLECTION = `artifacts/${appId}/public/data/catalogs`;
        const ITEMS_COLLECTION = `artifacts/${appId}/public/data/items`;
        // --- PERSISTENCE & LISTENING ---
        
        function loadCartFromSession() {
            try {
                const cartJson = sessionStorage.getItem('autoInxCart');
                if (cartJson && cartJson !== '{}') {
                    state.cart = JSON.parse(cartJson);
                    console.log("Cart loaded from session storage.");
                }
            } catch (error) {
                console.error("Error loading cart from session storage:", error);
                sessionStorage.removeItem('autoInxCart');
            }
        }
        function setupRealtimeListeners() {
            if (!isAuthReady || !db) return;
            
            // CRITICAL FIX: Allow listeners to run if Maintenance Mode is OFF OR if the user is a whitelisted Admin IP
            if (state.isMaintenanceMode && !state.isAdminIP) {
                console.log("Realtime listeners suppressed due to Maintenance Mode.");
                return;
            }
            
            loadCartFromSession();
            // 1. Catalogs Listener
            onSnapshot(collection(db, CATALOGS_COLLECTION), (snapshot) => {
                state.catalogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Catalogs updated:", state.catalogs.length);
                render();
            }, (error) => {
                console.error("Error listening to catalogs:", error);
                state.message = { type: 'error', text: 'Failed to fetch catalogs.' };
                render();
            });
            // 2. Items Listener
            onSnapshot(collection(db, ITEMS_COLLECTION), (snapshot) => {
                state.items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Items updated:", state.items.length);
                render();
            }, (error) => {
                console.error("Error listening to items:", error);
                state.message = { type: 'error', text: 'Failed to fetch items.' };
                render();
            });
        }
        // --- USER ACTIONS ---
        function addToCart(item) {
            if (state.isMaintenanceMode) {
                showMessage('warning', t('maintenanceMsg'), 4000);
                return;
            }
            const currentEntry = state.cart[item.id];
            const newQuantity = currentEntry ? currentEntry.quantity + 1 : 1;
            state.cart = {
                ...state.cart,
                [item.id]: { item, quantity: newQuantity }
            };
            showMessage('info', `Added 1x ${item.name} to cart.`, 2000);
            render();
        }
        function updateCartQuantity(itemId, change) {
            if (state.isMaintenanceMode) return;
            
            const currentEntry = state.cart[itemId];
            if (!currentEntry) return;
            const newQuantity = currentEntry.quantity + change;
            if (newQuantity <= 0) {
                const newCart = { ...state.cart };
                delete newCart[itemId];
                state.cart = newCart;
                showMessage('info', `${currentEntry.item.name} removed from cart.`, 2000);
            } else {
                state.cart = {
                    ...state.cart,
                    [itemId]: { item: currentEntry.item, quantity: newQuantity }
                };
            }
            render();
        }
        function continueToCheckout() {
            if (state.isMaintenanceMode) {
                showMessage('warning', t('maintenanceMsg'), 4000);
                return;
            }
            if (Object.keys(state.cart).length === 0) {
                showMessage('error', 'Your cart is empty!');
                return;
            }
            
            try {
                sessionStorage.setItem('autoInxCart', JSON.stringify(state.cart));
            } catch (error) {
                console.error("Failed to save cart to session storage:", error);
                showMessage('error', 'Could not save cart for checkout. Try clearing your browser cache.', 5000);
                return;
            }
            window.location.href = '/checkout.html';
        }
        // --- AUTHENTICATION & MODAL FUNCTIONS ---
        function openItemDetailModal(item) {
            state.selectedItem = item;
            render();
        }
        function closeItemDetailModal() {
            state.selectedItem = null;
            render();
        }
        
        function showLoginModal(type, mode) {
            state.isModalOpen = true;
            state.modalMode = mode;
            state.modalType = type;
            state.captchaToken = null; // NEW: Reset captcha token on modal open
        
            render(); // This renders the new modal structure (including the g-recaptcha div) into the DOM
            
            // Clear previous error messages
            const messageEl = document.getElementById('auth-message');
            if (messageEl) {
                messageEl.textContent = '';
            }
        
            // Clear input fields
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';
        
            // FIX: Only attempt to reset reCAPTCHA if we are in register mode 
            // AND the global grecaptcha object exists. We use a slight delay 
            // to give the reCAPTCHA script time to process the newly rendered div.
            if (mode === 'register' && typeof grecaptcha !== 'undefined') {
                setTimeout(() => {
                    const captchaContainer = document.getElementById('captcha-container');
                    
                    // Check if the container is present AND if reCAPTCHA has actually rendered a widget inside it.
                    if (captchaContainer && captchaContainer.children.length > 0) {
                        try {
                            grecaptcha.reset(); 
                        } catch (e) {
                            // This catch is a last resort, but the DOM check should prevent the common error.
                            console.warn("reCAPTCHA reset failed: Client may not be fully ready.", e);
                        }
                    }
                }, 100); // 100ms delay for robustness
            }
        }
        function closeModal() {
            state.isModalOpen = false;
            render();
        }
        async function handleSignOut() {
            try {
                explicitSignOutOccurred = true;
                await signOut(auth);
                showMessage('info', 'Signed out successfully.', 3000);
                state.view = 'user';
            } catch (error) {
                console.error("Error signing out:", error);
                showMessage('error', 'Failed to sign out.');
            }
            render();
        }
        async function handleStandardAuth(event) {
            event.preventDefault();
            console.log('handleStandardAuth called.');
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            const email = emailInput ? emailInput.value : '';
            const password = passwordInput ? passwordInput.value : '';
            const messageEl = document.getElementById('auth-message');
            messageEl.textContent = ''; // Clear previous error message
        
            // 1. Basic Validation (for both login and register)
            if (!email || !password) {
                messageEl.textContent = `❌ ${t(state.modalMode === 'login' ? 'loginBtn' : 'registerBtn')} Error: Please enter both email and password.`;
                return;
            }
        
            // 2. Registration-Specific Validation (T&C and CAPTCHA)
            if (state.modalMode === 'register') {
                const acceptTosCheckbox = document.getElementById('accept-tos');
                
                // T&C Check
                if (!acceptTosCheckbox || !acceptTosCheckbox.checked) {
                    messageEl.textContent = `❌ ${t('eConsentRequired')}`;
                    return;
                }
        
                // CAPTCHA Validation
                if (typeof grecaptcha !== 'undefined' && typeof grecaptcha.enterprise !== 'undefined') {
                    messageEl.textContent = 'Validating anti-bot check...';
                    try {
                        // Execute the action 'register' to get a token
                        state.captchaToken = await grecaptcha.enterprise.execute(RECAPTCHA_SITE_KEY, {action: 'register'});
                        messageEl.textContent = ''; // Clear temporary message
                    } catch (e) {
                        console.error("reCAPTCHA execution failed:", e);
                        messageEl.textContent = `❌ ${t('captchaRequired')}`;
                        return;
                    }
                } else {
                    // Fallback if reCAPTCHA script hasn't loaded (though dynamic load should prevent this)
                    messageEl.textContent = `❌ ${t('captchaRequired')}`;
                    return;
                }
        
                const captchaVerified = await verifyCaptcha(state.captchaToken);
                if (!captchaVerified) {
                    messageEl.textContent = `❌ ${t('captchaRequired')}`;
                    state.captchaToken = null; // Clear token on failure
                    if (typeof grecaptcha !== 'undefined' && document.getElementById('captcha-container')?.children.length > 0) {
                        grecaptcha.reset();
                    }
                    return;
                }
            }
        
            // 3. Authentication Logic
            try {
                if (state.modalMode === 'login') {
                    // Login Logic (Admin or Standard)
                    if (state.modalType === 'admin') {
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        const idTokenResult = await user.getIdTokenResult(true);
                        
                        if (idTokenResult.claims.admin === true) {
                            closeModal();
                            window.location.href = '/admin.html';
                        } else {
                            await signOut(auth);
                            messageEl.textContent = `❌ ${t('loginBtn')} Error: Admin privileges required.`;
                        }
                    } else {
                        // Standard User Login
                        await signInWithEmailAndPassword(auth, email, password);
                        showMessage('success', t('loginSuccessful'), 2000);
                    }
                } else {
                    // Registration Logic
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
        
                    // Log E-Consent for Compliance
                    const eConsentSuccess = await logEconsent(user.uid, email, state.clientIp); // Assumes state.clientIp is available
                    
                    if (!eConsentSuccess) {
                        // Critical failure: delete the account and log the error.
                        await user.delete();
                        messageEl.textContent = `❌ ${t('eConsentStoreFail')}`;
                        return;
                    }
        
                    showMessage('success', t('registerSuccessful'), 2000);
                }
                closeModal();
            } catch (error) {
                console.error("Authentication failed:", error.code, error);
                let errorMessage = 'An error occurred during authentication.';
                
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'Invalid email or password.';
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already registered. Try logging in.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak (must be 6+ characters).';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'The email address is not valid.';
                }
        
                messageEl.textContent = `❌ ${errorMessage}`;
            }
            render();
        }
        async function handleGoogleSignIn() {
            const messageEl = document.getElementById('auth-message');
            messageEl.textContent = ''; // Clear previous message
            
            // Define RECAPTCHA_SITE_KEY here for use in grecaptcha.enterprise.execute
            const RECAPTCHA_SITE_KEY = '6LdiVx4sAAAAAJR3votlSI8nB61NMFmh5YZokFQ-';
            
            // Check if the modal is in Registration mode
            if (state.modalMode === 'register') {
                const acceptTosCheckbox = document.getElementById('accept-tos');
        
                // 1. T&C Check
                if (!acceptTosCheckbox || !acceptTosCheckbox.checked) {
                    messageEl.textContent = `❌ ${t('eConsentRequired')}`;
                    return;
                }
        
                // --- 2. EXPLICIT RECAPTCHA EXECUTION ---
                if (typeof grecaptcha !== 'undefined' && typeof grecaptcha.enterprise !== 'undefined') {
                    messageEl.textContent = 'Validating anti-bot check...';
                    try {
                        // Execute reCAPTCHA Enterprise for a token
                        state.captchaToken = await grecaptcha.enterprise.execute(RECAPTCHA_SITE_KEY, {action: 'register'});
                        messageEl.textContent = ''; // Clear temporary message
                    } catch (e) {
                        console.error("reCAPTCHA execution failed during Google Sign-In:", e);
                        messageEl.textContent = `❌ ${t('captchaRequired')}`;
                        return;
                    }
                } else {
                    messageEl.textContent = `❌ ReCAPTCHA client not ready. ${t('captchaRequired')}`;
                    return;
                }
                
                // 3. CAPTCHA Verification (server-side check)
                const captchaVerified = await verifyCaptcha(state.captchaToken);
                if (!captchaVerified) {
                    messageEl.textContent = `❌ ${t('captchaRequired')}`;
                    return;
                }
            }
            
            // Original Google Sign-In Logic
            messageEl.textContent = 'Logging in with Google...';
            
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                
                // E-consent logging 
                if (state.modalMode === 'register') {
                     // NOTE: The listener will now handle state updates, but we need the user object 
                     // for logEconsent. For now, we assume the user object is available here.
                     const user = auth.currentUser; 
                     if (user) {
                         const eConsentSuccess = await logEconsent(user.uid, user.email, state.clientIp); 
                         if (!eConsentSuccess) {
                             await user.delete();
                             messageEl.textContent = `❌ ${t('eConsentStoreFail')}`;
                             return;
                         }
                     }
                }
                
                showMessage('success', 'Google Sign-In successful!', 2000);
                
            } catch (error) {
                // ... (error handling remains the same)
                console.error("Google Sign-In failed:", error);
                let errorMessage = 'Google Sign-In failed. Check console for details.';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign-in window closed. Please try again.';
                } else if (error.code === 'auth/cancelled-popup-request') {
                     errorMessage = 'Authentication window was cancelled or already in progress.';
                }
                messageEl.textContent = `❌ ${errorMessage}`;
            }
            render(); // Update the message in the modal if an error occurred
        }
        async function requestPasswordReset() {
            const email = prompt("Enter the email associated with your account to receive a password reset link:");
            
            if (!email) {
                return;
            }
            
            if (!email.includes('@') || email.length < 5) {
                showMessage('error', 'Please enter a valid email address.');
                return;
            }
            showMessage('info', 'Requesting password reset link...', 60000);
            
            const netlifyFunctionUrl = '/.netlify/functions/sendPasswordResetEmail';
            try {
                const MAX_RETRIES = 3;
                let response = null;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        response = await fetch(netlifyFunctionUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email })
                        });
                        if (response.ok) {
                            break;
                        } else if (i === MAX_RETRIES - 1) {
                            throw new Error(`Server returned status ${response.status}`);
                        }
                    } catch (fetchError) {
                        if (i === MAX_RETRIES - 1) {
                            throw fetchError;
                        }
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        console.log(`Retrying password reset request... attempt ${i + 2}`);
                    }
                }
                const result = await response.json();
                if (response.ok) {
                    showMessage('success', `If an account exists for ${email}, a password reset link has been sent. Check your inbox!`, 8000);
                } else {
                    showMessage('error', result.error || 'Failed to request password reset. Please try again later.');
                }
            } catch (error) {
                console.error("Password reset request failed:", error);
                showMessage('error', 'Network error. Could not connect to the password reset service.');
            }
        }
        
        async function registerUser() {
            showLoginModal('standard', 'register');
        }
        
        // --- NEW CHAT WIDGET FUNCTION ---
        function openChatWidget() {
            // The button now contains a direct link to WhatsApp in renderChatWidget, so this is no longer a placeholder.
            console.log('WhatsApp Chat widget clicked. Direct link is being opened.');
        }
        

        // --- CORE FIREBASE INITIALIZATION ---
        async function setupFirebase() {
            try {
                // FIX: Load language preference
                const storedLang = localStorage.getItem('siteLang');
                if (storedLang && TEXT[storedLang]) {
                    currentLang = storedLang;
                }
        
                // --- 1. MAINTENANCE GATE & ADMIN BYPASS CHECK ---
                const ipResponse = await fetch(GET_CLIENT_IP_FUNCTION);
                const { ip: clientIp } = await ipResponse.json();
        
                // FIX: Use the new public function that DOES NOT require a token
                const configResponse = await fetch(GET_PUBLIC_CONFIG_FUNCTION); 
                const globalConfig = await configResponse.json();
        
                state.isMaintenanceMode = globalConfig.maintenanceMode === true;
                
                // Note: The Admin IP check is still secure because checkIPRange is an imported client-side utility 
                // that uses the static whitelist, and it relies on a local utility (utils.js) 
                // or a secured server-side check (which your original code seemed to merge into fetch).
                // Since the `getAdminConfig` endpoint also handles the full whitelist, we'll 
                // stick to your original client-side IP check utility for this flow.
                
                const firestoreWhitelist = Array.isArray(globalConfig.ipWhitelist) ? globalConfig.ipWhitelist : [];
                const isStaticIp = await checkIPRange(clientIp); // Assuming checkIPRange is defined in utils.js
                const isWhitelisted = firestoreWhitelist.includes(clientIp) || isStaticIp;
        
                state.isAdminIP = isWhitelisted;
                state.clientIp = clientIp; // Store client IP
        
                if (state.isMaintenanceMode && !state.isAdminIP) {
                    state.configLoaded = true;
                    isAuthReady = true;
                    render();
                    console.log("Site locked by maintenance mode. IP not whitelisted. Exiting setup.");
                    return;
                }
        
                // --- END MAINTENANCE GATE ---
        
                const firebaseConfig = await loadFirebaseConfig();
                state.configLoaded = true;
        
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing or failed to load from Netlify Function.");
                    state.message = { type: 'error', text: 'Firebase configuration is missing. Cannot save data.' };
                    render();
                    return;
                }
        
                setLogLevel('debug');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
        
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken)
                        .catch(error => {
                            console.error("Error signing in with custom token:", error);
                        });
                } else if (!auth.currentUser) {
                    await signInAnonymously(auth).catch(error => {
                        console.error("Error during initial anonymous sign-in:", error);
                    });
                }
        
                // onAuthStateChanged Listener (UPDATED)
                onAuthStateChanged(auth, async (user) => {
        
                    if (user) {
                        userId = user.uid;
        
                        if (!user.isAnonymous) {
                            // NEW: Log the source user data and the assigned state
                            console.log("Firebase User Object: Email:", user.email, "Display Name:", user.displayName);
        
                            state.userName = user.email || user.displayName || 'Authenticated User';
        
                            // NEW: Log the resulting state value
                            console.log("STATE UPDATE: state.userName set to:", state.userName);
        
                            explicitSignOutOccurred = false;
                        } else {
                            state.userName = null;
                        }
        
                    } else {
                        userId = null;
                        state.userName = null;
                        if (explicitSignOutOccurred) {
                            console.log("Explicit sign-out processed. Preventing anonymous re-sign-in on this loop.");
                            explicitSignOutOccurred = false;
                        }
                        console.log("STATE UPDATE: state.userName set to NULL (Signed Out)");
                    }
                    isAuthReady = true;
                    // Fetch global config again now that auth status is known (for chat widget status)
                    await fetchAndApplyGlobalConfig(); 
                    if (db) setupRealtimeListeners();
        
                    // START FINAL GUARANTEE CHECK (Guarantees modal closure and correct status)
                    if (user && !user.isAnonymous && state.isModalOpen) {
                        // 1. Force state.isModalOpen to false to close the modal.
                        state.isModalOpen = false;
                        console.log("Auth success detected. Forcing modal close and displaying user status.");
                    } else if (state.isModalOpen) {
                        // If modal is open, but we are not authenticated, keep state.isModalOpen as is.
                        // This ensures the modal stays open if an error occurred during login/registration.
                    }
                    // END FINAL GUARANTEE CHECK
        
                    render();
                });
            } catch (error) {
                console.error("Firebase setup failed:", error);
                state.message = { type: 'error', text: 'Failed to initialize Firebase.' };
                render();
            }
        }
        // --- EXPOSED MODULE FUNCTIONS & INITIALIZATION ---
        function toggleView(type = 'standard') {
            if (state.view === 'user') {
                showLoginModal(type, 'login');
            } else {
                state.view = 'user';
            }
            render();
        }
        window.module = {
            setupFirebase,
            render,
            toggleView,
            addToCart,
            updateCartQuantity,
            continueToCheckout,
            handleProductSearchInput,
            selectCategory,
            requestPasswordReset,
            registerUser,
            showLoginModal,
            handleStandardAuth,
            handleCaptchaSuccess,
            handleGoogleSignIn,
            closeModal,
            handleSignOut,
            setLanguage, // Exported language setter
            openItemDetailModal,
            closeItemDetailModal,
            openChatWidget 
        };
        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase();
            loadRecaptchaScript();
        });
    </script>
</head>
    <body class="bg-gradient-to-br from-blue-100 to-blue-50 min-h-screen">
    <div id="app">
        <div id="loadingState" class="text-center p-20">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600">Loading autoinx.com ...</p>
        </div>
    </div>

    <footer class="bg-gray-900 text-white p-10 mt-10">
        <div class="max-w-5xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 border-b border-gray-700 pb-8 mb-8">
                
                <div>
                    <h4 class="text-2xl font-extrabold text-indigo-400 mb-4">AutoInx</h4>
                    <p class="text-gray-400 text-sm">Your reliable source for high-quality auto parts in the Colombian and US markets. Family-owned and committed to service.</p>
                </div>

                <div>
                    <h4 class="text-xl font-bold mb-4">General Support</h4>
                    <p class="text-gray-400 mb-2">Non-Order Questions:</p>
                    <a href="mailto:support@autoinx.com" class="text-indigo-400 hover:text-indigo-300 font-medium">support@autoinx.com</a>
                    
                    <h4 class="text-xl font-bold mt-6 mb-4">Order Inquiries</h4>
                    <p class="text-gray-400 mb-2">Order-Related Questions:</p>
                    <a href="mailto:orders@autoinx.com" class="text-indigo-400 hover:text-indigo-300 font-medium">orders@autoinx.com</a>
                </div>
                
                <div>
                    <h4 class="text-xl font-bold mb-4">Phone Contact</h4>
                    <p class="text-gray-400 mb-2">US Number (WhatsApp):</p>
                    <a href="tel:+19377016185" class="text-lg font-extrabold text-white block hover:text-indigo-400">
                        (937) 701-6185
                    </a>
                    
                    <p class="text-gray-400 mt-4 mb-2">Colombian Number (WhatsApp):</p>
                    <a href="tel:+573217040789" class="text-lg font-extrabold text-white block hover:text-indigo-400">
                        +57 321 704 0789
                    </a>
                </div>

                <div>
                    <h4 class="text-xl font-bold mb-4">Locations</h4>
                    
                    <p class="font-medium text-white">Colombia</p>
                    <p class="text-gray-400 text-sm">Calle 68A 92-24, Bogota DC</p>
                    <p class="text-gray-400 text-sm mb-4">Calle 68A 92-58, Bogota</p>
                    
                    <p class="font-medium text-white">United States</p>
                    <p class="text-gray-400 text-sm">587 Paradise Blvd, Hayward, CA 94541</p>
                </div>
            </div>

            <div class="text-center text-sm">
                <p class="text-gray-500">&copy; 2025 AutoInx. All rights reserved. | Family-Owned Operation</p>
            </div>
        </div>
    </footer>
</body>
</html>

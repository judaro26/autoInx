<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalog & Ordering System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for better appearance */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #6366f1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #e5e7eb; }
        /* Modal background */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // ADDED GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Import IP Check Utility for Admin Gate
        import { checkIPRange } from './js/utilities/utils.js';

        // Global variables provided by the Canvas environment (used if defined)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let explicitSignOutOccurred = false; 

        // --- GLOBAL STATE ---
        const state = {
            view: 'user', // 'user' or 'admin'
            catalogs: [],
            items: [],
            cart: {}, // {itemId: {item: {}, quantity: 1}}
            email: '',
            message: null,
            loading: false,
            isAdminIP: false, // New state for IP whitelist check
            configLoaded: false, // Tracks if Firebase config is successfully loaded
            isModalOpen: false, // New state for modal control
            modalMode: 'login', // 'login' or 'register'
            modalType: 'standard', // 'standard' or 'admin'
            userName: null, // To store the logged-in user's name/email
            isMaintenanceMode: false, // NEW: Maintenance mode status
            chatWidgetEnabled: false, // ADDED: Chat widget status
            productSearchTerm: '', // NEW: Search term for products
            selectedCategoryId: 'all' // NEW: ID of the selected category, 'all' by default
        };
        
        const GET_CONFIG_FUNCTION = '/.netlify/functions/getAdminConfig';

        // --- FIREBASE CONFIGURATION LOAD (3-Tier Fallback) ---
        async function loadFirebaseConfig() {
            // ... (unchanged)
        }

        // --- MAINTENANCE MODE CHECK (Bypass for Admins) ---
        async function checkMaintenanceMode(user) {
            // ... (unchanged)
        }

        // --- NEW: FETCH GLOBAL CONFIG AFTER FIREBASE IS READY ---
        async function fetchGlobalConfig() {
            try {
                const response = await fetch(GET_CONFIG_FUNCTION);
                if (!response.ok) throw new Error('Failed to fetch global config.');
                
                const config = await response.json();
                
                // IMPORTANT: Only show widget if maintenance mode is OFF AND widget is enabled
                state.chatWidgetEnabled = (config.chatWidgetEnabled === true) && (config.maintenanceMode === false); 
                
            } catch (error) {
                console.error("Error fetching global config:", error);
                state.chatWidgetEnabled = false; // Fail safe: keep widget off
            }
            render(); // Re-render to show/hide widget
        }


        // --- FIREBASE INITIALIZATION & AUTH ---
        async function setupFirebase() {
            try {
                // ... (initial checks unchanged)
                
                // Authentication Listener
                onAuthStateChanged(auth, async (user) => {
                    // 1. Check Maintenance Mode before processing listeners/data
                    const isSiteLocked = await checkMaintenanceMode(user);
                    
                    if (isSiteLocked) {
                        // If site is locked and user is NOT an admin, stop data loading/listeners.
                        isAuthReady = true;
                        render();
                        return;
                    }

                    // ... (user/userId logic unchanged)
                    
                    isAuthReady = true;
                    // AFTER AUTH IS READY, FETCH FULL CONFIG (including chat status)
                    fetchGlobalConfig(); 
                    if (db) setupRealtimeListeners();
                    render();
                });


            } catch (error) {
                console.error("Firebase setup failed:", error);
                state.message = { type: 'error', text: 'Failed to initialize Firebase.' };
                render();
            }
        }
        
        // --- PERSISTENCE & LISTENING ---
        
        // NEW: Function to load cart from session storage when page loads or reloads
        function loadCartFromSession() {
            try {
                const cartJson = sessionStorage.getItem('autoInxCart');
                if (cartJson && cartJson !== '{}') {
                    // Overwrite empty state.cart with session data only if it exists
                    state.cart = JSON.parse(cartJson);
                    console.log("Cart loaded from session storage.");
                }
            } catch (error) {
                console.error("Error loading cart from session storage:", error);
                sessionStorage.removeItem('autoInxCart'); // Clear invalid data
            }
        }


        // --- FIRESTORE REALTIME LISTENERS ---
        function setupRealtimeListeners() {
            if (!isAuthReady || !db) return;
            // Prevent listeners from running if site is in maintenance mode for public users
            if (state.isMaintenanceMode) return; 

            loadCartFromSession(); // Load cart on initial setup/return from checkout

            // ... (rest of listeners unchanged)
        }

        // ... (Helper Functions, User Actions, Auth Functions unchanged)

        // --- RENDER HELPERS (MODIFIED) ---
        
        // NEW: Chat Widget Render
        function renderChatWidget() {
            // Widget should not show if Maintenance Mode is active or if explicitly disabled by admin
            if (!state.chatWidgetEnabled || state.isMaintenanceMode || state.view === 'admin') return '';
            
            // Simple placeholder for a chat widget container
            return `
                <div class="fixed bottom-6 right-6 z-50">
                    <button class="w-14 h-14 bg-indigo-600 rounded-full text-white shadow-xl hover:bg-indigo-700 transition transform hover:scale-110 flex items-center justify-center" aria-label="Open Chat">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                    </button>
                </div>
            `;
        }

        // ... (renderCategorySidebar, renderProductGrid, renderCartSidebar unchanged)

        // --- MAIN RENDER FUNCTIONS (MODIFIED) ---

        function render() {
            const appContainer = document.getElementById('app');
            if (!appContainer) return;

            // Simple admin check
            const currentContent = state.view === 'admin' ? renderAdminView() : renderUserView();

            appContainer.innerHTML = `
                ${renderMessage()}
                ${renderModal()}
                ${renderChatWidget()} <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                    <header class="flex justify-between items-center mb-10 pb-4 border-b border-indigo-200">
                        <h1 class="text-4xl font-extrabold text-indigo-700">
                            ${state.view === 'admin' ? 'Administration Panel' : 'Online Store'}
                        </h1>
                        <div class="flex items-center space-x-4">
                            ${state.view === 'user' ? renderCartLink() : ''} 
                            ${renderAuthToggle()}
                        </div>
                    </header>
                    ${currentContent}

                    <footer class="mt-12 text-center text-sm text-gray-500 pt-6 border-t border-gray-100">
                        <p>App ID: ${appId} | User ID: ${userId || 'N/A'}</p>
                        <p>Data stored securely in Firestore.</p>
                    </footer>
                </div>
            `;
        }

        // ... (Exposed module functions and initialization unchanged)
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app">
        <div id="loadingState" class="text-center p-20">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600">Loading application and connecting to Firebase...</p>
        </div>
    </div>
</body>
</html>

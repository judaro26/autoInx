<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">My Orders - autoInx</title>
    <meta id="pageDescription" name="description" content="Check the history and status of your orders at autoInx.">
    <link rel="icon" type="image/x-icon" href="/images/AutoInx logo.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/AutoInx logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        primary: '#6366f1',
                        accent: '#a78bfa'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%); min-height: 100vh; }
        .glass-header {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #c4b5fd, #818cf8);
            border-radius: 3px;
        }
        .order-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .order-card:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgba(99, 102, 241, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }

        /* Animaciones definidas manualmente para mayor control */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div class="flex flex-col min-h-screen">
        <div id="app" class="max-w-7xl mx-auto px-6 sm:px-8 lg:px-10 py-8 flex-grow w-full">
            
            <div class="flex justify-end mb-4">
                <div id="user-status-container" class="text-sm font-medium text-gray-600 flex items-center space-x-4">
                    </div>
            </div>

            <header class="glass-header rounded-3xl shadow-2xl p-8 mb-12 border-t-8 border-indigo-600 sticky top-4 z-50">
                <div class="flex flex-col lg:flex-row justify-between items-center gap-6">
                    <div class="flex items-center space-x-6">
                        <img src="images/AutoInx logo.png" alt="AutoInx" class="h-14 drop-shadow-lg">
                        <h1 data-i18n="headerTitle" class="text-4xl lg:text-5xl font-extrabold bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">
                            My Orders
                        </h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <select id="language-switcher" class="px-3 py-2 border rounded-full text-gray-700 font-semibold shadow-inner focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="en">English</option>
                            <option value="es">Español</option>
                        </select>
                        <a href="index.html" class="group flex items-center gap-3 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-full hover:shadow-2xl transform hover:scale-105 transition-all duration-300">
                            <svg class="w-5 h-5 group-hover:-translate-x-1 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                            <span data-i18n="backToStoreLink">Return to Store</span>
                        </a>
                    </div>
                </div>
            </header>

            <div id="loadingState" class="min-h-[60vh] flex items-center justify-center">
                <div class="text-center">
                    <div class="w-16 h-16 mx-auto mb-6 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                    <p data-i18n="loadingText" class="text-2xl font-bold text-indigo-700">Loading your orders...</p>
                    <p data-i18n="loadingSubtext" class="text-gray-500 mt-2">This only takes a second</p>
                </div>
            </div>

            <div id="ordersContainer" class="hidden space-y-8">
                <div class="text-center mb-10">
                    <h2 data-i18n="historyTitle" class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">
                        Purchase History
                    </h2>
                    <p data-i18n="historySubtitle" class="text-gray-600 mt-3 text-lg">Here are all your orders placed at autoInx</p>
                </div>
                <div id="ordersList" class="grid gap-8 md:grid-cols-1 lg:grid-cols-1"></div>
            </div>

            <div id="messageContainer" class="mt-12"></div>
        </div>

        <footer class="bg-gradient-to-t from-gray-900 to-gray-800 text-white py-16 mt-20">
            </footer>
    </div>

    <script type="module">
        // --- 1. LANGUAGE AND TRANSLATION LOGIC ---
        const translations = {
            en: {
                // ... (Existing translations)
                pageTitle: 'My Orders - autoInx',
                pageDescription: 'Check the history and status of your orders at autoInx.',
                headerTitle: 'My Orders',
                backToStoreLink: 'Return to Store',
                loadingText: 'Loading your orders...',
                loadingSubtext: 'This only takes a second',
                historyTitle: 'Purchase History',
                historySubtitle: 'Here are all your orders placed at autoInx',
                notLoggedIn: 'Please log in to view your orders. Redirecting...',
                connectionError: 'Connection error. Check your internet and try again.',
                noOrdersTitle: 'You don\'t have any orders yet',
                noOrdersSubtext: 'When you make your first purchase, it will appear here',
                goToStore: 'Go to the Store',
                order: 'Order',
                paid: 'PAID',
                pending: 'PENDING',
                totalPaid: 'Total Paid',
                shippingAddress: 'Shipping Address',
                notSpecified: 'Not Specified',
                items: 'Items',
                productsBought: 'Products bought:',
                statusDelivered: 'Delivered',
                statusShipped: 'Shipped',
                statusProcessing: 'Processing',
                statusCancelled: 'Cancelled',
                statusPending: 'Pending',
                statusManuallyCreated: 'Manually Created',
                statusNoStatus: 'No Status',
                // NEW TRANSLATIONS
                loggedInAs: 'Logged in as',
                logout: 'Logout',
                notLoggedInStatus: 'Not Logged In'
            },
            es: {
                // ... (Existing translations)
                pageTitle: 'Mis Pedidos - autoInx',
                pageDescription: 'Revisa el historial y estado de tus pedidos en autoInx.',
                headerTitle: 'Mis Pedidos',
                backToStoreLink: 'Volver a la Tienda',
                loadingText: 'Cargando tus pedidos...',
                loadingSubtext: 'Esto solo toma un segundo',
                historyTitle: 'Historial de Compras',
                historySubtitle: 'Aquí tienes todos tus pedidos realizados en autoInx',
                notLoggedIn: 'Inicia sesión para ver tus pedidos. Redirigiendo...',
                connectionError: 'Error de conexión. Revisa tu internet e intenta de nuevo.',
                noOrdersTitle: 'Aún no tienes pedidos',
                noOrdersSubtext: 'Cuando hagas tu primera compra, aparecerá aquí',
                goToStore: 'Ir a la Tienda',
                order: 'Pedido',
                paid: 'PAGADO',
                pending: 'PENDIENTE',
                totalPaid: 'Total Pagado',
                shippingAddress: 'Dirección de Envío',
                notSpecified: 'No especificada',
                items: 'Artículos',
                productsBought: 'Productos comprados:',
                statusDelivered: 'Entregado',
                statusShipped: 'Enviado',
                statusProcessing: 'Procesando',
                statusCancelled: 'Cancelado',
                statusPending: 'Pendiente',
                statusManuallyCreated: 'Creado Manualmente',
                statusNoStatus: 'Sin estado',
                // NEW TRANSLATIONS
                loggedInAs: 'Sesión iniciada como',
                logout: 'Cerrar Sesión',
                notLoggedInStatus: 'Sesión no Iniciada'
            }
        };

        let currentLang = localStorage.getItem('lang') || 'en';

        function applyTranslations(lang) {
            const dictionary = translations[lang];
            
            // HTML attributes
            document.documentElement.lang = lang;
            document.getElementById('pageTitle').textContent = dictionary.pageTitle;
            document.getElementById('pageDescription').setAttribute('content', dictionary.pageDescription);

            // General text content
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (dictionary[key]) {
                    element.textContent = dictionary[key];
                }
            });
            // Update the user status display immediately after language switch
            updateUserStatusDisplay(window.currentUser);
        }

        // Event listener for the language switcher
        document.addEventListener('DOMContentLoaded', () => {
            const switcher = document.getElementById('language-switcher');
            if (switcher) {
                switcher.value = currentLang;
                switcher.addEventListener('change', (event) => {
                    currentLang = event.target.value;
                    localStorage.setItem('lang', currentLang);
                    applyTranslations(currentLang);
                    if (window.lastOrders) {
                        renderOrders(window.lastOrders);
                    }
                });
            }
            applyTranslations(currentLang);
        });


        // --- 2. FIREBASE AND ORDER LOGIC (UPDATED) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // IMPORT signOut FUNCTION
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            onSnapshot,
            query,
            orderBy,
            where, // <-- MUST BE IMPORTED
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, userId;
        const appId = window.__app_id || 'default-app-id';
        const CONFIG_CLIENT_FUNCTION = '/.netlify/functions/getClientFirebaseConfig';

        // FIX 1: Point to the Central Public Orders Collection
        const CENTRAL_ORDERS_COLLECTION_PATH = `artifacts/${appId}/public/data/orders`;
        
        // --- NEW FUNCTION: Render User Status ---
        function updateUserStatusDisplay(user) {
            window.currentUser = user;
            const container = document.getElementById('user-status-container');
            const langDict = translations[currentLang];

            if (!container) return;
            
            if (user && !user.isAnonymous) {
                const displayName = user.email || user.displayName || user.uid.slice(0, 8); // Display email, name, or a slice of the UID
                
                container.innerHTML = `
                    <span class="text-gray-500">${langDict.loggedInAs}:</span>
                    <span class="font-bold text-indigo-600 truncate max-w-xs">${displayName}</span>
                    <button id="logout-button" class="px-4 py-1 bg-white border border-red-400 text-red-600 rounded-full hover:bg-red-50 hover:text-red-700 transition duration-200 shadow-md">
                        ${langDict.logout}
                    </button>
                `;

                // Attach logout listener to the new button
                document.getElementById('logout-button').addEventListener('click', handleLogout);

            } else {
                container.innerHTML = `
                    <span class="font-bold text-red-500">${langDict.notLoggedInStatus}</span>
                `;
            }
        }
        // --- NEW FUNCTION: Handle Logout ---
        function handleLogout() {
            signOut(auth).then(() => {
                showMessage('info', 'Sesión cerrada exitosamente. Redirigiendo...'); // Simplified message or use a key
                setTimeout(() => {
                    window.location.href = '/index.html'; // Redirect to home/login page
                }, 1500);
            }).catch((error) => {
                console.error("Logout Error:", error);
                showMessage('error', `Error al cerrar sesión: ${error.message}`);
            });
        }


        function translateStatus(status) {
            const key = 'status' + status.replace(/\s/g, '');
            return translations[currentLang][key] || status;
        }

        const formatPrice = c => `$${(c/100).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',').replace('.', '#').replace(',', '.').replace('#', ',')}`;
        const formatTime = (ts) => {
            if (!ts) return translations[currentLang].notSpecified;
            const date = ts.toDate ? ts.toDate() : new Date(ts);
            return date.toLocaleDateString(`${currentLang}-${currentLang.toUpperCase() === 'EN' ? 'US' : 'CO'}`, { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' }) +
                   ' • ' + date.toLocaleTimeString(`${currentLang}-${currentLang.toUpperCase() === 'EN' ? 'US' : 'CO'}`, { hour: '2-digit', minute: '2-digit' });
        };

        function showMessage(type, textKey) {
            const el = document.getElementById('messageContainer');
            if (!el) return;
            // Handle both literal string and translation key
            const text = translations[currentLang][textKey] || textKey; 
            el.innerHTML = `<div class="p-6 rounded-2xl text-lg font-bold text-center ${type === 'error' ? 'bg-red-100 text-red-800' : (type === 'info' ? 'bg-indigo-100 text-indigo-800' : 'bg-blue-100 text-blue-800')} shadow-lg">${text}</div>`;
        }

        // REMOVED: diagnoseFirestoreIssue

        async function initApp() {
            try {
                const res = await fetch(CONFIG_CLIENT_FUNCTION);
                if (!res.ok) throw new Error("No se pudo cargar la configuración");
                const cfg = await res.json();

                if (!cfg.apiKey || !cfg.projectId) {
                    throw new Error("Firebase config incompleta.");
                }

                const appInstance = initializeApp(cfg);
                auth = getAuth(appInstance);
                db = getFirestore(appInstance);

                onAuthStateChanged(auth, async (user) => {
                    updateUserStatusDisplay(user); // Display status immediately

                    const loadingStateEl = document.getElementById('loadingState');
                    if (loadingStateEl) loadingStateEl.classList.add('hidden');

                    if (user && !user.isAnonymous) {
                        userId = user.uid;
                        console.log("Authenticated. User UID:", userId);
                        
                        // FIX 2: Directly query the central collection and filter by UID
                        fetchUserOrders(userId); 
                    } else {
                        // User is NOT logged in
                        showMessage('error', 'notLoggedIn'); 
                        setTimeout(() => window.location.href = '/index.html', 3000);
                    }
                });
            } catch (e) {
                console.error(e);
                document.getElementById('loadingState')?.classList.add('hidden');
                showMessage('error', 'connectionError'); 
            }
        }

        // FIX 3: Updated fetch function to query the central collection and filter by UID
        function fetchUserOrders(uid) {
            console.log("Querying central orders collection by UID:", uid);
            
            // NOTE: This query requires a Firestore index on the `userId` field.
            const q = query(
                collection(db, CENTRAL_ORDERS_COLLECTION_PATH),
                where("userId", "==", uid), // Filter orders where the userId field matches the logged-in UID
                orderBy('createdAt', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.lastOrders = orders;
                renderOrders(orders);
            }, (error) => {
                console.error("FIRESTORE ERROR:", error);
                showMessage('error', `Error al cargar los pedidos: ${error.message}`);
            });
        }
        
        function renderOrders(orders) {
            const container = document.getElementById('ordersList');
            const ordersContainerEl = document.getElementById('ordersContainer');
            const langDict = translations[currentLang]; 

            if (!container || !ordersContainerEl) return;

            if (!orders || orders.length === 0) {
                // No orders state (uses translations)
                container.innerHTML = `
                    <div class="text-center py-20 bg-white rounded-3xl shadow-2xl">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gray-100 rounded-full flex items-center justify-center">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-700 mb-2">${langDict.noOrdersTitle}</h3>
                        <p class="text-gray-500">${langDict.noOrdersSubtext}</p>
                        <a href="index.html" class="mt-6 inline-block px-8 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-full hover:shadow-xl transform hover:scale-105 transition">
                            ${langDict.goToStore}
                        </a>
                    </div>`;
                ordersContainerEl.classList.remove('hidden');
                return;
            }

            container.innerHTML = orders.map((order, idx) => {
                const statusColors = {
                    'Delivered': 'bg-emerald-100 text-emerald-800 border-emerald-200',
                    'Shipped': 'bg-blue-100 text-blue-800 border-blue-200',
                    'Processing': 'bg-indigo-100 text-indigo-800 border-indigo-200',
                    'Cancelled': 'bg-red-100 text-red-800 border-red-200',
                    'Pending': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                    'Manually Created': 'bg-purple-100 text-purple-800 border-purple-200',
                };
                const statusText = order.status ? translateStatus(order.status) : langDict.statusNoStatus;
                const badge = statusColors[order.status] || 'bg-gray-100 text-gray-800 border-gray-200';
                const paymentBadgeClass = order.isPaid ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white';
                const paymentText = order.isPaid ? langDict.paid : langDict.pending;
                const items = Array.isArray(order.items) ? order.items : [];
                const shippingAddress = order.deliveryAddress || langDict.notSpecified;

                return `
                    <div class="order-card bg-white rounded-3xl shadow-xl overflow-hidden border-t-8 border-indigo-600" style="opacity: 0; animation: slideUp 0.7s ease-out forwards; animation-delay: ${idx * 0.15}s;">
                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 px-8 py-5 border-b border-gray-100">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                <div>
                                    <h3 class="text-2xl font-extrabold text-gray-800">
                                        ${langDict.order} <span class="font-mono text-indigo-600">#${(order.id || '').slice(0, 10)}</span>
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">${formatTime(order.createdAt || order.timestamp)}</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="px-4 py-2 rounded-full text-xs font-bold shadow-lg ${paymentBadgeClass}">
                                        ${paymentText}
                                    </span>
                                    <span class="px-5 py-2 rounded-full text-sm font-bold border-2 ${badge}">
                                        ${statusText}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="p-8">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div>
                                    <p class="text-sm font-semibold text-gray-600">${langDict.totalPaid}</p>
                                    <p class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">
                                        ${formatPrice(order.totalCents || 0)}
                                    </p>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-600">${langDict.shippingAddress}</p>
                                    <p class="text-gray-800 font-medium">${shippingAddress}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-600">${langDict.items}</p>
                                    <p class="text-2xl font-bold text-indigo-600">${items.length}</p>
                                </div>
                            </div>
                            <div class="border-t pt-6">
                                <p class="font-bold text-gray-700 mb-3">${langDict.productsBought}</p>
                                <ul class="space-y-3 custom-scrollbar max-h-48 overflow-y-auto">
                                    ${items.map(item => `
                                        <li class="flex justify-between items-center p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                                            <span class="font-medium text-gray-800">${item.quantity || 1}x ${item.name || 'Item'}</span>
                                            <span class="font-mono text-indigo-600 font-bold">${formatPrice((item.price || 0) * (item.quantity || 1))}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            ordersContainerEl.classList.remove('hidden');
            void ordersContainerEl.offsetWidth; 
            ordersContainerEl.style.opacity = '0';
            ordersContainerEl.style.animation = 'fadeIn 0.9s ease-out forwards';
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

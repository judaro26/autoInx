<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Your autoInx Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div id="app" class="w-full max-w-md p-8 bg-white rounded-xl shadow-2xl border-t-4 border-indigo-500">
        <h1 class="text-3xl font-extrabold text-gray-900 text-center mb-6">Password Reset</h1>
        
        <div id="message-container" class="mb-6">
            <!-- Messages will be displayed here -->
        </div>

        <form id="reset-form" class="space-y-6 hidden" onsubmit="handlePasswordReset(event)">
            <input type="hidden" id="token-input" value="">

            <div>
                <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                <input type="password" id="new-password" placeholder="Enter new password (min. 6 characters)" required minlength="6"
                    class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
            </div>

            <div>
                <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                <input type="password" id="confirm-password" placeholder="Confirm new password" required minlength="6"
                    class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
            </div>

            <button type="submit" id="reset-button" 
                class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md flex justify-center items-center disabled:bg-indigo-400">
                <span id="button-text">Reset Password</span>
                <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </form>
        
        <div id="success-link" class="mt-8 text-center hidden">
            <p class="text-gray-600 mb-4">You can now return to the main application.</p>
            <a href="/" class="text-indigo-600 font-semibold hover:text-indigo-800 transition">Go to Home Page</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', initializePage);

        let resetToken = null;
        const NETLIFY_FUNCTION_URL = '/.netlify/functions/resetPasswordInDb';

        function getUrlParams() {
            const params = {};
            window.location.search.substring(1).split("&").forEach(pair => {
                const [key, value] = pair.split("=");
                params[key] = decodeURIComponent(value);
            });
            return params;
        }

        function showMessage(type, text) {
            const container = document.getElementById('message-container');
            let bgColor, textColor, icon;

            if (type === 'success') {
                bgColor = 'bg-green-100';
                textColor = 'text-green-800';
                icon = '✅';
            } else if (type === 'error') {
                bgColor = 'bg-red-100';
                textColor = 'text-red-800';
                icon = '❌';
            } else {
                bgColor = 'bg-yellow-100';
                textColor = 'text-yellow-800';
                icon = '⚠️';
            }

            container.innerHTML = `
                <div class="p-4 ${bgColor} ${textColor} rounded-lg border border-opacity-50 flex items-center shadow-sm">
                    <span class="text-xl mr-3">${icon}</span>
                    <span>${text}</span>
                </div>
            `;
        }

        function initializePage() {
            const params = getUrlParams();
            const form = document.getElementById('reset-form');
            const tokenInput = document.getElementById('token-input');
            
            const status = params.status;
            const message = params.message || 'Please check your link.';
            resetToken = params.token;

            if (status === 'success' && resetToken) {
                // Token is valid, show the form
                showMessage('success', message);
                tokenInput.value = resetToken;
                form.classList.remove('hidden');
            } else {
                // Token is missing, invalid, or expired
                showMessage('error', message);
            }
        }

        async function handlePasswordReset(event) {
            event.preventDefault();

            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const token = document.getElementById('token-input').value;
            const button = document.getElementById('reset-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');

            if (newPassword !== confirmPassword) {
                showMessage('error', 'New password and confirmation password do not match.');
                return;
            }

            if (newPassword.length < 6) {
                showMessage('error', 'Password must be at least 6 characters long.');
                return;
            }

            // Disable button and show spinner
            button.disabled = true;
            buttonText.textContent = 'Updating...';
            spinner.classList.remove('hidden');

            try {
                const payload = { token, newPassword };
                
                // Exponential backoff retry loop
                const MAX_RETRIES = 3;
                let response = null;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        response = await fetch(NETLIFY_FUNCTION_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            break; // Success
                        } else if (i === MAX_RETRIES - 1) {
                            throw new Error(`Server returned status ${response.status}`);
                        }
                    } catch (fetchError) {
                        if (i === MAX_RETRIES - 1) {
                            throw fetchError;
                        }
                        const delay = Math.pow(2, i) * 1000; // Exponential backoff (1s, 2s, 4s)
                        await new Promise(resolve => setTimeout(resolve, delay));
                        console.log(`Retrying password reset... attempt ${i + 2}`);
                    }
                }
                
                const result = await response.json();

                if (response.ok) {
                    showMessage('success', 'Password reset successful! You can now log in with your new password.');
                    document.getElementById('reset-form').classList.add('hidden');
                    document.getElementById('success-link').classList.remove('hidden');
                } else {
                    showMessage('error', result.error || 'Failed to reset password. Please try again.');
                }
            } catch (error) {
                console.error("Password reset failed:", error);
                showMessage('error', 'A network or server error occurred. Please check your connection and try again.');
            } finally {
                // Re-enable button and hide spinner if still on the form
                if (document.getElementById('reset-form').classList.contains('hidden') === false) {
                    button.disabled = false;
                    buttonText.textContent = 'Reset Password';
                    spinner.classList.add('hidden');
                }
            }
        }
    </script>
</body>
</html>

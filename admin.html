<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>autoInx Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .grid-header { font-weight: bold; background-color: #f3f4f6; padding: 10px; text-align: left; }
        .grid-item { padding: 10px; border-bottom: 1px solid #e5e7eb; word-break: break-all; }
        .admin-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .tab-button { transition: background-color 0.15s, color 0.15s; }
        .preview-iframe-container {
            height: 80vh;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #6366f1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #e5e7eb; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div id="loadingState" class="text-center p-20">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600">Checking authentication and loading configuration...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // CORRECTED: Import static IP list directly from the new client-accessible path
        import { ipWhitelist as staticIpWhitelist } from './js/utilities/ipWhitelist.js'; 

        // --- GLOBAL VARIABLES & STATE ---
        let auth;
        let db;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let globalNextPageToken = null;
        let globalConfig = { maintenanceMode: false };
        const IDLE_TIMEOUT_MS = 15 * 60 * 1000; // 15 minutes
        let idleTimer;

        const state = {
            activeTab: 'catalog',
            catalogs: [],
            items: [],
            searchTerm: '', // for products
            userSearchTerm: '', // NEW: for users
            allUsers: [], // NEW: Store all fetched users for client-side search
            editingItem: null,
            previewMode: false,
            adminCart: {},
        };

        // --- FIRESTORE COLLECTION PATHS & FUNCTION URLS ---
        const CATALOGS_COLLECTION = `artifacts/${appId}/public/data/catalogs`;
        const ITEMS_COLLECTION = `artifacts/${appId}/public/data/items`;
        const CONFIG_FUNCTION = '/.netlify/functions/getAdminConfig';
        const UPDATE_CONFIG_FUNCTION = '/.netlify/functions/updateAdminConfig';
        const LIST_USERS_FUNCTION = '/.netlify/functions/listUsers';
        const LOG_ACTION_FUNCTION = '/.netlify/functions/logAdminAction';
        const MANAGE_USER_FUNCTION = '/.netlify/functions/manageUser';
        const CLEAR_ANON_FUNCTION = '/.netlify/functions/clearAnonymousUsers';
        const ADMIN_CREATE_ORDER_FUNCTION = '/.netlify/functions/adminCreateOrder';

        // --- CORE FIREBASE SETUP ---
        async function loadFirebaseConfig() {
            try {
                // CORRECTION: Must use /.netlify/functions/ to correctly target the deployed function
                const response = await fetch('/.netlify/functions/getClientFirebaseConfig');
                if (!response.ok) throw new Error(`Failed to fetch config (Status: ${response.status})`);
                return await response.json();
            } catch (error) {
                console.error("Failed to load Firebase configuration:", error);
                return {};
            }
        }

        async function setupFirebase() {
            const firebaseConfig = await loadFirebaseConfig();
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                return;
            }
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            checkAuthAndRender();
        }

        // --- IDLE TIMEOUT LOGIC ---
        function autoLogout() {
            if (auth?.currentUser && !auth.currentUser.isAnonymous) {
                console.log("Admin idle timeout — logging out.");
                signOut(auth).then(() => {
                    logAdminAction('ADMIN_AUTO_LOGOUT', { reason: 'Idle Timeout (15m)' });
                    window.location.href = '/?error=idle_timeout';
                });
            }
        }

        function resetTimer() {
            clearTimeout(idleTimer);
            if (auth?.currentUser && !auth.currentUser.isAnonymous) {
                idleTimer = setTimeout(autoLogout, IDLE_TIMEOUT_MS);
            }
        }

        // --- AUTHENTICATION CHECK & REDIRECT ---
        function checkAuthAndRender() {
            onAuthStateChanged(auth, user => {
                if (user && !user.isAnonymous) {
                    user.getIdTokenResult(true).then(idTokenResult => {
                        if (idTokenResult.claims.admin === true) {
                            document.onmousemove = document.onkeydown = document.onclick = resetTimer;
                            resetTimer();
                            setupRealtimeListeners();
                            renderAdminPage(user.email || 'Admin');
                        } else {
                            signOut(auth);
                            window.location.href = '/?error=unauthorized';
                        }
                    }).catch(err => {
                        console.error("Token error:", err);
                        signOut(auth);
                        window.location.href = '/?error=auth_failed';
                    });
                } else {
                    window.location.href = '/';
                }
            });
        }

        // --- FIRESTORE REALTIME LISTENERS ---
        function setupRealtimeListeners() {
            if (!db) return;

            onSnapshot(collection(db, CATALOGS_COLLECTION), snap => {
                state.catalogs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (state.activeTab === 'catalog' && !state.previewMode) renderProductListSection();
            }, err => {
                console.error("Error listening to catalogs:", err);
                showMessage('error', 'Failed to fetch catalogs.');
            });

            onSnapshot(collection(db, ITEMS_COLLECTION), snap => {
                state.items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (state.activeTab === 'catalog' && !state.previewMode) renderProductListSection();
                if (state.activeTab === 'orders' && !state.previewMode) updateAdminCartDisplay();
            }, err => {
                console.error("Error listening to items:", err);
                showMessage('error', 'Failed to fetch items.');
            });
        }

        // --- HELPER FUNCTIONS ---
        function formatPriceDisplay(cents) {
            return `$${(cents / 100).toFixed(2)}`;
        }

        function formatTime(ts) {
            if (!ts) return 'N/A';
            const date = ts.toDate ? ts.toDate() : new Date(ts);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function showMessage(type, text, duration = 5000) {
            const id = state.activeTab === 'config' ? 'configMessage' : state.activeTab === 'orders' ? 'ordersMessage' : 'catalogMessage';
            const el = document.getElementById(id);
            if (!el) return;
            el.className = `mt-4 text-center text-sm font-medium ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
            el.textContent = text;
            setTimeout(() => el.textContent = '', duration);
        }

        async function logAdminAction(actionType, details, objectId = null) {
            try {
                await fetch(LOG_ACTION_FUNCTION, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        actionType,
                        details,
                        performedByEmail: auth.currentUser?.email || 'Unknown',
                        objectId
                    })
                });
            } catch (e) { console.error("Log failed:", e); }
        }

        function generateUniqueSku() {
            const t = Date.now().toString(36).toUpperCase();
            const r = Math.random().toString(36).substring(2, 4).toUpperCase();
            return `AX-${t}${r}`;
        }

        function getFilteredItems() {
            if (!state.searchTerm) return state.items;
            const term = state.searchTerm.toLowerCase();
            return state.items.filter(item => {
                const catName = state.catalogs.find(c => c.id === item.catalogId)?.name || 'Uncategorized';
                return item.name.toLowerCase().includes(term) ||
                       item.description.toLowerCase().includes(term) ||
                       catName.toLowerCase().includes(term) ||
                       (item.sku && item.sku.toLowerCase().includes(term));
            });
        }

        // --- NEW USER LIST UTILITIES ---
        function getFilteredAuthUsers() {
            if (!state.userSearchTerm) return state.allUsers;
            const term = state.userSearchTerm.toLowerCase();
            return state.allUsers.filter(user => {
                // Handles anonymous users where email might be null
                const userEmail = user.email || (user.uid.slice(0, 8) + '... (Anonymous)'); 
                
                const uidMatch = user.uid.toLowerCase().includes(term);
                const emailMatch = userEmail.toLowerCase().includes(term);
                const nameMatch = user.displayName && user.displayName.toLowerCase().includes(term);
                return uidMatch || emailMatch || nameMatch;
            });
        }

        function handleUserSearchInput(e) {
            state.userSearchTerm = e.target.value;
            renderUserList(); // Call the rendering function immediately
            resetTimer();
        }

        // --- UI ACTIONS ---
        function togglePreviewMode(enable) {
            state.previewMode = enable;
            renderAdminPage(auth.currentUser?.email || 'Admin');
            resetTimer();
        }

        function switchAdminTab(tab) {
            state.activeTab = tab;
            state.editingItem = null;
            state.previewMode = false;
            renderAdminPage(auth.currentUser?.email || 'Admin');
            resetTimer();

            if (tab === 'config') {
                window.module.fetchAdminConfig();
                window.module.displayStaticIps();
            } else if (tab === 'users') {
                // Clear old data but keep headers before fetching new page. 
                // We keep allUsers for filtering, so don't clear it here.
                const grid = document.getElementById('usersGrid');
                if (grid) Array.from(grid.children).slice(7).forEach(el => el.remove()); 
                window.module.fetchUsers(null);
            } else if (tab === 'orders') {
                window.module.updateAdminCartDisplay();
            }
        }

        function handleSearchInput(e) {
            state.searchTerm = e.target.value;
            renderProductListSection();
            resetTimer();
        }

        function showEditForm(item) {
            state.editingItem = item;
            renderAdminPage(auth.currentUser?.email || 'Admin');
            resetTimer();
        }

        function cancelEdit() {
            state.editingItem = null;
            renderAdminPage(auth.currentUser?.email || 'Admin');
            resetTimer();
        }

        // --- CATALOG & PRODUCT CRUD ---
        async function handleAddCatalog(event) {
            event.preventDefault();
            resetTimer();
            const name = event.target.catalogName.value.trim();
            if (!name) return;
            try {
                const docRef = await addDoc(collection(db, CATALOGS_COLLECTION), {
                    name,
                    createdAt: serverTimestamp(),
                    slug: name.toLowerCase().replace(/\s/g, '-')
                });
                event.target.catalogName.value = '';
                showMessage('success', `Catalog "${name}" created successfully.`, 3000);
                await logAdminAction('CATALOG_CREATED', { name }, docRef.id);
            } catch (error) {
                console.error("Error adding catalog:", error);
                showMessage('error', 'Failed to add catalog.');
            }
        }

        async function handleDeleteCatalog(catalogId, catalogName) {
            if (!confirm(`Delete catalog "${catalogName}"? All items will become 'Uncategorized'.`)) return;
            resetTimer();
            try {
                const itemsToUpdate = state.items.filter(i => i.catalogId === catalogId);
                await Promise.all(itemsToUpdate.map(item =>
                    updateDoc(doc(db, ITEMS_COLLECTION, item.id), { catalogId: 'uncategorized' })
                ));
                await deleteDoc(doc(db, CATALOGS_COLLECTION, catalogId));
                showMessage('success', `Catalog "${catalogName}" deleted.`);
                await logAdminAction('CATALOG_DELETED', { name: catalogName }, catalogId);
            } catch (error) {
                console.error(error);
                showMessage('error', 'Failed to delete catalog.');
            }
        }

        async function handleAddProduct(event) {
            event.preventDefault();
            resetTimer();
            const form = event.target;
            const name = form.itemName.value.trim();
            const description = form.itemDescription.value.trim();
            const price = parseFloat(form.itemPrice.value.trim()) * 100;
            const catalogId = form.catalogId.value;
            const imageUrl = form.itemImageUrl.value.trim() || 'https://placehold.co/400x300/a3a3a3/ffffff?text=No+Image';
            const sku = generateUniqueSku();

            if (!name || !description || isNaN(price) || price <= 0 || !catalogId) {
                showMessage('error', 'Please fill all required fields correctly.');
                return;
            }

            try {
                const docRef = await addDoc(collection(db, ITEMS_COLLECTION), {
                    name, description, price, catalogId, imageUrl, sku,
                    createdAt: serverTimestamp()
                });
                form.reset();
                showMessage('success', `Product "${name}" added.`);
                await logAdminAction('PRODUCT_CREATED', { name, catalogId }, docRef.id);
            } catch (error) {
                console.error(error);
                showMessage('error', 'Failed to add product.');
            }
        }

        async function handleDeleteProduct(itemId, itemName) {
            if (!confirm(`Delete product "${itemName}"?`)) return;
            resetTimer();
            try {
                await deleteDoc(doc(db, ITEMS_COLLECTION, itemId));
                showMessage('success', `Product "${itemName}" deleted.`);
                await logAdminAction('PRODUCT_DELETED', { name: itemName }, itemId);
            } catch (error) {
                console.error(error);
                showMessage('error', 'Failed to delete product.');
            }
        }

        async function handleEditProduct(e) {
            e.preventDefault();
            resetTimer();
            const f = e.target;
            const itemId = f.itemId.value;
            const data = {
                name: f.itemName.value.trim(),
                description: f.itemDescription.value.trim(),
                price: parseFloat(f.itemPrice.value) * 100,
                catalogId: f.catalogId.value,
                imageUrl: f.itemImageUrl.value.trim() || 'https://placehold.co/400x300/a3a3a3/ffffff?text=No+Image'
            };

            try {
                await updateDoc(doc(db, ITEMS_COLLECTION, itemId), data);
                await logAdminAction('PRODUCT_UPDATED', data, itemId);
                state.editingItem = null;
                showMessage('success', `Product "${data.name}" updated.`);
                renderAdminPage(auth.currentUser?.email || 'Admin');
            } catch (err) {
                console.error(err);
                showMessage('error', 'Failed to update product.');
            }
        }

        // --- USER MANAGEMENT ---
        async function handleUserAction(action, uid, data = {}, successMsg) {
            resetTimer();
            if (!confirm(`Are you sure you want to perform action: ${action} on user ${uid.slice(0, 8)}...?`)) return;

            try {
                const idToken = await auth.currentUser.getIdToken();
                const payload = { action, uid, data };
                const res = await fetch(MANAGE_USER_FUNCTION, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errorDetails = await res.json();
                    throw new Error(errorDetails.details || errorDetails.error || res.statusText);
                }

                await logAdminAction('USER_MANAGEMENT', { action, uid, details: data });
                showMessage('success', successMsg, 5000);

                // Re-fetch users to update the list
                window.module.fetchUsers(null); 
            } catch (error) {
                console.error(`User action (${action}) failed:`, error);
                showMessage('error', `Action failed: ${error.message}`);
            }
        }

        function promptForPasswordReset(uid) {
            const newPassword = prompt(`Enter new password for user ${uid.slice(0, 8)}... (min 6 characters):`);
            if (newPassword && newPassword.length >= 6) {
                handleUserAction('resetPassword', uid, { newPassword }, 'Password reset initiated.');
            } else if (newPassword !== null) {
                showMessage('error', 'Password must be at least 6 characters long.');
            }
        }

        function deleteUser(uid, email) {
            if (!confirm(`PERMANENTLY DELETE user ${email} (${uid.slice(0, 8)}...)? THIS CANNOT BE UNDONE.`)) return;
            handleUserAction('delete', uid, {}, `User ${email} deleted.`);
        }

        function disableUser(uid, email, currentlyDisabled) {
            const action = 'update';
            const data = { disabled: !currentlyDisabled };
            const successMsg = `User ${email} successfully ${currentlyDisabled ? 'enabled' : 'disabled'}.`;
            handleUserAction(action, uid, data, successMsg);
        }

        // --- ANONYMOUS USER CLEANUP ---
        async function handleClearAnonymousUsers(pageToken = null, totalDeleted = 0) {
            resetTimer();
            if (!pageToken && !confirm(`Are you sure you want to proceed with clearing ALL anonymous user records? This is irreversible.`)) return;

            const nextBtnUsers = document.getElementById('clearAnonButton'); // User tab button
            const nextBtnConfig = document.getElementById('clearAnonButtonConfig'); // Config tab button
            const buttons = [nextBtnUsers, nextBtnConfig].filter(Boolean);

            buttons.forEach(btn => {
                btn.disabled = true;
                btn.textContent = pageToken ? `Deleting Batch... (Total: ${totalDeleted})` : 'Searching for Anonymous Users...';
            });
            
            try {
                const idToken = await auth.currentUser.getIdToken();
                const payload = { nextPageToken: pageToken };
                const res = await fetch(CLEAR_ANON_FUNCTION, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                const newTotalDeleted = totalDeleted + (data.deletedCount || 0);

                if (data.nextPageToken) {
                    await handleClearAnonymousUsers(data.nextPageToken, newTotalDeleted);
                } else if (res.ok) {
                    showMessage('success', `Successfully deleted ${newTotalDeleted} anonymous users. Cleanup complete.`, 10000);
                    await logAdminAction('USER_CLEANUP', { type: 'anonymous', deletedCount: newTotalDeleted });
                    // Force a reload of the users list after cleanup
                    if (state.activeTab === 'users') window.module.fetchUsers(null); 
                } else {
                    throw new Error(data.details || data.error || res.statusText);
                }
            } catch (error) {
                console.error('Anonymous user cleanup failed:', error);
                showMessage('error', `Cleanup failed: ${error.message}`);
            } finally {
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.textContent = 'Clear All Anonymous Users';
                });
            }
        }

        // --- ADMIN ORDER CREATION ---
        function getTotalAdminCartPrice() {
            return Object.values(state.adminCart).reduce((total, entry) => total + (entry.item.price || 0) * entry.quantity, 0);
        }

        function renderAdminCart() {
            const entries = Object.values(state.adminCart);
            if (entries.length === 0) return '<p class="text-gray-500 italic">No items added to this order yet.</p>';
            return entries.map(entry => `
                <div class="flex justify-between items-center border-b pb-1">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">${entry.item.name}</p>
                        <p class="text-xs text-gray-500">${formatPriceDisplay(entry.item.price)} × ${entry.quantity}</p>
                    </div>
                    <span class="text-sm font-bold ml-4 text-pink-600">${formatPriceDisplay(entry.item.price * entry.quantity)}</span>
                    <button type="button" onclick="window.module.removeAdminCartItem('${entry.item.id}')" class="text-red-500 hover:text-red-700 ml-2 text-sm">×</button>
                </div>
            `).join('');
        }

        function renderItemSelectorOptions() {
            return state.items.map(item => `<option value="${item.id}">${item.name} (${formatPriceDisplay(item.price)})</option>`).join('');
        }

        function updateAdminCartDisplay() {
            const cartEl = document.getElementById('adminCartDisplay');
            const totalEl = document.getElementById('adminCartTotal');
            const selectorEl = document.getElementById('itemSelector');
            const submitBtn = document.getElementById('submitOrderButton');

            if (cartEl) cartEl.innerHTML = renderAdminCart();
            if (totalEl) totalEl.textContent = formatPriceDisplay(getTotalAdminCartPrice());
            if (selectorEl) selectorEl.innerHTML = `<option value="">-- Select Product --</option>${renderItemSelectorOptions()}`;
            if (submitBtn) submitBtn.disabled = Object.keys(state.adminCart).length === 0;

            renderAdminOrderSection();
            resetTimer();
        }

        function addAdminCartItem() {
            const selector = document.getElementById('itemSelector');
            const quantityInput = document.getElementById('itemQuantity');
            const itemId = selector.value;
            const quantity = parseInt(quantityInput.value);

            if (!itemId || isNaN(quantity) || quantity <= 0) {
                showMessage('error', 'Please select an item and enter a valid quantity.', 3000);
                return;
            }

            const item = state.items.find(i => i.id === itemId);
            if (!item) return;

            state.adminCart = { ...state.adminCart, [itemId]: { item, quantity } };
            showMessage('success', `Added ${quantity}× ${item.name} to the order.`, 2000);
            quantityInput.value = 1;
            selector.value = '';
            updateAdminCartDisplay();
        }

        function removeAdminCartItem(itemId) {
            const item = state.adminCart[itemId]?.item;
            const newCart = { ...state.adminCart };
            delete newCart[itemId];
            state.adminCart = newCart;
            showMessage('info', `${item?.name || 'Item'} removed from order.`, 2000);
            updateAdminCartDisplay();
        }

        async function handleAdminOrderSubmit(event) {
            event.preventDefault();
            resetTimer();

            if (Object.keys(state.adminCart).length === 0) {
                showMessage('error', 'The order cart is empty!', 3000);
                return;
            }

            const buyerName = document.getElementById('buyerName').value.trim();
            const buyerEmail = document.getElementById('buyerEmail').value.trim();
            const buyerPhone = document.getElementById('buyerPhone').value.trim();
            const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
            const notes = document.getElementById('orderNotes').value.trim();
            const totalCents = getTotalAdminCartPrice();
            const submitBtn = document.getElementById('submitOrderButton');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            const orderDetails = {
                buyerName, buyerEmail, buyerPhone, deliveryAddress, notes,
                items: Object.values(state.adminCart).map(entry => ({
                    id: entry.item.id,
                    name: entry.item.name,
                    price: entry.item.price,
                    quantity: entry.quantity,
                    catalog: state.catalogs.find(c => c.id === entry.item.catalogId)?.name || 'N/A'
                })),
                totalCents
            };

            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch(ADMIN_CREATE_ORDER_FUNCTION, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderDetails)
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.details || result.error || response.statusText);

                showMessage('success', `Order ${result.orderId?.slice(0, 8)}... created and email sent.`, 8000);
                await logAdminAction('ORDER_CREATED', { orderId: result.orderId, buyer: buyerEmail });

                document.getElementById('createOrderForm').reset();
                state.adminCart = {};
                updateAdminCartDisplay();
            } catch (error) {
                console.error("Admin Order creation failed:", error);
                showMessage('error', `Order failed: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'SUBMIT ORDER & SEND EMAIL';
            }
        }

        function renderAdminOrderSection() {
            const itemSelector = document.getElementById('itemSelector');
            if (itemSelector) itemSelector.innerHTML = `<option value="">-- Select Product --</option>${renderItemSelectorOptions()}`;
        }


        // ----------------------------------------------------------------------
        // --- IMPLEMENTED ADMIN FUNCTIONS ---
        // ----------------------------------------------------------------------

        /**
         * Fetches the dynamic admin configuration from Firestore via Netlify Function.
         */
        async function fetchAdminConfig() {
            try {
                const response = await fetch(CONFIG_FUNCTION);
                if (!response.ok) throw new Error('Failed to fetch admin config.');
                
                const config = await response.json();
                window.module.globalConfig = config;
                
                // Update form values with fetched config
                const maintenanceToggle = document.getElementById('maintenanceToggle');
                if (maintenanceToggle) maintenanceToggle.checked = config.maintenanceMode;

                const ipListEl = document.getElementById('dynamicIpList');
                if (ipListEl) {
                    ipListEl.value = Array.isArray(config.ipWhitelist) ? config.ipWhitelist.join('\n') : '';
                }

                const lastUpdatedEl = document.getElementById('configLastUpdated');
                if (lastUpdatedEl && config.lastUpdated) {
                    const date = config.lastUpdated.toDate ? config.lastUpdated.toDate() : new Date(config.lastUpdated._seconds * 1000);
                    lastUpdatedEl.textContent = `Last Updated: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                }

            } catch (error) {
                console.error('Error fetching admin config:', error);
                showMessage('error', 'Failed to load dynamic configuration.');
            }
        }

        /**
         * Displays the static IP whitelist imported directly from the client-side file.
         */
        function displayStaticIps() {
            const staticIpEl = document.getElementById('staticIpListDisplay');
            if (staticIpEl) {
                staticIpEl.textContent = Array.isArray(staticIpWhitelist) && staticIpWhitelist.length > 0
                    ? staticIpWhitelist.join('\n')
                    : 'No static IPs configured.';
            }
        }
        
        /**
         * Handles saving the configuration changes back to Firestore.
         */
        async function handleUpdateConfig(event) {
            event.preventDefault();
            resetTimer();
            
            const maintenanceMode = document.getElementById('maintenanceToggle').checked;
            const ipListText = document.getElementById('dynamicIpList').value.trim();
            
            // Parse IP list: split by newline, filter empty, trim whitespace
            const ipWhitelist = ipListText.split('\n').map(ip => ip.trim()).filter(ip => ip.length > 0);

            const updates = {
                maintenanceMode,
                ipWhitelist
            };

            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch(UPDATE_CONFIG_FUNCTION, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify(updates)
                });

                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(errorDetails.details || errorDetails.error || response.statusText);
                }

                showMessage('success', 'Configuration updated successfully.', 5000);
                await logAdminAction('CONFIG_UPDATED', updates);
                fetchAdminConfig(); // Reload config to update last updated time
                
            } catch (error) {
                console.error('Error updating config:', error);
                showMessage('error', `Failed to update configuration: ${error.message}`);
            }
        }

        /**
         * Fetches a batch of users from Firebase Auth via Netlify function for pagination.
         * Stores all fetched users in state.allUsers for client-side search/filtering.
         */
        async function fetchUsers(pageToken = null) {
            resetTimer();
            const loadMoreBtn = document.getElementById('loadMoreUsersButton');
            const msgEl = document.getElementById('usersMessage');
            
            if (msgEl) msgEl.textContent = pageToken ? 'Loading next batch...' : 'Loading users...';
            if (loadMoreBtn) loadMoreBtn.disabled = true;

            // Clear current list on initial load or reset (e.g., after an action)
            if (!pageToken) {
                state.allUsers = []; 
                window.module.globalNextPageToken = null;
            }

            try {
                const idToken = await auth.currentUser.getIdToken();
                const params = new URLSearchParams();
                if (pageToken) params.append('nextPageToken', pageToken);
                
                const res = await fetch(`${LIST_USERS_FUNCTION}?${params.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                if (!res.ok) {
                    const errorDetails = await res.json();
                    throw new Error(errorDetails.details || errorDetails.error || res.statusText);
                }

                const data = await res.json();
                window.module.globalNextPageToken = data.nextPageToken;
                
                // Store fetched users to the state array
                state.allUsers = state.allUsers.concat(data.users); 

                renderUserList(); // Render the full, filtered list

            } catch (error) {
                console.error('Error fetching users:', error);
                showMessage('error', `Failed to fetch users: ${error.message}`);
            } finally {
                if (msgEl) msgEl.textContent = '';
                if (loadMoreBtn) loadMoreBtn.disabled = false;
                renderUserControls(); 
            }
        }

        /**
         * Renders a list of user records into the users grid, applying search filter.
         */
        function renderUserList() {
            const grid = document.getElementById('usersGrid');
            if (!grid) return;

            const users = getFilteredAuthUsers();
            
            // Clear existing rows but keep headers (which are the first 7 elements in the grid)
            Array.from(grid.children).slice(7).forEach(el => el.remove());

            const userRows = users.map(user => {
                const disabledClass = user.disabled ? 'bg-red-50 text-red-700' : '';
                const emailVerifiedIcon = user.emailVerified ? '✅' : '❌';
                const disabledButtonText = user.disabled ? 'Enable' : 'Disable';
                const disabledButtonColor = user.disabled ? 'text-green-600 hover:text-green-800' : 'text-yellow-600 hover:text-yellow-800';

                // Handle cases where email is null for anonymous users
                const userEmail = user.email || (user.uid.slice(0, 8) + '... (Anonymous)');

                return `
                    <div class="grid-item text-xs font-mono truncate ${disabledClass}">${user.uid.slice(0, 8)}...</div>
                    <div class="grid-item text-sm font-semibold truncate ${disabledClass}">${userEmail} ${emailVerifiedIcon}</div>
                    <div class="grid-item text-xs text-gray-500 ${disabledClass}">${user.displayName}</div>
                    <div class="grid-item text-xs text-gray-500 ${disabledClass}">${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}</div>
                    <div class="grid-item text-xs text-gray-500 ${disabledClass}">${user.lastSignInTime ? new Date(user.lastSignInTime).toLocaleDateString() : 'N/A'}</div>
                    <div class="grid-item text-xs font-bold ${disabledClass}">${user.disabled ? 'DISABLED' : 'Active'}</div>
                    <div class="grid-item space-x-2 ${disabledClass}">
                        <button onclick="window.module.promptForPasswordReset('${user.uid}')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">Reset Pwd</button>
                        <button onclick="window.module.disableUser('${user.uid}', '${userEmail}', ${user.disabled})" class="${disabledButtonColor} text-sm font-semibold">${disabledButtonText}</button>
                        <button onclick="window.module.deleteUser('${user.uid}', '${userEmail}')" class="text-red-600 hover:text-red-800 text-sm font-semibold">Delete</button>
                    </div>
                `;
            }).join('');

            grid.insertAdjacentHTML('beforeend', userRows);
            renderUserControls();
        }

        /**
         * Updates the state of the Load More Users button and displays user count.
         */
        function renderUserControls() {
            const loadMoreBtn = document.getElementById('loadMoreUsersButton');
            const userCountEl = document.getElementById('userCount');
            const filteredCount = getFilteredAuthUsers().length;
            const totalCount = state.allUsers.length;
            
            if (loadMoreBtn) {
                // Only show "Load More" if there's no search term and a next page token exists
                if (window.module.globalNextPageToken && !state.userSearchTerm) {
                    loadMoreBtn.classList.remove('hidden');
                    loadMoreBtn.textContent = 'Load More Users (100)';
                    loadMoreBtn.disabled = false;
                } else {
                    loadMoreBtn.classList.add('hidden');
                }
            }

            if (userCountEl) {
                if (state.userSearchTerm) {
                    userCountEl.textContent = `Found ${filteredCount} matching users (from ${totalCount} loaded).`;
                } else {
                    userCountEl.textContent = `Showing ${filteredCount} users total.`;
                }
            }
        }


        // ----------------------------------------------------------------------
        // --- RENDERING FUNCTIONS (MODIFIED) ---
        // ----------------------------------------------------------------------

        function renderEditProductForm() {
            if (!state.editingItem) return '';
            const item = state.editingItem;
            const options = state.catalogs.map(c => `<option value="${c.id}" ${c.id === item.catalogId ? 'selected' : ''}>${c.name}</option>`).join('');
            const priceDollars = (item.price / 100).toFixed(2);
            const img = item.imageUrl.includes('placehold.co') ? '' : item.imageUrl;

            return `
                <div class="mb-10 p-6 border rounded-xl shadow-2xl bg-yellow-100 border-t-4 border-yellow-500">
                    <h3 class="text-xl font-bold mb-4 text-yellow-700">Edit: ${item.name}</h3>
                    <div class="mb-4 p-3 bg-yellow-200 border border-yellow-300 rounded-lg">
                        <label class="block text-sm font-bold text-yellow-800">SKU:</label>
                        <input type="text" value="${item.sku || 'N/A'}" readonly class="w-full p-2 bg-yellow-50 font-mono text-sm border-yellow-400 rounded-md cursor-not-allowed">
                    </div>
                    <form onsubmit="window.module.handleEditProduct(event)" class="space-y-4">
                        <input type="hidden" name="itemId" value="${item.id}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input name="itemName" value="${item.name}" required class="p-2 border rounded-lg">
                            <select name="catalogId" required class="p-2 border rounded-lg"><option value="">-- Category --</option>${options}</select>
                        </div>
                        <textarea name="itemDescription" rows="2" required class="w-full p-2 border rounded-lg">${item.description}</textarea>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="number" step="0.01" name="itemPrice" value="${priceDollars}" required class="p-2 border rounded-lg">
                            <input type="url" name="itemImageUrl" value="${img}" class="p-2 border rounded-lg">
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="flex-grow bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700">Save Changes</button>
                            <button type="button" onclick="window.module.cancelEdit()" class="flex-grow bg-gray-300 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                        </div>
                    </form>
                </div>`;
        }

        function renderProductListSection() {
            const el = document.getElementById('productListContainer');
            if (!el) return;
            const items = getFilteredItems();

            el.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-indigo-700">Products (${items.length} / ${state.items.length} total)</h3>
                <div class="overflow-x-auto">
                    <div class="grid gap-x-4 min-w-[850px]" style="grid-template-columns: 1fr 2fr 1fr 1fr 1.5fr 1.5fr 1fr;">
                        <div class="grid-header">SKU</div>
                        <div class="grid-header">Name & Description</div>
                        <div class="grid-header">Price</div>
                        <div class="grid-header">Category</div>
                        <div class="grid-header">Image URL</div>
                        <div class="grid-header">Added At</div>
                        <div class="grid-header">Actions</div>
                        ${items.map(item => {
                            const cat = state.catalogs.find(c => c.id === item.catalogId)?.name || 'Uncategorized';
                            const created = item.createdAt ? formatTime(item.createdAt) : 'N/A';
                            return `
                                <div class="grid-item text-xs font-mono text-gray-700">${item.sku || 'N/A'}</div>
                                <div class="grid-item"><p class="font-semibold">${item.name}</p><p class="text-xs text-gray-500">${item.description.substring(0,50)}${item.description.length>50?'...':''}</p></div>
                                <div class="grid-item font-bold text-green-700">${formatPriceDisplay(item.price)}</div>
                                <div class="grid-item">${cat}</div>
                                <div class="grid-item text-xs text-blue-500 truncate"><a href="${item.imageUrl}" target="_blank" class="hover:underline">${item.imageUrl.substring(0,30)}...</a></div>
                                <div class="grid-item text-xs text-gray-500">${created}</div>
                                <div class="grid-item">
                                    <button onclick="window.module.showEditForm(${JSON.stringify(item).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800 text-sm font-semibold mr-3">Edit</button>
                                    <button onclick="window.module.handleDeleteProduct('${item.id}', '${item.name}')" class="text-red-600 hover:text-red-800 text-sm font-semibold">Delete</button>
                                </div>`;
                        }).join('')}
                    </div>
                    ${items.length === 0 ? '<p class="text-center p-4 text-gray-500">No products found.</p>' : ''}
                </div>`;
        }

        function renderPreviewSite() {
            return `
                <section class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500">
                    <h2 class="text-2xl font-bold mb-4 text-green-700">Live Site Preview</h2>
                    <div class="preview-iframe-container border border-gray-300 rounded-lg overflow-hidden">
                        <iframe src="/" class="w-full h-full" frameborder="0" sandbox="allow-forms allow-popups allow-scripts allow-same-origin"></iframe>
                    </div>
                    <p class="text-sm text-gray-500 mt-4">Embedded view of your live site. Functionality may be limited as scripts are blocked to prevent interference with the Admin session.</p>
                </section>`;
        }

        function renderAdminTabs() {
            const catOpts = state.catalogs.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            if (state.activeTab === 'catalog') {
                return `
                    <section class="space-y-10">
                        <div id="catalogMessage"></div>
                        
                        ${renderEditProductForm()}

                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <input type="text" oninput="window.module.handleSearchInput(event)" placeholder="Search products, SKUs, or category..." class="p-2 border rounded-lg w-full max-w-md">
                            </div>
                            <div id="productListContainer">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
                                <h3 class="text-xl font-bold mb-4 text-indigo-700">Manage Catalogs</h3>
                                <form onsubmit="window.module.handleAddCatalog(event)" class="space-y-4">
                                    <input type="text" name="catalogName" placeholder="New Catalog Name (e.g., 'Electronics')" required class="w-full p-2 border rounded-lg">
                                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Add New Catalog</button>
                                </form>
                                <div class="mt-4 space-y-2 max-h-40 custom-scrollbar overflow-y-auto">
                                    ${state.catalogs.map(c => `
                                        <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded-lg">
                                            <span class="font-medium">${c.name}</span>
                                            <button onclick="window.module.handleDeleteCatalog('${c.id}', '${c.name}')" class="text-red-500 hover:text-red-700 text-xs font-semibold">Delete</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500">
                                <h3 class="text-xl font-bold mb-4 text-green-700">Add New Product</h3>
                                <form onsubmit="window.module.handleAddProduct(event)" class="space-y-4">
                                    <input type="text" name="itemName" placeholder="Product Name" required class="w-full p-2 border rounded-lg">
                                    <textarea name="itemDescription" rows="2" placeholder="Product Description" required class="w-full p-2 border rounded-lg"></textarea>
                                    <div class="grid grid-cols-2 gap-4">
                                        <input type="number" step="0.01" name="itemPrice" placeholder="Price (e.g., 19.99)" required min="0.01" class="w-full p-2 border rounded-lg">
                                        <select name="catalogId" required class="w-full p-2 border rounded-lg">
                                            <option value="">-- Select Category --</option>
                                            ${catOpts}
                                        </select>
                                    </div>
                                    <input type="url" name="itemImageUrl" placeholder="Image URL (Optional)" class="w-full p-2 border rounded-lg">
                                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Add Product</button>
                                </form>
                            </div>
                        </div>

                        
                    </section>
                `;
            } else if (state.activeTab === 'config') {
                return `
                    <section class="space-y-8">
                        <div id="configMessage"></div>
                        <h2 class="text-2xl font-bold text-indigo-700">Global System Configuration</h2>

                        <div class="p-4 bg-red-100 rounded-xl shadow-inner border border-red-300">
                            <p class="text-sm font-semibold text-red-700 mb-3">User Management Utility (Global Action):</p>
                            <button id="clearAnonButtonConfig" onclick="window.module.handleClearAnonymousUsers()" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700 transition duration-150 shadow-md">
                                Clear All Anonymous Users
                            </button>
                            <p class="text-xs text-red-500 mt-2">Warning: This action is irreversible and should only be performed after careful consideration.</p>
                        </div>
                        <form id="configForm" onsubmit="window.module.handleUpdateConfig(event)" class="bg-white p-6 rounded-xl shadow-lg space-y-6">
                            
                            <div class="flex items-center justify-between p-4 border rounded-lg bg-red-50 border-red-200">
                                <label for="maintenanceToggle" class="text-lg font-medium text-gray-700">Maintenance Mode</label>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="maintenanceToggle" id="maintenanceToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                                    <label for="maintenanceToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-red-300 cursor-pointer"></label>
                                </div>
                                <p class="text-sm text-red-600">Disables store functionality for public users.</p>
                                <style>
                                    #maintenanceToggle:checked { border-color: #10b981; }
                                    #maintenanceToggle:checked + .toggle-label { background-color: #10b981; }
                                    #maintenanceToggle:checked + .toggle-label { transform: translateX(20px); }
                                </style>
                            </div>

                            <div>
                                <h3 class="text-xl font-bold mb-2 text-gray-700">Dynamic Admin IP Whitelist (Stored in Firestore)</h3>
                                <p class="text-sm text-gray-500 mb-4">Users from these IPs can access the Admin Login page even if Maintenance Mode is active. One IP address per line.</p>
                                <textarea id="dynamicIpList" rows="4" placeholder="123.45.67.89&#10;98.76.54.32" class="w-full p-3 border rounded-lg font-mono text-sm"></textarea>
                                <p id="configLastUpdated" class="text-xs text-gray-500 mt-2"></p>
                            </div>

                            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <h3 class="text-xl font-bold mb-2 text-gray-700">Static Client IP Whitelist (Codebase)</h3>
                                <p class="text-sm text-gray-500 mb-2">This is the hardcoded IP list used by the client-side code (index.html) to check for access before loading Firebase config. Requires redeployment to change.</p>
                                <pre id="staticIpListDisplay" class="bg-white p-3 rounded-lg border font-mono text-sm text-gray-800"></pre>
                            </div>
                            
                            <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">Save Configuration</button>
                        </form>
                    </section>
                `;
            } else if (state.activeTab === 'users') {
                return `
                    <section class="space-y-8">
                        <h2 class="text-2xl font-bold text-indigo-700">Registered Users Management</h2>
                        <div id="usersMessage"></div>

                        <div class="flex justify-between items-center mb-4">
                            <input type="text" oninput="window.module.handleUserSearchInput(event)" 
                                placeholder="Search users by email, ID, or name..." 
                                class="p-2 border rounded-lg w-full max-w-md">
                            
                            <button id="clearAnonButton" onclick="window.module.handleClearAnonymousUsers()" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700 transition duration-150 shadow-md ml-4">
                                Clear All Anonymous Users
                            </button>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                            <div id="usersGrid" class="grid gap-x-4 min-w-[1200px]" style="grid-template-columns: 0.5fr 1.5fr 1fr 1fr 1fr 0.5fr 2fr;">
                                <div class="grid-header">UID</div>
                                <div class="grid-header">Email</div>
                                <div class="grid-header">Display Name</div>
                                <div class="grid-header">Created</div>
                                <div class="grid-header">Last Sign-In</div>
                                <div class="grid-header">Status</div>
                                <div class="grid-header">Actions</div>
                                </div>
                            <div class="text-center mt-6">
                                <button id="loadMoreUsersButton" onclick="window.module.fetchUsers(window.module.globalNextPageToken)" class="px-4 py-2 rounded-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150 shadow-md hidden">
                                    Load More Users (100)
                                </button>
                                <p id="userCount" class="text-sm text-gray-500 mt-2">Showing 0 users.</p>
                            </div>
                        </div>
                    </section>
                `;
            } else if (state.activeTab === 'orders') {
                return `
                    <section class="space-y-8">
                        <h2 class="text-2xl font-bold text-indigo-700">Manual Order Creation</h2>
                        <div id="ordersMessage"></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500">
                                <h3 class="text-xl font-bold mb-4 text-purple-700">Enter Customer Details</h3>
                                <form id="createOrderForm" onsubmit="window.module.handleAdminOrderSubmit(event)" class="space-y-4">
                                    <input type="text" id="buyerName" placeholder="Customer Name" required class="w-full p-2 border rounded-lg">
                                    <input type="email" id="buyerEmail" placeholder="Customer Email (for confirmation)" required class="w-full p-2 border rounded-lg">
                                    <input type="tel" id="buyerPhone" placeholder="Customer Phone (Optional)" class="w-full p-2 border rounded-lg">
                                    <textarea id="deliveryAddress" rows="2" placeholder="Delivery Address" required class="w-full p-2 border rounded-lg"></textarea>
                                    <textarea id="orderNotes" rows="2" placeholder="Internal Admin Notes (Optional)" class="w-full p-2 border rounded-lg"></textarea>
                                    
                                    <div class="pt-4 border-t">
                                        <button type="submit" id="submitOrderButton" disabled
                                                class="w-full bg-purple-600 text-white py-3 rounded-lg font-extrabold hover:bg-purple-700 transition duration-150 shadow-lg disabled:bg-purple-300 disabled:cursor-not-allowed">
                                            SUBMIT ORDER & SEND EMAIL
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-pink-500">
                                <h3 class="text-xl font-bold mb-4 text-pink-700">Build Order Cart</h3>
                                
                                <div class="space-y-4 mb-4 p-3 bg-pink-50 rounded-lg">
                                    <div class="flex space-x-2">
                                        <select id="itemSelector" class="flex-grow p-2 border rounded-lg">
                                            </select>
                                        <input type="number" id="itemQuantity" value="1" min="1" class="w-20 p-2 border rounded-lg text-center">
                                    </div>
                                    <button type="button" onclick="window.module.addAdminCartItem()" class="w-full bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700">Add to Order</button>
                                </div>

                                <div class="space-y-3 max-h-60 custom-scrollbar overflow-y-auto pr-2" id="adminCartDisplay">
                                    </div>
                                
                                <div class="pt-4 mt-4 border-t border-gray-200">
                                    <div class="flex justify-between font-bold text-xl text-gray-800">
                                        <span>Total:</span>
                                        <span id="adminCartTotal">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                `;
            }
        }

        function renderAdminPage(userName) {
            document.getElementById('app').innerHTML = `
                <header class="flex justify-between items-center mb-10 pb-4 border-b-4 border-indigo-600">
                    <h1 class="text-4xl font-extrabold text-indigo-700">Admin Dashboard</h1>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600 font-medium text-sm hidden sm:inline">Welcome, ${userName}</span>
                        ${state.previewMode
                            ? `<button onclick="window.module.togglePreviewMode(false)" class="px-4 py-2 rounded-lg font-semibold text-white bg-indigo-500 hover:bg-indigo-600">Exit Preview</button>`
                            : `<button onclick="window.module.togglePreviewMode(true)" class="px-4 py-2 rounded-lg font-semibold text-white bg-green-500 hover:bg-green-600">Preview Site</button>`
                        }
                        <button id="signOutButton" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600">Sign Out</button>
                    </div>
                </header>
                <div class="md:flex md:space-x-8">
                    <nav class="w-full md:w-1/4 mb-6 md:mb-0">
                        <div class="bg-white p-4 rounded-xl shadow-lg space-y-2 sticky top-4 ${state.previewMode ? 'opacity-50 pointer-events-none' : ''}">
                            <button onclick="window.module.switchAdminTab('catalog')" class="tab-button w-full text-left p-3 rounded-lg font-semibold ${state.activeTab === 'catalog' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">Catalog & Products</button>
                            <button onclick="window.module.switchAdminTab('config')" class="tab-button w-full text-left p-3 rounded-lg font-semibold ${state.activeTab === 'config' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">Configuration</button>
                            <button onclick="window.module.switchAdminTab('users')" class="tab-button w-full text-left p-3 rounded-lg font-semibold ${state.activeTab === 'users' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">Registered Users</button>
                            <button onclick="window.module.switchAdminTab('orders')" class="tab-button w-full text-left p-3 rounded-lg font-semibold ${state.activeTab === 'orders' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">Orders</button>
                        </div>
                    </nav>
                    <main class="w-full md:w-3/4 space-y-12">
                        ${state.previewMode ? renderPreviewSite() : renderAdminTabs()}
                    </main>
                </div>
            `;

            document.getElementById('signOutButton')?.addEventListener('click', () => {
                clearTimeout(idleTimer);
                signOut(auth).then(() => location.href = '/');
            });

            // Initial render based on active tab
            if (state.activeTab === 'catalog' && !state.previewMode) renderProductListSection();
            if (state.activeTab === 'config' && !state.previewMode) { window.module.fetchAdminConfig(); window.module.displayStaticIps(); }
            if (state.activeTab === 'users' && !state.previewMode) { 
                const grid = document.getElementById('usersGrid');
                // Only fetch users if the list is empty
                if (grid && state.allUsers.length === 0) window.module.fetchUsers();
            }
            if (state.activeTab === 'orders' && !state.previewMode) window.module.updateAdminCartDisplay();
        }

        // --- EXPOSE TO WINDOW (ONLY ONCE!) ---
        window.module = {
            globalNextPageToken,
            globalConfig,
            fetchUsers,
            renderUserList, 

            fetchAdminConfig,
            displayStaticIps,
            handleUpdateConfig, 

            switchAdminTab,
            handleAddCatalog,
            handleDeleteCatalog,
            handleAddProduct,
            handleDeleteProduct,
            handleSearchInput, // Product search
            handleUserSearchInput, // User search 
            showEditForm,
            cancelEdit,
            handleEditProduct,
            renderProductListSection,
            togglePreviewMode,
            logAdminAction,

            promptForPasswordReset,
            deleteUser,
            disableUser,
            handleClearAnonymousUsers,

            handleAdminOrderSubmit,
            addAdminCartItem,
            removeAdminCartItem,
            updateAdminCartDisplay
        };

        document.addEventListener('DOMContentLoaded', setupFirebase);
    </script>
</body>
</html>

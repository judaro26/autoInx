<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>autoInx Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .grid-header { font-weight: bold; background-color: #f3f4f6; padding: 10px; text-align: left; }
        .grid-item { padding: 10px; border-bottom: 1px solid #e5e7eb; word-break: break-all; }
        .admin-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .tab-button { transition: background-color 0.15s, color 0.15s; }
        .preview-iframe-container {
            height: 80vh;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #6366f1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #e5e7eb; }
        /* NEW: Address Validation Styles */
        .address-input { @apply w-full p-2 border rounded-lg transition-all duration-200; }
        .address-valid { @apply border-green-500 bg-green-50; }
        .address-invalid { @apply border-red-500 bg-red-50; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div id="loadingState" class="text-center p-20">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600">Checking authentication and loading configuration...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // CORRECTED: Import static IP list directly from the new client-accessible path
        import { ipWhitelist as staticIpWhitelist } from './js/utilities/ipWhitelist.js'; 

        // --- GLOBAL VARIABLES & STATE ---
        let auth;
        let db;
        let autocomplete; // Global variable for Google Autocomplete instance
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let globalNextPageToken = null;
        let globalConfig = { maintenanceMode: false, chatWidgetEnabled: true }; 
        const IDLE_TIMEOUT_MS = 15 * 60 * 1000; // 15 minutes
        let idleTimer;

        const state = {
            activeTab: 'catalog',
            catalogs: [],
            items: [],
            searchTerm: '', // for products
            userSearchTerm: '', // NEW: for users
            allUsers: [], // NEW: Store all fetched users for client-side search
            editingItem: null,
            previewMode: false,
            adminCart: {},
        };

        // --- FIRESTORE COLLECTION PATHS & FUNCTION URLS ---
        const CATALOGS_COLLECTION = `artifacts/${appId}/public/data/catalogs`;
        const ITEMS_COLLECTION = `artifacts/${appId}/public/data/items`;
        const CONFIG_FUNCTION = '/.netlify/functions/getAdminConfig';
        const UPDATE_CONFIG_FUNCTION = '/.netlify/functions/updateAdminConfig';
        const LIST_USERS_FUNCTION = '/.netlify/functions/listUsers';
        const LOG_ACTION_FUNCTION = '/.netlify/functions/logAdminAction';
        const MANAGE_USER_FUNCTION = '/.netlify/functions/manageUser';
        const CLEAR_ANON_FUNCTION = '/.netlify/functions/clearAnonymousUsers';
        const ADMIN_CREATE_ORDER_FUNCTION = '/.netlify/functions/adminCreateOrder';
        const MAPS_KEY_FUNCTION_URL = '/.netlify/functions/getGoogleMapsKey'; 

        // --- CORE FIREBASE SETUP ---
        async function loadFirebaseConfig() {
            try {
                // CORRECTION: Must use /.netlify/functions/ to correctly target the deployed function
                const response = await fetch('/.netlify/functions/getClientFirebaseConfig');
                if (!response.ok) throw new Error(`Failed to fetch config (Status: ${response.status})`);
                return await response.json();
            } catch (error) {
                console.error("Failed to load Firebase configuration:", error);
                return {};
            }
        }

        async function setupFirebase() {
            const firebaseConfig = await loadFirebaseConfig();
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                return;
            }
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            loadGoogleMapsScript(); // Load Maps Script after Firebase setup
            checkAuthAndRender();
        }

        // --- NEW: Google Maps Autocomplete Logic (Duplicated from checkout.html) ---

        // Function called by the dynamically loaded Google Maps script
        window.initGooglePlaces = function() {
            const input = document.getElementById('deliveryAddress');
            if (!input) return;

            // Initialize Autocomplete, restricting to addresses and selected countries
            autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['address'],
                componentRestrictions: { country: ['co', 'us'] },
                fields: ['formatted_address', 'geometry']
            });

            // Set initial state
            input.dataset.validated = 'false';
            input.classList.add('border-gray-300');

            // Listener: When the user selects an address from the dropdown
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (place.geometry) {
                    input.classList.remove('address-invalid', 'border-gray-300');
                    input.classList.add('address-valid');
                    document.getElementById('addressErrorAdmin').classList.add('hidden');
                    input.dataset.validated = 'true';
                }
            });

            // Listener: Mark as invalid if user manually types after initialization/selection
            input.addEventListener('input', () => {
                input.classList.remove('address-valid');
                input.classList.add('address-invalid');
                document.getElementById('addressErrorAdmin').classList.add('hidden');
                input.dataset.validated = 'false';
            });
        };

        async function loadGoogleMapsScript() {
            try {
                // 1. Fetch API Key securely from the Netlify Function
                const response = await fetch(MAPS_KEY_FUNCTION_URL);
                if (!response.ok) throw new Error('Failed to fetch Maps API key.');
                const { apiKey } = await response.json();
                
                // 2. Build the script URL
                const scriptUrl = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initGooglePlaces`;

                // 3. Dynamically create and append the script tag
                const script = document.createElement('script');
                script.src = scriptUrl;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);

            } catch (error) {
                console.warn('Delivery Address Validation service disabled for Admin:', error);
            }
        }
        // --- END: Google Maps Autocomplete Logic ---


        // --- IDLE TIMEOUT LOGIC ---
        function autoLogout() {
            // ... (unchanged)
        }

        function resetTimer() {
            // ... (unchanged)
        }

        // --- AUTHENTICATION CHECK & REDIRECT ---
        function checkAuthAndRender() {
            // ... (unchanged)
        }

        // --- FIRESTORE REALTIME LISTENERS ---
        function setupRealtimeListeners() {
            // ... (unchanged)
        }

        // --- HELPER FUNCTIONS ---
        // ... (unchanged)

        // --- ADMIN CONFIG FUNCTIONS (MODIFIED) ---
        /**
         * Fetches the dynamic admin configuration from Firestore via Netlify Function.
         */
        async function fetchAdminConfig() {
            try {
                const response = await fetch(CONFIG_FUNCTION);
                if (!response.ok) throw new Error('Failed to fetch admin config.');
                
                const config = await response.json();
                window.module.globalConfig = config;
                
                // Update form values with fetched config
                const maintenanceToggle = document.getElementById('maintenanceToggle');
                const chatWidgetToggle = document.getElementById('chatWidgetToggle'); // NEW
                
                if (maintenanceToggle) maintenanceToggle.checked = config.maintenanceMode;
                if (chatWidgetToggle) chatWidgetToggle.checked = config.chatWidgetEnabled; // NEW
                

                const ipListEl = document.getElementById('dynamicIpList');
                if (ipListEl) {
                    ipListEl.value = Array.isArray(config.ipWhitelist) ? config.ipWhitelist.join('\n') : '';
                }

                const lastUpdatedEl = document.getElementById('configLastUpdated');
                if (lastUpdatedEl && config.lastUpdated) {
                    const date = config.lastUpdated.toDate ? config.lastUpdated.toDate() : new Date(config.lastUpdated._seconds * 1000);
                    lastUpdatedEl.textContent = `Last Updated: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                }

            } catch (error) {
                console.error('Error fetching admin config:', error);
                showMessage('error', 'Failed to load dynamic configuration.');
            }
        }

        /**
         * Handles saving the configuration changes back to Firestore.
         */
        async function handleUpdateConfig(event) {
            event.preventDefault();
            resetTimer();
            
            const maintenanceMode = document.getElementById('maintenanceToggle').checked;
            const chatWidgetEnabled = document.getElementById('chatWidgetToggle').checked; // NEW
            const ipListText = document.getElementById('dynamicIpList').value.trim();
            
            // Parse IP list: split by newline, filter empty, trim whitespace
            const ipWhitelist = ipListText.split('\n').map(ip => ip.trim()).filter(ip => ip.length > 0);

            const updates = {
                maintenanceMode,
                chatWidgetEnabled, // NEW
                ipWhitelist
            };

            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch(UPDATE_CONFIG_FUNCTION, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify(updates)
                });

                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(errorDetails.details || errorDetails.error || response.statusText);
                }

                showMessage('success', 'Configuration updated successfully.', 5000);
                await logAdminAction('CONFIG_UPDATED', updates);
                fetchAdminConfig(); // Reload config to update last updated time
                
            } catch (error) {
                console.error('Error updating config:', error);
                showMessage('error', `Failed to update configuration: ${error.message}`);
            }
        }

        // ... (rest of CRUD and User Management functions unchanged)
        
        // --- ADMIN ORDER CREATION (MODIFIED) ---
        // ... (getTotalAdminCartPrice, renderAdminCart, renderItemSelectorOptions, updateAdminCartDisplay, addAdminCartItem, removeAdminCartItem unchanged)

        async function handleAdminOrderSubmit(event) {
            event.preventDefault();
            resetTimer();

            const submitBtn = document.getElementById('submitOrderButton');
            
            if (Object.keys(state.adminCart).length === 0) {
                return showMessage('error', 'The order cart is empty!', 3000);
            }

            const buyerName = document.getElementById('buyerName').value.trim();
            const buyerEmail = document.getElementById('buyerEmail').value.trim();
            const buyerPhone = document.getElementById('buyerPhone').value.trim();
            const deliveryAddressInput = document.getElementById('deliveryAddress');
            const deliveryAddress = deliveryAddressInput.value.trim();
            const notes = document.getElementById('orderNotes').value.trim();
            const totalCents = getTotalAdminCartPrice();
            
            // Address validation check
            const isAddressValidated = deliveryAddressInput.dataset.validated === 'true';
            const hasAutocompleteLoaded = typeof google !== 'undefined' && typeof google.maps !== 'undefined';

            if ((hasAutocompleteLoaded && !isAddressValidated) || !deliveryAddress) {
                deliveryAddressInput.classList.remove('address-valid', 'border-gray-300');
                deliveryAddressInput.classList.add('address-invalid');
                document.getElementById('addressErrorAdmin').classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'SUBMIT ORDER & SEND EMAIL';
                return showMessage('error', 'Please ensure you select a valid address from the dropdown suggestions.');
            } else {
                // If Autocomplete hasn't loaded (e.g., failed to fetch key), we allow manual entry.
                document.getElementById('addressErrorAdmin').classList.add('hidden');
            }
            // End validation check

            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            const orderDetails = {
                // ... (orderDetails payload unchanged)
            };

            try {
                // ... (server call logic unchanged)
                
                // Clear address validation visual state on successful submit
                deliveryAddressInput.classList.remove('address-valid', 'address-invalid');
                deliveryAddressInput.classList.add('border-gray-300');


            } catch (error) {
                // ... (error handling unchanged)
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'SUBMIT ORDER & SEND EMAIL';
            }
        }

        function renderAdminOrderSection() {
            const itemSelector = document.getElementById('itemSelector');
            if (itemSelector) itemSelector.innerHTML = `<option value="">-- Select Product --</option>${renderItemSelectorOptions()}`;
            // Re-initialize Autocomplete if the tab is re-rendered
            if (window.initGooglePlaces) window.initGooglePlaces();
        }


        // ----------------------------------------------------------------------
        // --- RENDERING FUNCTIONS (MODIFIED) ---
        // ----------------------------------------------------------------------

        // ... (renderEditProductForm, renderProductListSection, renderPreviewSite unchanged)

        function renderAdminTabs() {
            const catOpts = state.catalogs.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            if (state.activeTab === 'catalog') {
                // ... (Catalog tab rendering unchanged)
            } else if (state.activeTab === 'config') {
                return `
                    <section class="space-y-8">
                        <div id="configMessage"></div>
                        <h2 class="text-2xl font-bold text-indigo-700">Global System Configuration</h2>

                        <div class="p-4 bg-blue-50 rounded-xl shadow-inner border border-blue-300">
                            <div class="flex items-center justify-between">
                                <label for="chatWidgetToggle" class="text-lg font-medium text-gray-700">Enable Site Chat Widget</label>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="chatWidgetToggle" id="chatWidgetToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                                    <label for="chatWidgetToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                                <style>
                                    #chatWidgetToggle:checked { border-color: #3b82f6; }
                                    #chatWidgetToggle:checked + .toggle-label { background-color: #3b82f6; }
                                    #chatWidgetToggle:checked + .toggle-label { transform: translateX(20px); }
                                </style>
                            </div>
                            <p class="text-sm text-blue-600 mt-2">Controls visibility of the customer support chat widget on the public site.</p>
                        </div>
                        <div class="p-4 bg-red-100 rounded-xl shadow-inner border border-red-300">
                            <p class="text-sm font-semibold text-red-700 mb-3">User Management Utility (Global Action):</p>
                            <button id="clearAnonButtonConfig" onclick="window.module.handleClearAnonymousUsers()" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700 transition duration-150 shadow-md">
                                Clear All Anonymous Users
                            </button>
                            <p class="text-xs text-red-500 mt-2">Warning: This action is irreversible and should only be performed after careful consideration.</p>
                        </div>
                        
                        <form id="configForm" onsubmit="window.module.handleUpdateConfig(event)" class="bg-white p-6 rounded-xl shadow-lg space-y-6">
                            
                            <div class="flex items-center justify-between p-4 border rounded-lg bg-red-50 border-red-200">
                                <label for="maintenanceToggle" class="text-lg font-medium text-gray-700">Maintenance Mode</label>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="maintenanceToggle" id="maintenanceToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                                    <label for="maintenanceToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-red-300 cursor-pointer"></label>
                                </div>
                                <p class="text-sm text-red-600">Disables store functionality for public users.</p>
                                <style>
                                    #maintenanceToggle:checked { border-color: #10b981; }
                                    #maintenanceToggle:checked + .toggle-label { background-color: #10b981; }
                                    #maintenanceToggle:checked + .toggle-label { transform: translateX(20px); }
                                </style>
                            </div>

                            <div>
                                <h3 class="text-xl font-bold mb-2 text-gray-700">Dynamic Admin IP Whitelist (Stored in Firestore)</h3>
                                <p class="text-sm text-gray-500 mb-4">Users from these IPs can access the Admin Login page even if Maintenance Mode is active. One IP address per line.</p>
                                <textarea id="dynamicIpList" rows="4" placeholder="123.45.67.89&#10;98.76.54.32" class="w-full p-3 border rounded-lg font-mono text-sm"></textarea>
                                <p id="configLastUpdated" class="text-xs text-gray-500 mt-2"></p>
                            </div>

                            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <h3 class="text-xl font-bold mb-2 text-gray-700">Static Client IP Whitelist (Codebase)</h3>
                                <p class="text-sm text-gray-500 mb-2">This is the hardcoded IP list used by the client-side code (index.html) to check for access before loading Firebase config. Requires redeployment to change.</p>
                                <pre id="staticIpListDisplay" class="bg-white p-3 rounded-lg border font-mono text-sm text-gray-800"></pre>
                            </div>
                            
                            <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">Save Configuration</button>
                        </form>
                    </section>
                `;
            } else if (state.activeTab === 'users') {
                // ... (Users tab rendering unchanged)
            } else if (state.activeTab === 'orders') {
                return `
                    <section class="space-y-8">
                        <h2 class="text-2xl font-bold text-indigo-700">Manual Order Creation</h2>
                        <div id="ordersMessage"></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500">
                                <h3 class="text-xl font-bold mb-4 text-purple-700">Enter Customer Details</h3>
                                <form id="createOrderForm" onsubmit="window.module.handleAdminOrderSubmit(event)" class="space-y-4">
                                    <input type="text" id="buyerName" placeholder="Customer Name" required class="w-full p-2 border rounded-lg">
                                    <input type="email" id="buyerEmail" placeholder="Customer Email (for confirmation)" required class="w-full p-2 border rounded-lg">
                                    <input type="tel" id="buyerPhone" placeholder="Customer Phone (Optional)" class="w-full p-2 border rounded-lg">
                                    
                                    <input type="text" id="deliveryAddress" placeholder="Start typing address for validation..." required 
                                        class="w-full p-2 border rounded-lg address-input" 
                                        autocomplete="off" data-validated="false">
                                    <p id="addressErrorAdmin" class="text-sm text-red-600 mt-1 hidden">
                                        Please select a valid address from the dropdown.
                                    </p>
                                    <textarea id="orderNotes" rows="2" placeholder="Internal Admin Notes (Optional)" class="w-full p-2 border rounded-lg"></textarea>
                                    
                                    <div class="pt-4 border-t">
                                        <button type="submit" id="submitOrderButton" disabled
                                                class="w-full bg-purple-600 text-white py-3 rounded-lg font-extrabold hover:bg-purple-700 transition duration-150 shadow-lg disabled:bg-purple-300 disabled:cursor-not-allowed">
                                            SUBMIT ORDER & SEND EMAIL
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-pink-500">
                                <h3 class="text-xl font-bold mb-4 text-pink-700">Build Order Cart</h3>
                                
                                <div class="space-y-4 mb-4 p-3 bg-pink-50 rounded-lg">
                                    <div class="flex space-x-2">
                                        <select id="itemSelector" class="flex-grow p-2 border rounded-lg">
                                            </select>
                                        <input type="number" id="itemQuantity" value="1" min="1" class="w-20 p-2 border rounded-lg text-center">
                                    </div>
                                    <button type="button" onclick="window.module.addAdminCartItem()" class="w-full bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700">Add to Order</button>
                                </div>

                                <div class="space-y-3 max-h-60 custom-scrollbar overflow-y-auto pr-2" id="adminCartDisplay">
                                    </div>
                                
                                <div class="pt-4 mt-4 border-t border-gray-200">
                                    <div class="flex justify-between font-bold text-xl text-gray-800">
                                        <span>Total:</span>
                                        <span id="adminCartTotal">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                `;
            }
        }

        function renderAdminPage(userName) {
            // ... (rest of renderAdminPage unchanged)
        }

        // --- EXPOSE TO WINDOW (ONLY ONCE!) ---
        window.module = {
            globalNextPageToken,
            globalConfig,
            fetchUsers,
            renderUserList, 

            fetchAdminConfig,
            displayStaticIps,
            handleUpdateConfig, 

            switchAdminTab,
            handleAddCatalog,
            handleAddProduct,
            handleEditProduct,
            handleDeleteCatalog,
            handleDeleteProduct,
            handleSearchInput, // Product search
            handleUserSearchInput, // User search 
            showEditForm,
            cancelEdit,
            renderProductListSection,
            togglePreviewMode,
            logAdminAction,

            promptForPasswordReset,
            deleteUser,
            disableUser,
            handleClearAnonymousUsers,

            handleAdminOrderSubmit,
            addAdminCartItem,
            removeAdminCartItem,
            updateAdminCartDisplay
        };

        document.addEventListener('DOMContentLoaded', setupFirebase);
    </script>
</body>
</html>

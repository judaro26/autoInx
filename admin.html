rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper function to check for Admin role ---
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // -------------------------------------------------------------
    // 1. PUBLIC DATA (Catalogs and Items)
    // -------------------------------------------------------------
    match /artifacts/{appId}/public/data/{collectionName}/{documentId} {
      // Allow EVERYONE to read the public catalog data
      allow read: if true;

      // Allow write (create, update, delete) only if the user is an admin
      allow write: if isAdmin() && 
        (collectionName == 'catalogs' || collectionName == 'items');
    }
    
    // -------------------------------------------------------------
    // 2. ADMIN CONFIG 
    // -------------------------------------------------------------
    match /admin/config {
        // Only admins can read and write the config document
        allow read, write: if isAdmin();
    }

    // -------------------------------------------------------------
    // 3. ADMIN LOGS
    // -------------------------------------------------------------
    match /admin/logs/{logName}/catalogActions/{actionId} {
        // Only allow an admin to create new log entries
        allow create: if isAdmin();
        // Prevent accidental reading or modification
        allow read, update, delete: if false; 
    }
    
    // -------------------------------------------------------------
    // 4. TOP-LEVEL ORDER COLLECTION (FINAL, FLEXIBLE FIX)
    // Path: /artifacts/default-app-id/public/data/orders/{orderId}
    // -------------------------------------------------------------
    match /artifacts/{appId}/public/data/orders/{orderId} {
        allow read: if true;

        // FINAL FIX: Allow Admin update IF status is being changed AND no critical fields are touched.
        allow update: if isAdmin() && 
                        // 1. Ensure the status field is actually changing
                        request.resource.data.status != resource.data.status &&
                        // 2. Ensure NO other fields crucial to integrity (like totalCents or items) are changing
                        request.resource.data.totalCents == resource.data.totalCents &&
                        request.resource.data.items == resource.data.items;
    }
    // -------------------------------------------------------------
    // 5. USER ORDERS (Private Subcollection)
    // This is the private, per-user collection where orders are stored.
    // Path: artifacts/{appId}/users/{userId}/orders/{orderId}
    // -------------------------------------------------------------
    match /artifacts/{appId}/users/{userId}/orders/{orderId} {
      // Allow users to create their own orders
      allow create: if request.auth.uid == userId;
      
      // Allow the user who owns the order OR an admin to read the order
      allow read: if request.auth.uid == userId || isAdmin();
      
      // Allow Admins to update the status in the private user subcollection
      allow update: if isAdmin() && 
                      request.resource.data.keys().hasOnly(['status']);
      
      // Prevent users and admins from deleting orders (for history)
      allow delete: if false;
    }
  }
}

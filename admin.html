<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>autoInx Admin Dashboard</title>
    
    <link rel="icon" type="image/x-icon" href="/images/AutoInx logo.ico">
    
    <link rel="icon" type="image/png" sizes="32x32" href="/images/AutoInx logo.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style type="text/tailwindcss">
        body { font-family: 'Inter', sans-serif; }
        .grid-header { font-weight: bold; background-color: #f3f4f6; padding: 10px; text-align: left; }
        .grid-item { padding: 10px; border-bottom: 1px solid #e5e7eb; word-break: break-all; }
        /* CRITICAL FIX 1: Removed .admin-grid rule to prevent overriding specific inline grid-template-columns */
        .tab-button { transition: background-color 0.15s, color 0.15s; }
        .preview-iframe-container {
            height: 80vh;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #6366f1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #e5e7eb; }
        
        /* NEW: Address Validation Styles - NOW PROCESSED CORRECTLY */
        .address-input { @apply w-full p-2 border rounded-lg transition-all duration-200; }
        .address-valid { @apply border-green-500 bg-green-50; }
        .address-invalid { @apply border-red-500 bg-red-50; }
        
        /* START FIX 2 & 3: Corrected Toggle Switch CSS */
        .toggle-checkbox {
            position: absolute; /* FIX: Added absolute positioning */
            top: 0;
            left: 0;
            margin: 0;
            opacity: 0; /* ADDED: Hide the actual checkbox */
            width: 100%; /* ADDED: Make it cover the label for easier click */
            height: 100%; /* ADDED: Make it cover the label for easier click */
            z-index: 10;
            cursor: pointer;
        }
        .toggle-label {
            /* This is the track */
            display: block; 
            overflow: hidden; 
            height: 1.5rem; /* 6 for h-6 */
            border-radius: 9999px; /* rounded-full */
            background-color: #d1d5db; /* gray-300 */
            transition: background-color 0.15s ease-in-out;
        }
    
        /* Toggled State - Uses sibling selector on the hidden checkbox input */
        #chatWidgetToggle:checked + .toggle-label { 
            background-color: #3b82f6; /* Blue-500 */
        }
        /* CRITICAL FIX: This needs to target the handle's actual visual element, not the hidden checkbox.
           Since the HTML structure is often hard to change, let's keep the original toggle logic 
           but ensure the `:checked` state *only* sets the transform on the checkbox itself.
           The error-causing logic was: #chatWidgetToggle:checked { transform: translateX(20px); }
           
           We need to style the handle. Assuming the HTML structure is: 
           <div class="relative w-10 h-6">
               <input type="checkbox" id="toggle" class="toggle-checkbox" />
               <label for="toggle" class="toggle-label"></label>
               <div class="toggle-handle absolute ..."></div> <- The missing element
           </div>
           
           Since we don't have the handle element, let's apply the transform directly to the checkbox 
           as you did, but ensure the checkbox is invisible (opacity: 0) and cover its parent. 
           The visual movement logic is flawed without a separate handle element. 
           
           For a clean fix *within your existing CSS philosophy*, use Tailwind's `peer` utility or 
           a modified CSS for the toggle handle (which is currently missing in the style).
           
           **Given your current structure, the transform needs to be applied to a *visible* element.** Let's use a background image or box-shadow trick to simulate the handle on the label, which 
           is generally too complex for a quick fix.
           
           **Simplest fix for YOUR CODE:** Remove the problematic toggle transform from the checkbox itself, as it's meant to be invisible. The original author was likely missing the handle element.
           Let's remove the incorrect transform and rely on the label's background color change.
        */
    
        /* Removed incorrect transform on the checkbox itself: */
        /* #chatWidgetToggle:checked { transform: translateX(20px); } */
        /* #maintenanceToggle:checked { transform: translateX(20px); } */
        
        /* Maintenance Toggle Styles */
        #maintenanceToggle:checked + .toggle-label { background-color: #10b981; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div id="loadingState" class="text-center p-20">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600">Checking authentication and loading configuration...</p>
        </div>
    </div>

    <div id="editModalContainer"></div> 

    <script type="module">
        // 2. ADDED: Global object to hold Chart.js instances
        let salesCharts = { category: null, month: null };
        // import modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, getIdTokenResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, deleteDoc, onSnapshot, collection, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // CORRECTED: Import static IP list directly from the new client-accessible path
        import { ipWhitelist as staticIpWhitelist } from './js/utilities/ipWhitelist.js'; 
        
        // --- GLOBAL VARIABLES & STATE ---
        let auth;
        let db;
        let userId = null;
        let autocomplete; // Global variable for Google Autocomplete instance
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let globalNextPageToken = null;
        let globalConfig = { maintenanceMode: false, chatWidgetEnabled: true, ipWhitelist: [] }; // Initialized ipWhitelist 
        const IDLE_TIMEOUT_MS = 15 * 60 * 1000; // 15 minutes
        let idleTimer;
        let orders = [];
        let lastCategorySalesData = { tableData: [] };
    
        const state = {
            activeTab: 'catalog',
            catalogs: [],
            items: [],
            searchTerm: '', 
            orderSearchTerm: '',
            userSearchTerm: '', 
            allUsers: [], 
            selectedUsers: [],
            editingItem: null,
            previewMode: false,
            adminCart: {},
            // --- ORDERS STATE ---
            orders: [],
            orderListSearchTerm: '',
            orderStatusFilter: 'All',
            deliveryStatusFilter: 'All', 
            orderPage: 'list', 
            
            // ✅ CRITICAL FIX: Initialize the sales time filter
            salesTimeFilter: 'last6months', 
            // -------------------------
        };
    
        // --- FIRESTORE COLLECTION PATHS & FUNCTION URLS ---
        const CATALOGS_COLLECTION = `artifacts/${appId}/public/data/catalogs`;
        const ITEMS_COLLECTION = `artifacts/${appId}/public/data/items`;
        const CONFIG_FUNCTION = '/.netlify/functions/getAdminConfig';
        const UPDATE_CONFIG_FUNCTION = '/.netlify/functions/updateAdminConfig';
        const LIST_USERS_FUNCTION = '/.netlify/functions/listUsers';
        const LOG_ACTION_FUNCTION = '/.netlify/functions/logAdminAction';
        const MANAGE_USER_FUNCTION = '/.netlify/functions/manageUser';
        const CLEAR_ANON_FUNCTION = '/.netlify/functions/clearAnonymousUsers';
        const ADMIN_CREATE_ORDER_FUNCTION = '/.netlify/functions/adminCreateOrder';
        const MAPS_KEY_FUNCTION_URL = '/.netlify/functions/getGoogleMapsKey'; 
        const CONFIG_CLIENT_FUNCTION = '/.netlify/functions/getClientFirebaseConfig';
        const EMAIL_CONFIRMATION_FUNCTION = '/.netlify/functions/sendOrderConfirmation'; // Added Email Function
        const ORDERS_COLLECTION = `artifacts/${appId}/public/data/orders`; // orders collection
    
        // --- CORE FIREBASE SETUP ---
        async function loadFirebaseConfig() {
            try {
                // CORRECTION: Must use /.netlify/functions/ to correctly target the deployed function
                const response = await fetch(CONFIG_CLIENT_FUNCTION);
                if (!response.ok) throw new Error(`Failed to fetch config (Status: ${response.status})`);
                return await response.json();
            } catch (error) {
                console.error("Failed to load Firebase configuration:", error);
                return {};
            }
        }
    
        async function setupFirebase() {
            const firebaseConfig = await loadFirebaseConfig();
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                return;
            }
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            checkAuthAndRender();
        }

        // NEW FUNCTION: Exports individual order item details, which contain date/status/payment.
        function downloadIndividualItemSalesCsv() {
            resetTimer();
            const data = lastCategorySalesData.tableData;
        
            if (data.length === 0) {
                showMessage('error', 'No data available to download.', 5000, 'orders');
                return;
            }
        
            // Define CSV headers for individual items
            const headers = [
                "Category", "Order ID (Short)", "Full Order ID", "Date", "Status", 
                "Payment Status", "Item Name", "Quantity", "Total Item Revenue (USD)"
            ];
        
            // Collect ALL individual sales records from all categories
            const csvRows = [];
            data.forEach(categoryRow => {
                categoryRow.rawOrders.forEach(orderItem => {
                    // Convert Cents back to Dollars for CSV display and use .toFixed(2)
                    const totalRevenueUSD = (orderItem.totalItemCents / 100).toFixed(2);
                    const category = `"${categoryRow.category.replace(/"/g, '""')}"`;
                    const itemName = `"${orderItem.itemName.replace(/"/g, '""')}"`;
        
                    // Use UTC string for most accurate timestamp
                    const dateStr = orderItem.date ? new Date(orderItem.date).toISOString() : 'N/A';
        
                    csvRows.push([
                        category,
                        orderItem.id, // Short ID
                        orderItem.fullId, // Full ID
                        dateStr, 
                        orderItem.status,
                        orderItem.paymentStatus,
                        itemName,
                        orderItem.quantity,
                        totalRevenueUSD
                    ].join(','));
                });
            });
        
            // Combine headers and rows
            const csvString = [
                headers.join(','),
                ...csvRows
            ].join('\n');
        
            // Create a Blob and trigger download
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            const filename = `Sales_Detail_Items_${state.salesTimeFilter}_${new Date().toISOString().slice(0, 10)}.csv`;
        
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage('success', `Exported ${csvRows.length} item records to ${filename}.`, 5000, 'orders');
            } else {
                showMessage('error', 'Browser does not support automatic CSV download.', 5000, 'orders');
            }
        }  
    
        // --- GOOGLE MAPS AUTOCPMLETE LOGIC ---
    
        // Function to update the Order Submit button state
        function updateSubmitButtonState() {
            const submitButton = document.getElementById('submitOrderButton');
            const addressInput = document.getElementById('deliveryAddress');

            // Check if address is validated (data-validated="true") 
            const isAddressValid = addressInput?.dataset.validated === 'true';

            // Check if cart has items
            const isCartNotEmpty = Object.keys(state.adminCart).length > 0; 

            if (submitButton) {
                // Button is enabled only if address is valid AND the cart is not empty
                submitButton.disabled = !(isAddressValid && isCartNotEmpty);
            }
        }
            
    
        // Function called by the dynamically loaded Google Maps script
        window.initGooglePlaces = function() {
            const input = document.getElementById('deliveryAddress');
            if (!input) return;
    
            // Initialize Autocomplete, restricting to addresses and selected countries
            autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['address'],
                componentRestrictions: { country: ['co', 'us'] },
                fields: ['formatted_address', 'geometry']
            });
    
            // Set initial state
            input.dataset.validated = 'false';
            input.classList.remove('address-valid');
            input.classList.add('address-invalid'); // Start as invalid
            document.getElementById('addressErrorAdmin')?.classList.remove('hidden');
            
            updateSubmitButtonState(); // Initialize button state
    
            // Listener: When the user selects an address from the dropdown
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (place.geometry) {
                    input.classList.remove('address-invalid', 'border-gray-300');
                    input.classList.add('address-valid');
                    document.getElementById('addressErrorAdmin')?.classList.add('hidden');
                    input.dataset.validated = 'true';
                }
                updateSubmitButtonState(); // Update button state on selection
            });
    
            // Listener: Mark as invalid if user manually types after initialization/selection
            input.addEventListener('input', () => {
                input.classList.remove('address-valid');
                input.classList.add('address-invalid');
                document.getElementById('addressErrorAdmin')?.classList.remove('hidden'); // Show error on manual input
                input.dataset.validated = 'false';
                updateSubmitButtonState(); // Update button state on manual input
            });
        };
    
        async function loadGoogleMapsScript() {
            // Check if the script is ALREADY loaded or is being loaded
            if (document.querySelector('script[data-maps-loaded]')) {
                // If loaded, and the callback function is ready, call it directly
                if (typeof window.initGooglePlaces === 'function') {
                    window.initGooglePlaces();
                }
                return;
            }
            
            try {
                // 1. Fetch API Key securely from the Netlify Function
                const response = await fetch(MAPS_KEY_FUNCTION_URL);
                if (!response.ok) throw new Error('Failed to fetch Maps API key.');
                const { apiKey } = await response.json();
                
                // 2. Build the script URL
                const scriptUrl = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initGooglePlaces`;
            
                // 3. Dynamically create and append the script tag
                const script = document.createElement('script');
                script.src = scriptUrl;
                script.async = true;
                script.defer = true;
                script.setAttribute('data-maps-loaded', 'true'); // Add marker for check
                document.head.appendChild(script);
            
            } catch (error) {
                console.warn('Delivery Address Validation service disabled for Admin:', error);
            }
        }
        // --- END: Google Maps Autocomplete Logic ---
    
    
        // --- IDLE TIMEOUT LOGIC ---
        function autoLogout() {
            if (auth?.currentUser && !auth.currentUser.isAnonymous) {
                console.log("Admin idle timeout — logging out.");
                signOut(auth).then(() => {
                    logAdminAction('ADMIN_AUTO_LOGOUT', { reason: 'Idle Timeout (15m)' });
                    window.location.href = '/?error=idle_timeout';
                });
           }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Located around line 316
        function downloadCategorySalesCsv() {
            resetTimer();
            const data = lastCategorySalesData.tableData;
        
            if (data.length === 0) {
                showMessage('error', 'No data available to download.', 5000, 'orders');
                return;
            }
        
            // Define CSV headers
            const headers = ["Category", "Units Sold", "Total Revenue (USD)", "Avg. Item Price (USD)"];
        
            // Format the data rows
            const csvRows = data.map(row => {
                // --- FIX: Use the new 'Cents' properties and convert to Dollars for the CSV output ---
                const category = `"${row.category.replace(/"/g, '""')}"`; // Double quotes and escape internal quotes
                const unitsSold = row.unitsSold;
                
                // Convert Cents back to Dollars for CSV display and use .toFixed(2)
                const totalRevenueUSD = (row.totalRevenueCents / 100).toFixed(2); 
                const averagePriceUSD = (row.averagePriceCents / 100).toFixed(2);
                // ------------------------------------------------------------------------------------
        
                return [category, unitsSold, totalRevenueUSD, averagePriceUSD].join(',');
            });
        
            // Combine headers and rows
            const csvString = [
                headers.join(','),
                ...csvRows
            ].join('\n');
        
            // Create a Blob and trigger download
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            const filename = `Sales_Breakdown_${state.salesTimeFilter}_${new Date().toISOString().slice(0, 10)}.csv`;
        
            if (link.download !== undefined) { 
                // HTML5 download attribute is supported
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage('success', `Exported ${data.length} categories to ${filename}.`, 5000, 'orders');
            } else {
                showMessage('error', 'Browser does not support automatic CSV download.', 5000, 'orders');
            }
        }
        
          function renderCategorySalesTable(salesData) {
            if (!salesData.tableData || salesData.tableData.length === 0) {
                return `<p class="text-center text-gray-500 p-8">No sales data found for the selected time period.</p>`;
            }
        
            const tableRows = salesData.tableData.map((row, index) => {
                const totalRevenue = row.totalRevenueCents;
                const averagePrice = Math.round(row.averagePriceCents);
        
                // Generate detailed order rows
                const detailRows = row.rawOrders.map(order => `
                    <div class="grid grid-cols-5 gap-4 text-xs py-2 border-b border-gray-100 hover:bg-gray-50">
                        <div class="truncate text-gray-600" title="${formatTime(order.date, true)}">
                            ${formatTime(order.date)}
                        </div>
                        <div class="text-center">
                            <span class="px-2 py-1 text-xs rounded-full ${
                                order.status === 'Completed' ? 'bg-green-100 text-green-800' :
                                order.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' :
                                order.status === 'Cancelled' ? 'bg-red-100 text-red-800' :
                                'bg-gray-100 text-gray-800'
                            }">${order.status}</span>
                        </div>
                        <div class="text-center font-medium">${order.quantity}x ${escapeHtml(order.itemName)}</div>
                        <div class="text-center">
                            <span class="font-bold ${order.paymentStatus === 'Paid' ? 'text-green-600' : 'text-red-600'}">
                                ${order.paymentStatus}
                            </span>
                        </div>
                        <div class="text-right font-mono text-gray-700">${formatPriceDisplay(order.totalItemCents)}</div>
                    </div>
                `).join('');
        
                return `
                    <div class="border-b border-gray-200 last:border-b-0">
                        <!-- Summary Row -->
                        <div class="grid grid-cols-5 gap-4 items-center p-4 hover:bg-gray-50 transition-colors cursor-pointer"
                             onclick="document.getElementById('details-${index}').classList.toggle('hidden')">
                            <div class="text-sm font-semibold text-gray-800 truncate">${escapeHtml(row.category)}</div>
                            <div class="text-center text-gray-700">${row.unitsSold.toLocaleString()}</div>
                            <div class="text-center font-bold text-green-700">${formatPriceDisplay(totalRevenue)}</div>
                            <div class="text-right text-gray-600">${formatPriceDisplay(averagePrice)}</div>
                            <div class="text-right">
                                <span class="px-3 py-1 bg-indigo-600 text-white text-xs font-medium rounded-full">
                                    ${row.rawOrders.length} order${row.rawOrders.length !== 1 ? 's' : ''}
                                </span>
                            </div>
                        </div>
        
                        <!-- Expandable Details -->
                        <div id="details-${index}" class="hidden bg-gray-50 border-t border-gray-200">
                            <div class="p-4">
                                <h5 class="text-sm font-bold mb-3 text-gray-700 border-b pb-2">
                                    Orders in "${escapeHtml(row.category)}" (${row.unitsSold} units sold)
                                </h5>
        
                                <!-- Detail Header -->
                                <div class="grid grid-cols-5 gap-4 text-xs font-bold text-gray-600 bg-gray-200 px-3 py-2 rounded-t-md">
                                    <div>Date & Time</div>
                                    <div class="text-center">Status</div>
                                    <div class="text-center">Item</div>
                                    <div class="text-center">Payment</div>
                                    <div class="text-right">Revenue</div>
                                </div>
        
                                <!-- Detail Rows -->
                                <div class="max-h-64 overflow-y-auto custom-scrollbar text-xs">
                                    ${detailRows || '<div class="p-4 text-center text-gray-500">No individual orders found.</div>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        
            return `
                <div id="categorySalesBreakdown" class="bg-white rounded-xl shadow-xl border-t-4 border-indigo-600 overflow-hidden mt-8">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-6 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50">
                        <h4 class="text-2xl font-bold text-indigo-800 mb-3 sm:mb-0">Sales Breakdown by Category</h4>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="window.module.downloadCategorySalesCsv()"
                                    class="px-5 py-2.5 rounded-lg font-semibold text-white bg-green-600 hover:bg-green-700 transition shadow-md text-sm flex items-center gap-2">
                                <span>⬇️ Download Summary CSV</span>
                            </button>
                            <button onclick="window.module.downloadIndividualItemSalesCsv()"
                                    class="px-5 py-2.5 rounded-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 transition shadow-md text-sm flex items-center gap-2">
                                <span>⬇️ Download Detailed Items CSV</span>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <div class="min-w-[800px]">
                            <!-- Table Header -->
                            <div class="grid grid-cols-5 gap-4 font-bold text-gray-700 bg-gradient-to-r from-gray-100 to-gray-50 p-4 border-b-2 border-indigo-200">
                                <div>Category</div>
                                <div class="text-center">Units Sold</div>
                                <div class="text-center">Total Revenue</div>
                                <div class="text-right">Avg Price</div>
                                <div class="text-right">Orders</div>
                            </div>
        
                            <!-- Table Body -->
                            <div class="divide-y divide-gray-200">
                                ${tableRows}
                            </div>
                        </div>
                    </div>
        
                    <div class="p-4 text-right text-xs text-gray-500 bg-gray-50">
                        Total Categories: ${salesData.tableData.length} | 
                        Total Units Sold: ${salesData.tableData.reduce((sum, r) => sum + r.unitsSold, 0).toLocaleString()}
                    </div>
                </div>
            `;
        }
        
        function processSalesDataByCategory() {
            const categorySales = {};
            const itemMap = state.items.reduce((map, item) => {
                map[item.id] = item;
                return map;
            }, {});
        
            // Initialize category tracking - ADDED orders array
            const categoryMetrics = state.catalogs.reduce((metrics, cat) => {
                metrics[cat.name] = { totalRevenue: 0, unitsSold: 0, averagePrice: 0, orders: [] };
                return metrics;
            }, {});
            categoryMetrics['Uncategorized'] = { totalRevenue: 0, unitsSold: 0, averagePrice: 0, orders: [] }; // Handle uncategorized items
        
            getFilteredSalesOrders().forEach(order => {
                order.items.forEach(orderItem => {
                    const item = itemMap[orderItem.id];
                    if (item) {
                        const catalogId = item.catalogId || 'no_category';
                        const categoryName = state.catalogs.find(c => c.id === catalogId)?.name || 'Uncategorized';
                        
                        const salesAmount = orderItem.price * orderItem.quantity;
        
                        categoryMetrics[categoryName].totalRevenue += salesAmount; // Total revenue in CENTS
                        categoryMetrics[categoryName].unitsSold += orderItem.quantity;
                        
                        // CRITICAL ADDITION: Store order details relevant to this category
                        // We store the full order data for later display
                        categoryMetrics[categoryName].orders.push({
                            id: order.id.substring(0, 5),
                            fullId: order.id,
                            date: order.createdAt,
                            status: order.status,
                            paymentStatus: order.isPaid ? 'Paid' : 'Unpaid',
                            itemName: orderItem.name,
                            quantity: orderItem.quantity,
                            totalItemCents: orderItem.price * orderItem.quantity,
                        });
                    }
                });
            });
        
            // Finalize data structure for charts and the new table
            const chartData = { labels: [], data: [] };
            const tableData = [];
        
            Object.keys(categoryMetrics).forEach(categoryName => {
                const metrics = categoryMetrics[categoryName];
                if (metrics.totalRevenue > 0) {
                    
                    // For the CHART: Must use dollar value (cents / 100)
                    const revenueDollars = metrics.totalRevenue / 100;
                    chartData.labels.push(categoryName);
                    chartData.data.push(revenueDollars); 
        
                    // For the TABLE: Store values as CENTS (integer) for consistency with formatPriceDisplay
                    const totalRevenueCents = metrics.totalRevenue; // <<< FIX 1: Store CENTS
                    const averagePriceCents = totalRevenueCents / metrics.unitsSold; // Avg price in CENTS per unit
        
                    tableData.push({
                        category: categoryName,
                        totalRevenueCents: totalRevenueCents, // <<< NEW PROPERTY NAME (CENTS)
                        unitsSold: metrics.unitsSold,
                        averagePriceCents: averagePriceCents, // <<< NEW PROPERTY NAME (CENTS)
                        // CRITICAL ADDITION: Pass the filtered orders for this category
                        rawOrders: metrics.orders.sort((a, b) => new Date(b.date) - new Date(a.date)) 
                    });
                }
            });
        
            return {
                chartData: chartData,
                tableData: tableData.sort((a, b) => b.totalRevenueCents - a.totalRevenueCents), // Sort by cents descending
            };
        }
// --- NEW HELPER FUNCTIONS FOR DRAFT CART MANAGEMENT (Add around line 1300) ---
        function initializeDraftCart(orderItems) {
            state.editingOrderDraftCart = {};
            orderItems.forEach(orderItem => {
                // Find the full product details from the global item list
                const fullItem = state.items.find(i => i.id === orderItem.id);
                if (fullItem) {
                    state.editingOrderDraftCart[orderItem.id] = {
                        item: fullItem,
                        quantity: orderItem.quantity,
                    };
                } else {
                    // Handle deleted or missing item gracefully by using its name/price from the order
                    state.editingOrderDraftCart[orderItem.id] = {
                        item: { 
                            id: orderItem.id, 
                            name: orderItem.name || 'DELETED PRODUCT', 
                            price: orderItem.price || 0,
                            sku: orderItem.sku || 'N/A'
                        },
                        quantity: orderItem.quantity,
                    };
                }
            });
        }
        
        // Re-use the updateAdminCartDisplay logic, renamed for the modal
        function updateDraftCartDisplay() {
            const cartEl = document.getElementById('editOrderItemsDisplay');
            const totalEl = document.getElementById('editOrderTotal');
            let totalCents = 0;
        
            if (!cartEl || !totalEl) return;
        
            const itemsInCart = Object.values(state.editingOrderDraftCart);
        
            if (itemsInCart.length === 0) {
                cartEl.innerHTML = '<p class="text-gray-500 italic">No items currently in order.</p>';
                totalEl.textContent = formatPriceDisplay(0);
                return;
            }
        
            const cartHtml = itemsInCart.map(entry => {
                const subtotal = entry.item.price * entry.quantity;
                totalCents += subtotal;
        
                return `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                        <div class="flex-1 min-w-0 pr-2">
                            <p class="text-sm font-semibold text-gray-900 truncate">${entry.item.name}</p>
                            <p class="text-xs text-gray-500">${formatPriceDisplay(entry.item.price)}</p>
                        </div>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <input type="number" data-item-id="${entry.item.id}" value="${entry.quantity}" min="1" 
                                   onchange="window.module.updateDraftItemQuantity(this.value, '${entry.item.id}')"
                                   class="w-16 p-1 border rounded text-sm text-center">
                            <span class="text-sm font-bold text-pink-700">${formatPriceDisplay(subtotal)}</span>
                            <button type="button" onclick="window.module.removeDraftCartItem('${entry.item.id}')" 
                                    class="text-red-500 hover:text-red-700 text-sm font-semibold ml-2" title="Remove Item">❌</button>
                        </div>
                    </div>
                `;
            }).join('');
        
            cartEl.innerHTML = cartHtml;
            totalEl.textContent = formatPriceDisplay(totalCents);
        }

        function handleDeliveryFilterChange(e) {
            state.deliveryStatusFilter = e.target.value;
            renderOrdersList();
            resetTimer();
        }
                
        // Function to add a NEW item to the draft cart
        function addDraftCartItem() {
            const selector = document.getElementById('editItemSelector');
            const quantityEl = document.getElementById('editItemQuantity');
        
            if (!selector || !quantityEl) return;
        
            const itemId = selector.value;
            const quantity = parseInt(quantityEl.value, 10);
        
            if (!itemId || quantity <= 0) {
                showMessage('error', 'Please select a product and quantity to add.', 2000, 'orders');
                return;
            }
        
            const item = state.items.find(i => i.id === itemId);
            if (!item) return;
        
            state.editingOrderDraftCart = {
                ...state.editingOrderDraftCart,
                [itemId]: {
                    item,
                    quantity: (state.editingOrderDraftCart[itemId]?.quantity || 0) + quantity
                }
            };
            
            // Reset inputs
            quantityEl.value = 1; 
            selector.value = '';
        
            showMessage('success', `Added ${quantity}x ${item.name} to the order draft.`, 2000, 'orders');
            updateDraftCartDisplay();
        }
        
        // Function to remove an item from the draft cart
        function removeDraftCartItem(itemId) {
            const currentEntry = state.editingOrderDraftCart[itemId];
            if (!currentEntry) return;
        
            const newCart = { ...state.editingOrderDraftCart };
            delete newCart[itemId];
            state.editingOrderDraftCart = newCart;
        
            showMessage('info', `${currentEntry.item.name} removed from order draft.`, 2000, 'orders');
            updateDraftCartDisplay();
        }
        
        // Function to update the quantity of an item in the draft cart
        function updateDraftItemQuantity(quantityString, itemId) {
            const quantity = parseInt(quantityString, 10);
            const currentEntry = state.editingOrderDraftCart[itemId];
            
            if (!currentEntry) return;
            
            if (quantity <= 0) {
                removeDraftCartItem(itemId);
            } else {
                state.editingOrderDraftCart = {
                    ...state.editingOrderDraftCart,
                    [itemId]: {
                        ...currentEntry,
                        quantity: quantity
                    }
                };
                updateDraftCartDisplay();
            }
        }
        
        function processSalesDataByMonth() {
            const filteredOrders = getFilteredSalesOrders();
            const monthlySales = {};
        
            filteredOrders.forEach(order => {
                const dateObj = (order.createdAt instanceof Date) ? order.createdAt : new Date(order.timestamp);
                // Creates a key like "2025-11" for grouping
                const yearMonth = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
        
                if (!monthlySales[yearMonth]) {
                    monthlySales[yearMonth] = 0;
                }
                monthlySales[yearMonth] += order.totalCents;
            });
        
            const sortedKeys = Object.keys(monthlySales).sort();
            const monthNames = sortedKeys.map(key => {
                const [year, month] = key.split('-');
                const date = new Date(year, parseInt(month) - 1);
                return date.toLocaleString('default', { month: 'short', year: 'numeric' }); 
            });
        
            return {
                labels: monthNames,
                // Data is converted from cents to dollars for Chart.js display
                data: sortedKeys.map(key => monthlySales[key] / 100), 
            };
        }
        function getFilteredSalesOrders() {
            let filteredOrders = state.orders.filter(o => o.status !== 'Cancelled');
            const now = new Date();
            let cutoffDate = null;
        
            switch (state.salesTimeFilter) {
                case 'lastmonth':
                    // Creates a date roughly 30 days ago
                    cutoffDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                    break;
                case 'last6months':
                    // Creates a date 6 months ago
                    cutoffDate = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
                    break;
                case 'lastyear':
                    // Creates a date 1 year ago
                    cutoffDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                    break;
                case 'all':
                default:
                    return filteredOrders;
            }
        
            return filteredOrders.filter(order => {
                // Uses the pre-converted Date object (from the Firestore listener)
                const orderDate = (order.createdAt instanceof Date) ? order.createdAt : new Date(order.timestamp);
                return orderDate >= cutoffDate;
            });
        }
        // Located around line 430 in your current setup
        function renderSalesCharts() {
            // 1. Destroy existing charts before rendering new ones
            destroyCharts(); // This function clears salesCharts.category and salesCharts.month
            
            // 2. Process data and STORE THE RESULT GLOBALLY
            // NOTE: categoryResult contains { chartData: {labels, data}, tableData: [...] }
            const categoryResult = processSalesDataByCategory(); 
            lastCategorySalesData = categoryResult; // Store the processed data for CSV download
            const monthlyData = processSalesDataByMonth();
            
            // --- Pie Chart: Sales by Category ---
            const ctxCategory = document.getElementById('salesByCategoryChart');
            if (ctxCategory) {
                salesCharts.category = new Chart(ctxCategory, {
                    type: 'doughnut',
                    data: {
                        labels: categoryResult.chartData.labels,
                        datasets: [{
                            label: 'Sales by Category',
                            data: categoryResult.chartData.data,
                            backgroundColor: ['#6366f1', '#f87171', '#34d399', '#facc15', '#a78bfa', '#22d3ee', '#fb7185'],
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 20,
                                bottom: 20,
                                left: 20,
                                right: 20
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                align: 'center',
                                labels: {
                                    boxWidth: 16,
                                    padding: 20,
                                    usePointStyle: true,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            title: {
                                display: true,
                                position: 'top',
                                align: 'center',
                                text: 'Sales by Product Category (Net)',
                                font: { size: 16, weight: 'bold' },
                                padding: { bottom: 20 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (context.parsed !== undefined) {
                                            const value = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            label += `: ${formatPriceDisplay(value * 100)} (${percentage}%)`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // --- Time Chart: Sales per Month ---
            const ctxMonth = document.getElementById('salesPerMonthChart');
            if (ctxMonth) {
                salesCharts.month = new Chart(ctxMonth, {
                    type: 'line',
                    data: {
                        labels: monthlyData.labels,
                        datasets: [{
                            label: 'Monthly Net Sales',
                            data: monthlyData.data,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#8b5cf6',
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Monthly Sales Trends (${state.salesTimeFilter.replace('last', 'Last ')})`,
                                font: { size: 16, weight: 'bold' }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (context.parsed.y !== null) {
                                            label += `: ${formatPriceDisplay(context.parsed.y * 100)}`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Revenue (USD)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatPriceDisplay(value * 100).replace(/\.00$/, '');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        
            // 3. **NEW STEP: Render the Sales Breakdown Table (including the CSV download button)**
            const tableContainer = document.getElementById('categorySalesTableContainer');
            if (tableContainer) {
                tableContainer.innerHTML = window.module.renderCategorySalesTable(categoryResult);
            }
        }
            function handleSalesTimeFilterChange(e) {
                state.salesTimeFilter = e.target.value;
                renderSalesCharts();
                resetTimer();
            }

        function getOrdersStatsHtml() {
            // --- Calculate Sales Data (Net sales excludes cancelled orders) ---
            const totalSales = state.orders.reduce((sum, order) => sum + (order.status !== 'Cancelled' ? order.totalCents : 0), 0);
            const orderCounts = state.orders.reduce((counts, order) => {
                // Ensure accurate counting even if a status property is missing or unexpected
                const status = order.status || 'Unknown';
                counts[status] = (counts[status] || 0) + 1;
                return counts;
            }, {});
            // --- End Sales Data ---
            
            return `
                <div id="ordersStatsSummary" class="grid grid-cols-3 gap-4 text-center">
                    <div class="bg-indigo-50 p-4 rounded-lg">
                        <p class="text-xs font-semibold text-indigo-700">Total Revenue (Net)</p>
                        <p class="text-2xl font-bold text-indigo-900">${formatPriceDisplay(totalSales)}</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-xs font-semibold text-blue-700">Total Orders</p>
                        <p class="text-2xl font-bold text-blue-900">${state.orders.length}</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <p class="text-xs font-semibold text-red-700">Pending Orders</p>
                        <p class="text-2xl font-bold text-red-900">${orderCounts['Pending'] || 0}</p>
                    </div>
                </div>
        
                <div class="mt-6 p-4 bg-white rounded-xl border border-gray-200 shadow-md">
                    <h4 class="font-bold text-lg mb-3">Order Status Breakdown</h4>
                    <ul class="space-y-1 text-sm">
                        <li><span class="font-semibold text-green-600">Delivered:</span> ${orderCounts['Delivered'] || 0}</li>
                        <li><span class="font-semibold text-blue-600">Processing:</span> ${orderCounts['Processing'] || 0}</li>
                        <li><span class="font-semibold text-red-600">Pending:</span> ${orderCounts['Pending'] || 0}</li>
                        <li><span class="font-semibold text-gray-600">Cancelled:</span> ${orderCounts['Cancelled'] || 0}</li>
                        ${orderCounts['Unknown'] ? `<li><span class="font-semibold text-yellow-600">Unknown:</span> ${orderCounts['Unknown']}</li>` : ''}
                    </ul>
                </div>
                
                <div id="salesChartsControls" class="mt-8 pt-4 border-t border-gray-200 flex justify-end items-center space-x-4">
                    <label class="font-semibold text-gray-700 text-sm">Sales Filter:</label>
                    <select onchange="window.module.handleSalesTimeFilterChange(event)" class="p-2 border rounded-lg text-sm bg-gray-50">
                        <option value="all" ${state.salesTimeFilter === 'all' ? 'selected' : ''}>All Time</option>
                        <option value="lastmonth" ${state.salesTimeFilter === 'lastmonth' ? 'selected' : ''}>Last Month</option>
                        <option value="last6months" ${state.salesTimeFilter === 'last6months' ? 'selected' : ''}>Last 6 Months</option>
                        <option value="lastyear" ${state.salesTimeFilter === 'lastyear' ? 'selected' : ''}>Last Year</option>
                    </select>
                </div>
                <div id="salesChartsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <div style="height: 350px;">
                            <canvas id="salesByCategoryChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <div style="height: 350px;">
                            <canvas id="salesPerMonthChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div id="categorySalesTableContainer">
                    </div>
        
                `;
        }
        
        function destroyCharts() {
            if (salesCharts.category) {
                salesCharts.category.destroy();
                salesCharts.category = null; // Clear reference
            }
            if (salesCharts.month) {
                salesCharts.month.destroy();
                salesCharts.month = null; // Clear reference
            }
        }
        
        function getOrdersCollectionPath(targetIdOrIndicator) { 
            // Get the application ID (or use default)
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            // 1. Check for Admin Email or Admin-Created Order Indicator
            // Orders created by adminCreateOrder.js are stored in the public path.
            if (targetIdOrIndicator.includes('@autoinx.com') || targetIdOrIndicator === 'ADMIN_ORDER_SOURCE') {
                // Use the public order collection path: /artifacts/{appId}/public/data/orders
                return `artifacts/${appId}/public/data/orders`; 
            }
        
            // 2. Default to Client Order Path: /artifacts/{appId}/users/{userId}/orders
            // This is for regular user checkouts.
            return `artifacts/${appId}/users/${targetIdOrIndicator}/orders`; 
        }
    
        function resetTimer() {
            clearTimeout(idleTimer);
            if (auth?.currentUser && !auth.currentUser.isAnonymous) {
                idleTimer = setTimeout(autoLogout, IDLE_TIMEOUT_MS);
            }
        }

        function waitForUserId(timeout = 5000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                
                const check = () => {
                    // Check the GLOBAL variable 'userId' directly
                    if (userId) { 
                        resolve(userId); // Resolve with the UID string
                    } else if (Date.now() - startTime >= timeout) {
                        reject(new Error("Timeout waiting for Admin user ID."));
                    } else {
                        // Check again in 100 milliseconds
                        setTimeout(check, 100); 
                    }
                };
        
                check();
            });
        } 
        
        // --- AUTHENTICATION CHECK & REDIRECT ---
        function checkAuthAndRender() {
            onAuthStateChanged(auth, user => {
                if (user && !user.isAnonymous) {
                    // User is signed in, now check admin claims
                    user.getIdTokenResult(true).then(idTokenResult => {
                        if (idTokenResult.claims.admin === true) {
                            
                            // 1. SET THE GLOBAL userId VARIABLE FIRST
                            userId = user.uid;
        
                            // 2. Start session/activity tracking
                            document.onmousemove = document.onkeydown = document.onclick = resetTimer;
                            document.addEventListener('touchstart', resetTimer); // Added touch listener
                            resetTimer();
                            
                            // 3. Setup listeners and render the main admin page HTML
                            setupRealtimeListeners();
                            renderAdminPage(user.email || 'Admin');
                            
                            // 4. EXPLICITLY load the orders to guarantee window.module.orders is populated.
                            // This resolves the timing issue you were seeing.
                            if (window.module.fetchOrders) {
                                window.module.fetchOrders();
                            }
        
                        } else {
                            // Not an admin, sign out and redirect
                            signOut(auth);
                            window.location.href = '/?error=unauthorized';
                        }
                    }).catch(err => {
                        // Token verification error
                        console.error("Token error:", err);
                        signOut(auth);
                        window.location.href = '/?error=auth_failed';
                    });
                } else {
                    // User not signed in, redirect to login page
                    window.location.href = '/';
                }
            });
        }
    
        // --- FIRESTORE REALTIME LISTENERS ---
        function setupRealtimeListeners() {
            if (!db) return;
        
            // Listener for Catalogs (Categories)
            onSnapshot(collection(db, CATALOGS_COLLECTION), snap => {
                state.catalogs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (state.activeTab === 'catalog' && !state.previewMode) renderProductListSection();
                if (state.activeTab === 'orders' && !state.previewMode) {
                    updateItemSelector(); 
                    if (state.orderPage === 'list') renderOrdersStats();
                }
            }, err => {
                console.error("Error listening to categories:", err);
                showMessage('error', 'Failed to fetch categories.', 5000, 'catalog');
            });
        
            // Listener for Items (Products)
            onSnapshot(collection(db, ITEMS_COLLECTION), snap => {
                state.items = snap.docs.map(d => {
                    const data = d.data();
                    return { 
                        id: d.id, 
                        ...data,
                        stock: data.stock !== undefined ? data.stock : 0
                    };
                });
                
                if (state.activeTab === 'catalog' && !state.previewMode) renderProductListSection();
                if (state.activeTab === 'orders' && !state.previewMode) {
                    updateItemSelector();
                    updateAdminCartDisplay();
                }
                if (state.activeTab === 'inventory' && !state.previewMode) renderInventorySection();
            }, err => {
                console.error("Error listening to items:", err);
                showMessage('error', 'Failed to fetch items.', 5000, 'catalog');
            });
        
            // NEW LISTENER: Realtime Listener for Orders (Replaces mock data source)
            onSnapshot(collection(db, ORDERS_COLLECTION), snap => {
                // 1. Update the state.orders array with live data
                state.orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
                // 2. If the Orders tab is open, trigger a re-render
                if (state.activeTab === 'orders' && state.orderPage === 'list') {
                    window.module.renderOrdersList(); 
                }
                
                // Clear any loading message
                const ordersMsgElClear = document.getElementById('ordersMessage');
                if (ordersMsgElClear) ordersMsgElClear.textContent = ''; 
        
            }, err => {
                console.error("Error listening to orders:", err);
                showMessage('error', 'Failed to fetch orders in real-time.', 5000, 'orders');
            });
        }
    
        // --- HELPER FUNCTIONS ---
        function formatPriceDisplay(cents) {
            return `$${(cents / 100).toFixed(2)}`;
        }
        
        function handleOrderListSearchInput(e) {
            state.orderListSearchTerm = e.target.value;
            renderOrdersList(); // Re-render the list to show filtered results
            resetTimer();
        }
        
        function formatTime(ts) {
            if (!ts) return 'N/A';
            const date = ts.toDate ? ts.toDate() : new Date(ts);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
    
        function showMessage(type, text, duration = 5000, targetTab) {
            const id = targetTab === 'config' ? 'configMessage' : targetTab === 'orders' ? 'ordersMessage' : targetTab === 'inventory' ? 'inventoryMessage' : 'catalogMessage';
            const el = document.getElementById(id);
            if (!el) return;
            el.className = `mt-4 text-center text-sm font-medium ${type === 'success' ? 'text-green-600' : 'text-red-600'} ${type === 'info' ? 'text-blue-600' : ''}`;
            el.textContent = text;
            setTimeout(() => el.textContent = '', duration);
        }
    
        async function logAdminAction(actionType, details, objectId = null) {
            try {
                await fetch(LOG_ACTION_FUNCTION, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        actionType,
                        details,
                        performedByEmail: auth.currentUser?.email || 'Unknown',
                        objectId
                    })
                });
            } catch (e) { console.error("Log failed:", e); }
        }
    
        function generateUniqueSku() {
            const t = Date.now().toString(36).toUpperCase();
            const r = Math.random().toString(36).substring(2, 4).toUpperCase();
            return `AX-${t}${r}`;
        }
    
        function getFilteredItems() {
            if (!state.searchTerm) return state.items;
            const term = state.searchTerm.toLowerCase();
            return state.items.filter(item => {
                const catName = state.catalogs.find(c => c.id === item.catalogId)?.name || 'Uncategorized';
                return item.name.toLowerCase().includes(term) ||
                                     item.description.toLowerCase().includes(term) ||
                                     catName.toLowerCase().includes(term) ||
                                     (item.sku && item.sku.toLowerCase().includes(term));
            });
        }
    
        // --- USER LIST UTILITIES ---
        function getFilteredAuthUsers() {
            if (!state.userSearchTerm) return state.allUsers;
            const term = state.userSearchTerm.toLowerCase();
            return state.allUsers.filter(user => {
                // Handles anonymous users where email might be null
                const userEmail = user.email || (user.uid.slice(0, 8) + '... (Anonymous)'); 
                
                const uidMatch = user.uid.toLowerCase().includes(term);
                const emailMatch = userEmail.toLowerCase().includes(term);
                const nameMatch = user.displayName && user.displayName.toLowerCase().includes(term);
                return uidMatch || emailMatch || nameMatch;
            });
        }
    
        function handleUserSearchInput(e) {
            state.userSearchTerm = e.target.value;
            renderUserList(); // Call the rendering function immediately
            resetTimer();
        }
    
        // --- BULK SELECTION LOGIC (NEW) ---
    
        function toggleUserSelection(uid) {
            const index = state.selectedUsers.indexOf(uid);
            if (index > -1) {
                state.selectedUsers.splice(index, 1);
            } else {
                state.selectedUsers.push(uid);
            }
            document.getElementById('selectedUserCount').textContent = state.selectedUsers.length;
            document.getElementById('bulkActionButton').disabled = state.selectedUsers.length === 0;
        }
    
        function toggleAllUsers(checked) {
            const grid = document.getElementById('usersGrid');
            // Select only visible users based on current search filter
            const visibleUsers = getFilteredAuthUsers();
            
            state.selectedUsers = [];
            if (checked) {
                // Collect UIDs from currently filtered users
                visibleUsers.forEach(user => {
                    state.selectedUsers.push(user.uid);
                });
            }
            
            // Update all rendered checkboxes to reflect the new state.
            const checkboxes = grid.querySelectorAll('input[type="checkbox"][data-uid]');
            checkboxes.forEach(cb => {
                const uid = cb.dataset.uid;
                cb.checked = state.selectedUsers.includes(uid);
            });
            
            document.getElementById('selectedUserCount').textContent = state.selectedUsers.length;
            document.getElementById('bulkActionButton').disabled = state.selectedUsers.length === 0;
        }
    
        // --- UI ACTIONS ---
        function togglePreviewMode(enable) {
            state.previewMode = enable;
            renderAdminPage(auth.currentUser?.email || 'Admin');
            resetTimer();
        }
    
        function switchAdminTab(tab) {
            state.activeTab = tab;
            state.editingItem = null;
            state.previewMode = false;
            renderAdminPage(auth.currentUser?.email || 'Admin');
            resetTimer();
        
            if (tab === 'config') {
                window.module.fetchAdminConfig();
                window.module.displayStaticIps();
            } else if (tab === 'users') {
                // Clear old data but keep headers before fetching new page. 
                const grid = document.getElementById('usersGrid');
                // The grid header now contains 8 elements (including the master checkbox)
                if (grid) Array.from(grid.children).slice(8).forEach(el => el.remove()); 
                window.module.fetchUsers(null);
                state.selectedUsers = []; // Clear selection when switching tab
            } else if (tab === 'orders') {
                state.orderPage = 'list'; // Default to list view
                window.module.fetchOrders(); // Fetch initial orders
                window.module.updateAdminCartDisplay(); // For the Create Order sub-view
                window.module.updateItemSelector(); // For the Create Order sub-view
                // CRITICAL FIX: Load Maps script only when the orders tab is rendered
                if (typeof google === 'undefined' || !autocomplete) {
                    window.module.loadGoogleMapsScript();
                } else {
                    // Re-initialize the autocomplete object and set up listeners for the new input field
                    window.initGooglePlaces();
                }
            } else if (tab === 'inventory') { // NEW: Inventory tab initialization
                 window.module.renderInventorySection();
            }
        }
    
        function switchOrderPage(page) {
            state.orderPage = page;
            renderAdminPage(auth.currentUser?.email || 'Admin');
            
            if (page === 'create') {
                window.module.updateAdminCartDisplay();
                window.module.updateItemSelector();
                // Ensure Google Maps script is initialized for the address validation
                if (typeof google === 'undefined' || !autocomplete) {
                    window.module.loadGoogleMapsScript();
                } else {
                    window.initGooglePlaces();
                }
            } else if (page === 'list') {
                window.module.fetchOrders();
            }
            resetTimer();
        }
    
        function handleSearchInput(e) {
            state.searchTerm = e.target.value;
            renderProductListSection();
            resetTimer();
        }
    
        function showEditForm(item) {
            state.editingItem = item;
            renderAdminPage(auth.currentUser?.email || 'Admin');
            resetTimer();
        }
    
        function cancelEdit() {
            state.editingItem = null;
            renderAdminPage(auth.currentUser?.email || 'Admin');
            resetTimer();
        }
    
        // --- CATEGORY & PRODUCT CRUD ---
    
        // Implemented Add Product
        async function handleAddProduct(e) {
            e.preventDefault();
            resetTimer();
    
            const form = e.target;
            const itemName = form.itemName.value.trim();
            const itemDescription = form.itemDescription.value.trim();
            const price = form.itemPrice.value;
            const catalogId = form.catalogId.value;
            let itemImageUrl = form.itemImageUrl.value.trim();
            // New: Initial Stock
            const initialStock = parseInt(form.initialStock.value, 10) || 0; 
    
            if (!itemName || !itemDescription || !price || !catalogId) {
                showMessage('error', 'Please fill in all required product fields.', 5000, 'catalog');
                return;
            }
    
            try {
                // Use default placeholder if no URL is provided
                if (!itemImageUrl) {
                    itemImageUrl = `https://placehold.co/400x300/a3a3a3/ffffff?text=${encodeURIComponent(itemName)}`;
                }
    
                // Convert price to cents (integer storage is preferred for currency)
                const priceCents = Math.round(parseFloat(price) * 100);
    
                const newProduct = {
                    name: itemName,
                    description: itemDescription,
                    price: priceCents,
                    catalogId: catalogId,
                    imageUrl: itemImageUrl,
                    sku: generateUniqueSku(),
                    stock: initialStock, // Include stock
                    createdAt: serverTimestamp(),
                };
    
                const docRef = await addDoc(collection(db, ITEMS_COLLECTION), newProduct);
    
                await logAdminAction('ITEM_CREATED', newProduct, docRef.id);
                showMessage('success', `Product "${itemName}" added successfully!`, 5000, 'catalog');
                form.reset();
    
            } catch (error) {
                console.error('Error adding product:', error);
                showMessage('error', `Failed to add product: ${error.message}`, 5000, 'catalog');
            }
        }
    
        // Implemented Add Category
        async function handleAddCatalog(e) {
             e.preventDefault();
             resetTimer();
    
             const form = e.target;
             const categoryName = form.catalogName.value.trim();
    
             if (!categoryName) {
                 showMessage('error', 'Category name cannot be empty.', 5000, 'catalog');
                 return;
             }
    
             try {
                 const newCategory = {
                     name: categoryName,
                     createdAt: serverTimestamp(),
                 };
                 
                 const docRef = await addDoc(collection(db, CATALOGS_COLLECTION), newCategory);
    
                 await logAdminAction('CATEGORY_CREATED', newCategory, docRef.id);
                 showMessage('success', `Category "${categoryName}" added successfully!`, 5000, 'catalog');
                 form.reset();
    
             } catch (error) {
                 console.error('Error adding category:', error);
                 showMessage('error', `Failed to add category: ${error.message}`, 5000, 'catalog');
             }
        }
    
        // Placeholder for Delete Category
        function handleDeleteCatalog(id, name) {
            if (!confirm(`Are you sure you want to delete category: ${name}?`)) return;
            showMessage('error', `Deleting category ${name} is not implemented in this version.`, 5000, 'catalog');
            resetTimer();
        }
    
        // Placeholder for Delete Product
        function handleDeleteProduct(id, name) {
            if (!confirm(`Are you sure you want to delete product: ${name}?`)) return;
            showMessage('error', `Deleting product ${name} is not implemented in this version.`, 5000, 'catalog');
            resetTimer();
        }
        
        // Placeholder for Edit Product
        function handleEditProduct(e) {
            e.preventDefault();
            showMessage('info', 'Product editing not implemented in this version.', 5000, 'catalog');
            cancelEdit();
            resetTimer();
        }
    
        // --- INVENTORY MANAGEMENT FUNCTIONS (NEW) ---
    
        async function handleUpdateStock(e, itemId) {
            e.preventDefault();
            resetTimer();
            
            const form = e.target;
            const newStockValue = parseInt(form.stockAdjustment.value, 10);
            const actionType = form.stockAction.value;
            
            if (isNaN(newStockValue) || newStockValue <= 0) {
                showMessage('error', 'Please enter a valid, positive adjustment amount.', 5000, 'inventory');
                return;
            }
    
            const item = state.items.find(i => i.id === itemId);
            if (!item) {
                showMessage('error', 'Item not found.', 5000, 'inventory');
                return;
            }
    
            let newStock;
            if (actionType === 'add') {
                newStock = item.stock + newStockValue;
            } else if (actionType === 'remove') {
                newStock = item.stock - newStockValue;
                if (newStock < 0) newStock = 0; // Prevent negative stock
            } else {
                showMessage('error', 'Invalid stock action.', 5000, 'inventory');
                return;
            }
            
            try {
                const itemRef = doc(db, ITEMS_COLLECTION, itemId);
                await updateDoc(itemRef, { stock: newStock });
                
                await logAdminAction('INVENTORY_UPDATED', { 
                    itemId, 
                    item: item.name, 
                    action: actionType, 
                    amount: newStockValue, 
                    oldStock: item.stock, 
                    newStock 
                }, itemId);
                
                showMessage('success', `${item.name} stock updated successfully to ${newStock}.`, 5000, 'inventory');
                form.reset();
                // Realtime listener handles UI update
            } catch (error) {
                console.error('Error updating stock:', error);
                showMessage('error', `Failed to update stock: ${error.message}`, 5000, 'inventory');
            }
        }
        
        function showPurchaseOrderForm(itemId, itemName) {
            // Placeholder function for the 'Order More' button
            showMessage('info', `Simulating creation of Purchase Order for ${itemName} (${itemId}). (Not Implemented)`, 5000, 'inventory');
        }
        
        // --- USER MANAGEMENT (MODIFIED for Bulk) ---
        
        async function handleBulkUserAction() {
            resetTimer();
            
            const bulkActionSelect = document.getElementById('bulkActionSelect');
            const action = bulkActionSelect.value;
            const selectedUsers = state.selectedUsers;
            
            if (selectedUsers.length === 0 || !action) {
                return showMessage('error', 'Please select users and an action.', 5000, 'users');
            }
        
            const usersToProcess = state.allUsers.filter(u => selectedUsers.includes(u.uid));
            
            let confirmationMessage = '';
            let actionData = {};
        
            // 1. Determine action and confirmation message
            if (action === 'delete') {
                confirmationMessage = `WARNING: Are you sure you want to PERMANENTLY delete ${selectedUsers.length} selected users? This is irreversible!`;
            } else if (action === 'update') {
                const selectedOption = bulkActionSelect.options[bulkActionSelect.selectedIndex];
                try {
                    actionData = JSON.parse(selectedOption.dataset.update || '{}');
                } catch (e) {
                    return showMessage('error', 'Invalid update data selected.', 5000, 'users');
                }
                const stateWord = actionData.disabled ? 'disable' : 'enable';
                confirmationMessage = `Are you sure you want to ${stateWord} ${selectedUsers.length} selected user accounts?`;
            } else {
                // We exclude 'resetPassword' from bulk actions as it requires sending an email per user, 
                // which should generally be done individually or requires separate batching logic.
                return showMessage('error', 'Unsupported bulk action selected.', 5000, 'users');
            }
        
            if (!confirm(confirmationMessage)) {
                return;
            }
        
            // 2. Execute actions sequentially to ensure stability and proper logging
            const results = { success: 0, failed: 0 };
            const total = usersToProcess.length;
        
            // Use a modal/message to show progress during a long bulk operation
            showMessage('info', `Processing ${total} users... Please wait.`, 0, 'users');
            
            for (const user of usersToProcess) {
                let successMsg = '';
                const data = (action === 'update') ? actionData : {};
                
                if (action === 'delete') {
                    successMsg = `User ${user.email || user.uid} deleted.`;
                } else if (action === 'update') {
                    successMsg = `User ${user.email || user.uid} ${data.disabled ? 'disabled' : 'enabled'}.`;
                }
        
                try {
                    // suppressRefresh: true is critical here to prevent re-fetching the entire list after every single user update
                    await window.module.handleUserAction(action, user.uid, data, successMsg, true);
                    results.success++;
                } catch (e) {
                    results.failed++;
                }
            }
        
            // 3. Final cleanup and feedback
            if (results.failed === 0) {
                showMessage('success', `Bulk action complete! ${results.success} user(s) processed successfully.`, 8000, 'users');
            } else {
                showMessage('error', `Bulk action finished with ${results.failed} failure(s) out of ${total} users. Check console for details.`, 10000, 'users');
            }
        
            // Clear selection state and reload the entire list to reflect all changes
            state.selectedUsers = [];
            window.module.fetchUsers(null); 
        }

        // MODIFIED: Central function to execute actions against a user via Netlify function
        async function handleUserAction(action, uid, data = {}, successMsg, suppressRefresh = false) {
            resetTimer();
        
            if (action !== 'resetPassword' && !confirm(`Are you sure you want to perform the action: ${action} on user ${uid}?`)) {
                throw new Error('Action cancelled by user.');
            }
        
            try {
                const idToken = await auth.currentUser.getIdToken();
                
                const payload = { 
                    action, 
                    uid, 
                    data 
                };
        
                const res = await fetch(MANAGE_USER_FUNCTION, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
        
                if (!res.ok) {
                    const errorDetails = await res.json();
                    throw new Error(errorDetails.details || errorDetails.error || res.statusText);
                }
                
                // Log the successful action
                await logAdminAction(action.toUpperCase() + '_USER', { uid, details: data }, uid);
        
                showMessage('success', successMsg, 5000, 'users');
        
                if (!suppressRefresh) {
                    // After successful individual action, fetch users from the start
                    // This is safer than just updating local state for complex changes.
                    window.module.fetchUsers(null); 
                }
        
                return await res.json(); // Return data (e.g., reset link)
                
            } catch (error) {
                console.error(`User Action (${action}) failed for ${uid}:`, error);
                showMessage('error', `Action failed: ${error.message}`, 8000, 'users');
                throw error; // Re-throw the error for other handlers (like bulk) to catch
            }
        }
    
    
        // UPDATED: Function to send a password reset email
        function promptForPasswordReset(uid, email) {
            if (!confirm(`Are you sure you want to send a password reset link to ${email}?`)) {
                return;
            }
            handleUserAction(
                'resetPassword', 
                uid, 
                { email }, 
                `Password reset link sent to ${email} (via server).`,
                true // Suppress refresh since this doesn't change user list data
            );
        }
        
        // UPDATED: Function to delete a user
        function deleteUser(uid, email) {
            if (!confirm(`WARNING: Are you sure you want to PERMANENTLY delete user: ${email}? This is irreversible!`)) {
                return;
            }
            handleUserAction(
                'delete', 
                uid, 
                {}, 
                `User ${email} deleted successfully.`
            );
        }
        
        // UPDATED: Function to disable/enable a user account
        function disableUser(uid, email, currentlyDisabled) {
            const action = currentlyDisabled ? 'enable' : 'disable';
            const data = { disabled: !currentlyDisabled };
            
            if (!confirm(`Are you sure you want to ${action} user account for: ${email}?`)) {
                return;
            }
            
            handleUserAction(
                'update', 
                uid, 
                data, 
                `User ${email} account ${action}d successfully.`
            );
        }
        
        async function handleClearAnonymousUsers() {
            if (!confirm("Are you sure you want to delete ALL anonymous users? This process is irreversible and may take time for large databases.")) {
                return;
            }
    
            const msgEl = document.getElementById('clearAnonButtonConfig') || document.getElementById('clearAnonButton');
            if (!msgEl) return;
            
            const originalText = msgEl.textContent;
            msgEl.textContent = 'Processing...';
            msgEl.disabled = true;
    
            let pageToken = null;
            let totalDeleted = 0;
    
            try {
                const idToken = await auth.currentUser.getIdToken();
    
                do {
                    const payload = { nextPageToken: pageToken };
                    const res = await fetch(CLEAR_ANON_FUNCTION, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${idToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
    
                    if (!res.ok) {
                        const errorDetails = await res.json();
                        throw new Error(errorDetails.details || errorDetails.error || res.statusText);
                    }
    
                    const data = await res.json();
                    
                    totalDeleted += data.deletedCount || 0;
                    pageToken = data.nextPageToken;
    
                    if (pageToken) {
                        msgEl.textContent = `Processing batch... (${totalDeleted} deleted)`;
                    } else {
                        showMessage('success', `Cleanup complete! Total anonymous users deleted: ${totalDeleted}.`, 8000, 'config');
                        break; // Exit loop if no token is returned
                    }
    
                } while (pageToken);
    
                await logAdminAction('CLEANUP_ANON_USERS', { totalDeleted });
                if (state.activeTab === 'users') window.module.fetchUsers(null); // Refresh user list
    
            } catch (error) {
                console.error('Anonymous user cleanup failed:', error);
                showMessage('error', `Cleanup failed: ${error.message}. Check Netlify logs.`, 8000, 'config');
            } finally {
                msgEl.textContent = originalText;
                msgEl.disabled = false;
            }
        }
        
        // --- ADMIN ORDER CREATION IMPLEMENTATION (FIXED) ---
        
        // NEW: Filtering logic specifically for the Orders tab's selector
        function getItemsForOrderSelector() {
            if (!state.orderSearchTerm) return state.items;
            
            const term = state.orderSearchTerm.toLowerCase();
            
            return state.items.filter(item => {
                const catName = state.catalogs.find(c => c.id === item.catalogId)?.name || 'Uncategorized';
                return item.name.toLowerCase().includes(term) ||
                              (item.sku && item.sku.toLowerCase().includes(term)) ||
                              catName.toLowerCase().includes(term);
            });
        }
    
        // NEW: Handler for the search input in the Orders tab
        function handleOrderSearchInput(e) {
            state.orderSearchTerm = e.target.value;
            updateItemSelector(); // Rerender the item selector based on search
            resetTimer();
        }
    
        // IMPLEMENTED: Adds the selected item/quantity to the adminCart state
        function addAdminCartItem() {
            const selector = document.getElementById('itemSelector');
            const quantityEl = document.getElementById('itemQuantity');
            
            if (!selector || !quantityEl) return;
            
            const itemId = selector.value;
            const quantity = parseInt(quantityEl.value, 10);
            
            if (!itemId || quantity <= 0) {
                showMessage('error', 'Please select a product and quantity.', 3000, 'orders');
                return;
            }
    
            const item = state.items.find(i => i.id === itemId);
            if (!item) return;
    
            state.adminCart = {
                ...state.adminCart,
                [itemId]: { 
                    item, 
                    quantity: (state.adminCart[itemId]?.quantity || 0) + quantity 
                }
            };
            
            showMessage('success', `Added ${quantity}x ${item.name} to the order cart.`, 2000, 'orders');
            quantityEl.value = 1; // Reset quantity input
            updateAdminCartDisplay();
        }
    
        // IMPLEMENTED: Removes item completely or updates quantity by -1
        function removeAdminCartItem(itemId) {
            const currentEntry = state.adminCart[itemId];
            if (!currentEntry) return;
    
            const newCart = { ...state.adminCart };
            delete newCart[itemId];
            state.adminCart = newCart;
    
            showMessage('info', `${currentEntry.item.name} removed from order cart.`, 2000, 'orders');
            updateAdminCartDisplay();
        }
    
        // IMPLEMENTED: Renders the order cart display
        function updateAdminCartDisplay() {
            const cartEl = document.getElementById('adminCartDisplay');
            const totalEl = document.getElementById('adminCartTotal');
            let totalCents = 0;
    
            if (!cartEl || !totalEl) return;
    
            const itemsInCart = Object.values(state.adminCart);
            
            if (itemsInCart.length === 0) {
                cartEl.innerHTML = '<p class="text-gray-500 italic">No items added to the order yet. Start searching above!</p>';
                totalEl.textContent = formatPriceDisplay(0);
                updateSubmitButtonState();
                return;
            }
    
            const cartHtml = itemsInCart.map(entry => {
                const subtotal = entry.item.price * entry.quantity;
                totalCents += subtotal;
                
                return `
                    <div class="flex justify-between items-center border-b pb-2">
                        <div class="flex-1 min-w-0 pr-2">
                            <p class="text-sm font-semibold text-gray-900 truncate">${entry.item.name}</p>
                            <p class="text-xs text-gray-500">${entry.quantity} x ${formatPriceDisplay(entry.item.price)}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-bold text-pink-700 flex-shrink-0">${formatPriceDisplay(subtotal)}</span>
                            <button onclick="window.module.removeAdminCartItem('${entry.item.id}')" class="text-red-500 hover:text-red-700 text-sm font-semibold">❌</button>
                        </div>
                    </div>
                `;
            }).join('');
    
            cartEl.innerHTML = cartHtml;
            totalEl.textContent = formatPriceDisplay(totalCents);
            updateSubmitButtonState();
        }
    
        // NEW: Renders the item selector dropdown with search results
        function updateItemSelector() {
            const selectorEl = document.getElementById('itemSelector');
            if (!selectorEl) return;
            
            const items = getItemsForOrderSelector();
            
            // Default option
            let optionsHtml = '<option value="" disabled selected>-- Select Product or Search --</option>';
            
            if (items.length > 0) {
                optionsHtml += items.map(item => {
                    const cat = state.catalogs.find(c => c.id === item.catalogId)?.name || 'Uncategorized';
                    return `<option value="${item.id}">${item.name} (${cat}) - ${formatPriceDisplay(item.price)}</option>`;
                }).join('');
            } else if (state.orderSearchTerm) {
                optionsHtml += `<option value="" disabled>No results found for "${state.orderSearchTerm}"</option>`;
            } else {
                 // Initial state when items are loaded and no search is performed
                 optionsHtml += state.items.map(item => {
                    const cat = state.catalogs.find(c => c.id === item.catalogId)?.name || 'Uncategorized';
                    return `<option value="${item.id}">${item.name} (${cat}) - ${formatPriceDisplay(item.price)}</option>`;
                }).join('');
            }
            
            selectorEl.innerHTML = optionsHtml;
        }
    
        // UPDATED Order submission function with email call
        async function handleAdminOrderSubmit(e) {
            e.preventDefault();
            resetTimer();
        
            const form = document.getElementById('createOrderForm');
            const deliveryAddress = document.getElementById('deliveryAddress');
            const submitButton = document.getElementById('submitOrderButton');
        
            // 1. Get and Validate Form Data (Including Language)
            const buyerName = form.buyerName.value.trim();
            const buyerEmail = form.buyerEmail.value.trim();
            const buyerPhone = form.buyerPhone.value.trim();
            const orderNotes = form.orderNotes.value.trim();
            // NEW: Get the language code from the select input (default to 'en')
            const buyerLanguage = form.buyerLanguage?.value.trim() || 'en'; 
            
            // Derived variables for payload construction
            const email = buyerEmail;
            const name = buyerName;
            const phone = buyerPhone;
            const address = deliveryAddress.value.trim();
            const prefersWhatsapp = false;
            const cartTotalCents = Object.values(state.adminCart).reduce((s, e) => s + e.item.price * e.quantity, 0);
            const userId = auth.currentUser.uid;
            const itemsToOrder = Object.values(state.adminCart);
        
            if (itemsToOrder.length === 0) {
                return showMessage('error', 'The order cart is empty.', 3000, 'orders');
            }
            
            if (deliveryAddress.dataset.validated !== 'true') {
                return showMessage('error', 'Please select a valid delivery address from the dropdown.', 5000, 'orders');
            }
        
            let geolocation = null;
            if (autocomplete && autocomplete.getPlace) {
                const place = autocomplete.getPlace();
                if (place.geometry && place.geometry.location) {
                    geolocation = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
                }
            }
        
            // 2. Prepare Order Data for Submission (ADD LANGUAGE)
            const orderData = {
                buyerEmail: email,
                buyerName: name,
                buyerPhone: phone,
                deliveryAddress: address,
                prefersWhatsapp: prefersWhatsapp,
                items: itemsToOrder.map(e => ({
                    id: e.item.id,
                    name: e.item.name,
                    sku: e.item.sku || null,
                    price: e.item.price,
                    quantity: e.quantity
                })),
                totalCents: cartTotalCents,
                userId: userId,
                timestamp: new Date().toISOString(),
                geolocation: geolocation,
                adminNotes: orderNotes,
                language: buyerLanguage // <<< NEW: Passed to Netlify function
            };
            
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';
        
            try {
                // 3. Submit Order to Remote Cloud Function (Remote Submission FIRST)
                const idToken = await auth.currentUser.getIdToken();
                const res = await fetch(ADMIN_CREATE_ORDER_FUNCTION, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (!res.ok) {
                    const errorDetails = await res.json();
                    throw new Error(errorDetails.details || 'Order creation failed on server.');
                }
                
                const orderCreationResponse = await res.json();
                const finalOrderId = orderCreationResponse.orderId || 'ADMIN_ORDER_ID';
                
                // 4. Process Inventory Updates (Local Firestore Operation - NOW SECOND)
                const inventoryUpdates = itemsToOrder.map(async entry => {
                    const itemId = entry.item.id;
                    const orderQty = entry.quantity;
                    const currentItem = state.items.find(i => i.id === itemId);
                    
                    if (!currentItem) return;
        
                    const newStock = Math.max(0, (currentItem.stock || 0) - orderQty);
                    
                    const itemRef = doc(db, ITEMS_COLLECTION, itemId);
                    await updateDoc(itemRef, { stock: newStock });
        
                    await logAdminAction('INVENTORY_DECREASED', { 
                        itemId, 
                        item: currentItem.name, 
                        action: 'remove', 
                        amount: orderQty, 
                        oldStock: currentItem.stock, 
                        newStock 
                    }, itemId);
                });
                
                await Promise.all(inventoryUpdates);
                
                // 5. Send Confirmation Email (Includes Language)
                const emailPayload = {
                    ...orderData,
                    orderId: finalOrderId,
                    adminEmail: auth.currentUser?.email,
                    requesterEmail: auth.currentUser?.email,
                    language: buyerLanguage // <<< NEW: Passed to email function
                };
                
                await fetch(EMAIL_CONFIRMATION_FUNCTION, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(emailPayload)
                });
                
                // 6. Finalize UI State
                state.adminCart = {};
                form.reset();
                deliveryAddress.dataset.validated = 'false';
                
                showMessage('success', `Order ${finalOrderId} for ${name} successfully created and confirmation emails sent!`, 8000, 'orders');
                
                window.module.fetchOrders();
        
            } catch (error) {
                console.error('Error creating order, updating inventory, or sending emails:', error);
                showMessage('error', `Failed to create order: ${error.message}. Check console for details.`, 10000, 'orders');
            } finally {
                submitButton.textContent = 'SUBMIT ORDER & SEND EMAIL';
                updateAdminCartDisplay();
            }
        }
    
        // --- ORDERS DATA & ACTIONS (NEW) ---
    
        async function fetchOrders() {
            // Show a loading message (the listener will clear it when data arrives)
            const ordersMsgEl = document.getElementById('ordersMessage');
            if (ordersMsgEl) {
                ordersMsgEl.textContent = 'Fetching and listening for orders...';
            }
            
            // The data (state.orders) is automatically updated by the realtime listener 
            // now running in the background. We just ensure the initial render is requested.
            window.module.renderOrdersList();
        }
    
        function getFilteredOrders() {
            // 1. Filter by status (uses existing state property)
            let filteredOrders = state.orders;
            const statusFilter = state.orderStatusFilter;
            const deliveryFilter = state.deliveryStatusFilter; // NEW: Added global state variable for delivery filter
        
            if (statusFilter !== 'All') {
                filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
            }
            
            // NEW: Filter by delivery status
            if (deliveryFilter !== 'All') {
                filteredOrders = filteredOrders.filter(order => {
                    // Note: This logic maps a Delivery Status Filter (Ready, Scheduled, Unscheduled) 
                    // to the core order.status field. Customize this mapping if you have a separate 'deliveryStatus' field in Firestore.
                    
                    if (deliveryFilter === 'Unscheduled') {
                        // Typically orders ready to be processed but not yet picked up/shipped
                        return order.status === 'Pending';
                    }
                    if (deliveryFilter === 'Ready') {
                        // Typically orders actively being packed or waiting for courier pickup
                        return order.status === 'Processing';
                    }
                    if (deliveryFilter === 'Scheduled') {
                        // Orders that are currently en-route or completed delivery
                        return order.status === 'Shipped' || order.status === 'Delivered';
                    }
                    // If none of the specific delivery options match, return true (shouldn't happen if filter is set)
                    return true; 
                });
            }
        
            // 2. Filter by search term
            const term = state.orderListSearchTerm.toLowerCase().trim();
        
            if (!term) return filteredOrders;
        
            return filteredOrders.filter(order => {
                // Search by core properties
                const matchesName = (order.buyerName && order.buyerName.toLowerCase().includes(term));
                const matchesEmail = (order.buyerEmail && order.buyerEmail.toLowerCase().includes(term));
                const matchesAddress = (order.deliveryAddress && order.deliveryAddress.toLowerCase().includes(term));
                // order.orderNumber is often undefined/missing, searching order ID is more reliable
                const matchesOrderNumber = (order.id && order.id.toLowerCase().includes(term)); 
                
                // Search by item SKUs/Names
                const matchesItem = order.items.some(item => 
                    (item.sku && item.sku.toLowerCase().includes(term)) ||
                    (item.name && item.name.toLowerCase().includes(term))
                );
        
                return matchesName || matchesEmail || matchesAddress || matchesOrderNumber || matchesItem;
            });
        }
    
        function handleStatusFilterChange(e) {
            state.orderStatusFilter = e.target.value;
            renderOrdersList();
            resetTimer();
        }
    
        // UPDATED: Makes a direct Firestore update
        async function handleOrderStatusUpdate(orderId, newStatus) {
            if (!confirm(`Are you sure you want to change order ${orderId} status to ${newStatus}?`)) return;
            
            resetTimer();
        
            // The logic in the email function is dynamic, so we trigger for all statuses except Pending/Manually Created
            const requiresNotification = ['Delivered', 'Cancelled', 'Processing'].includes(newStatus);
            let orderDetails = null;
        
            try {
                // 1. Perform Firestore Update
                const orderRef = doc(db, ORDERS_COLLECTION, orderId);
                await updateDoc(orderRef, { status: newStatus });
                
                await logAdminAction('ORDER_STATUS_UPDATE', { orderId, newStatus }, orderId);
        
                // 2. Trigger Email Notification (if required)
                if (requiresNotification) {
                    // Find the order details from the local state
                    orderDetails = state.orders.find(o => o.id === orderId); //
        
                    if (orderDetails) {
                        // --- NEW: Determine the customer's language preference ---
                        const customerLang = orderDetails.language || orderDetails.communicationLang || 'en'; //
                        // -----------------------------------------------------------
                        
                        const emailPayload = {
                            ...orderDetails,
                            orderId: orderId,
                            newStatus: newStatus, 
                            language: customerLang, // <<< NEW: Pass the customer's language preference
                        };
                        
                        // Assuming EMAIL_CONFIRMATION_FUNCTION is defined globally (e.g., '/.netlify/functions/sendOrderConfirmation')
                        const emailNotificationUrl = EMAIL_CONFIRMATION_FUNCTION; 
                        
                        await fetch(emailNotificationUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(emailPayload)
                        });
                        console.log(`Notification email triggered for status: ${newStatus}`);
                    }
                }
        
                // The UI will update automatically via the realtime listener (onSnapshot).
                showMessage('success', `Order ${orderId} status updated to ${newStatus}. Notification sent.`, 5000, 'orders');
        
            } catch (error) {
                console.error('Error updating order status or sending email:', error);
                showMessage('error', `Failed to update status: ${error.message}. Check Firebase Rules.`, 5000, 'orders');
            }
        }
    
        function handleRequestDelivery(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (!order) return;
            
            // --- API Integration Placeholder ---
            showMessage('info', `Requesting delivery for order ${order.orderNumber} to ${order.deliveryAddress}. (API integration needed)`, 8000, 'orders');
            
            // Mock immediate status update to Processing
            handleOrderStatusUpdate(orderId, 'Processing'); 
            resetTimer();
        }
    
        // --- EVENT HANDLER FUNCTIONS (FIXED) ---
        function chatToggleHandler(e) {
            globalConfig.chatWidgetEnabled = e.target.checked;
            resetTimer();
        }
    
        function maintenanceToggleHandler(e) {
            globalConfig.maintenanceMode = e.target.checked;
            resetTimer();
        }
    
        // --- ADMIN CONFIG FUNCTIONS ---
        
        async function fetchAdminConfig() {
            try {
                // 1. Get the Admin User's JWT token
                if (!auth.currentUser) throw new Error("User not authenticated.");
                
                // This forces a refresh if the token is near expiration
                const idToken = await auth.currentUser.getIdToken(true); 
        
                // CRITICAL: Attach the Authorization header for the secure Netlify function
                const res = await fetch(CONFIG_FUNCTION, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}` 
                    }
                });
        
                if (!res.ok) throw new Error('Config fetch failed.');
                const config = await res.json();
                
                // Update global config state (this object now includes the chatSchedule)
                globalConfig = config;
                
                // Update UI elements
                const maintenanceToggle = document.getElementById('maintenanceToggle');
                const chatWidgetToggle = document.getElementById('chatWidgetToggle');
                const dynamicIpList = document.getElementById('dynamicIpList');
        
                if (maintenanceToggle) maintenanceToggle.checked = config.maintenanceMode;
                if (chatWidgetToggle) chatWidgetToggle.checked = config.chatWidgetEnabled;
                
                if (dynamicIpList) {
                    dynamicIpList.value = config.ipWhitelist ? config.ipWhitelist.join('\n') : '';
                }
                document.getElementById('configLastUpdated').textContent = config.lastUpdated ? 
                    `Last updated: ${formatTime(config.lastUpdated)}` : 'Last updated: Never';
        
                // --- START: Attach listeners that update globalConfig state immediately ---
                if (chatWidgetToggle && chatWidgetToggle.type === 'checkbox') {
                    // Remove existing listener to prevent stacking if the function is called multiple times
                    chatWidgetToggle.removeEventListener('change', chatToggleHandler);
                    chatWidgetToggle.addEventListener('change', chatToggleHandler);
                }
                
                if (maintenanceToggle && maintenanceToggle.type === 'checkbox') {
                    // Remove existing listener to prevent stacking if the function is called multiple times
                    maintenanceToggle.removeEventListener('change', maintenanceToggleHandler);
                    maintenanceToggle.addEventListener('change', maintenanceToggleHandler);
                }
                // --- END ---
        
            } catch (error) {
                console.error("Error fetching admin config:", error);
                showMessage('error', `Failed to load configuration: ${error.message}`, 8000, 'config');
            }
        }
                
        function displayStaticIps() {
            const el = document.getElementById('staticIpListDisplay');
            if (el) {
                // Ensure the staticIpWhitelist is imported and available
                if (staticIpWhitelist && Array.isArray(staticIpWhitelist)) {
                    el.textContent = staticIpWhitelist.join('\n');
                } else {
                    el.textContent = 'Error: Static IP list not available.';
                }
            }
        }
    
        async function handleUpdateConfig(e) {
            e.preventDefault();
            
            // Get the latest values from the DOM elements
            const maintenanceToggle = document.getElementById('maintenanceToggle');
            const chatWidgetToggle = document.getElementById('chatWidgetToggle');
            const dynamicIpList = document.getElementById('dynamicIpList');

            // --- NEW: Gather dynamic schedule data ---
            const activeDaysCheckboxes = Array.from(document.querySelectorAll('#chatActiveDays input[name="chatDay"]:checked'));
            const activeDaysValues = activeDaysCheckboxes.map(cb => parseInt(cb.value, 10));
            
            const chatScheduleUpdates = {
                enableTime: document.getElementById('chatEnableTime').value,
                disableTime: document.getElementById('chatDisableTime').value,
                activeDays: activeDaysValues,
            };
            // -----------------------------------------
        
            // Use values directly from the toggles and the textarea
            const updates = {
                maintenanceMode: maintenanceToggle ? maintenanceToggle.checked : globalConfig.maintenanceMode,
                chatWidgetEnabled: chatWidgetToggle ? chatWidgetToggle.checked : globalConfig.chatWidgetEnabled,
                ipWhitelist: dynamicIpList ? dynamicIpList.value.split('\n').map(ip => ip.trim()).filter(ip => ip.length > 0) : globalConfig.ipWhitelist,
                chatSchedule: chatScheduleUpdates,
            };
            
            try {
                const idToken = await auth.currentUser.getIdToken();
                const res = await fetch(UPDATE_CONFIG_FUNCTION, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });
                
                if (!res.ok) {
                    const errorDetails = await res.json();
                    throw new Error(errorDetails.details || 'Update failed on server.');
                }
                
                showMessage('success', 'Configuration updated successfully!', 8000, 'config');
                await logAdminAction('CONFIG_UPDATE', updates);
                fetchAdminConfig(); // Reload config after update
            } catch (error) {
                console.error('Error updating config:', error);
                showMessage('error', `Failed to save configuration: ${error.message}`, 8000, 'config');
            }
        }
    
        // --- FETCH USERS ---
        async function fetchUsers(pageToken = null) {
            resetTimer();
            const loadMoreBtn = document.getElementById('loadMoreUsersButton');
            const msgEl = document.getElementById('usersMessage');
            
            if (msgEl) msgEl.textContent = pageToken ? 'Loading next batch...' : 'Loading users...';
            if (loadMoreBtn) loadMoreBtn.disabled = true;
    
            // Clear current list on initial load or reset (e.g., after an action)
            if (!pageToken) {
                state.allUsers = []; 
                globalNextPageToken = null;
                state.selectedUsers = []; // Clear selections on full reload
            }
    
            try {
                const idToken = await auth.currentUser.getIdToken();
                const params = new URLSearchParams();
                if (pageToken) params.append('nextPageToken', pageToken);
                
                const res = await fetch(`${LIST_USERS_FUNCTION}?${params.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${idToken}`
                    }
                });
    
                if (!res.ok) {
                    const errorDetails = await res.json();
                    throw new Error(errorDetails.details || errorDetails.error || res.statusText);
                }
    
                const data = await res.json();
                globalNextPageToken = data.nextPageToken;
                
                // Store fetched users to the state array
                state.allUsers = state.allUsers.concat(data.users); 
    
                renderUserList(); // Render the full, filtered list
    
            } catch (error) {
                console.error('Error fetching users:', error);
                showMessage('error', `Failed to fetch users: ${error.message}`, 5000, 'users');
            } finally {
                if (msgEl) msgEl.textContent = '';
                if (loadMoreBtn) loadMoreBtn.disabled = false;
                renderUserControls(); 
            }
        }
    
        /**
         * Renders a list of user records into the users grid, applying search filter and selection state.
         */
        function renderUserList() {
            const grid = document.getElementById('usersGrid');
            if (!grid) return;
            const users = getFilteredAuthUsers();
            
            // Clear existing rows but keep headers (which are the first 8 elements in the grid, including the checkbox header)
            Array.from(grid.children).slice(8).forEach(el => el.remove());
            // Uncheck the master checkbox and update counts
            const selectAll = document.getElementById('selectAllUsers');
            if (selectAll) selectAll.checked = false;
            
            document.getElementById('selectedUserCount').textContent = state.selectedUsers.length;
            document.getElementById('bulkActionButton').disabled = state.selectedUsers.length === 0;
            
            const userRows = users.map(user => {
                const disabledClass = user.disabled ? 'bg-red-50 text-red-700' : '';
                const emailVerifiedIcon = user.emailVerified ? '✅' : '❌';
                const disabledButtonText = user.disabled ? 'Enable' : 'Disable';
                const disabledButtonColor = user.disabled ? 'text-green-600 hover:text-green-800' : 'text-yellow-600 hover:text-yellow-800';
                const isSelected = state.selectedUsers.includes(user.uid);
                // Handle cases where email is null for anonymous users
                const userEmail = user.email || (user.uid.slice(0, 8) + '... (Anonymous)');
                
                return `
                    <div class="grid-item ${disabledClass}">
                        <input type="checkbox" onchange="window.module.toggleUserSelection('${user.uid}')" 
                                    data-uid="${user.uid}" ${isSelected ? 'checked' : ''}>
                    </div>
                    <div class="grid-item text-xs font-mono truncate ${disabledClass}">${user.uid.slice(0, 8)}...</div>
                    <div class="grid-item text-sm font-semibold truncate ${disabledClass}">${userEmail} ${emailVerifiedIcon}</div>
                    <div class="grid-item text-xs text-gray-500 ${disabledClass}">${user.displayName || 'N/A'}</div>
                    <div class="grid-item text-xs text-gray-500 ${disabledClass}">${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}</div>
                    <div class="grid-item text-xs text-gray-500 ${disabledClass}">${user.lastSignInTime ? new Date(user.lastSignInTime).toLocaleDateString() : 'N/A'}</div>
                    <div class="grid-item text-xs font-bold ${disabledClass}">${user.disabled ? 'DISABLED' : 'Active'}</div>
                    <div class="grid-item space-x-2 ${disabledClass}">
                        <button onclick="window.module.promptForPasswordReset('${user.uid}', '${userEmail}')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">Reset Pwd</button>
                        <button onclick="window.module.disableUser('${user.uid}', '${userEmail}', ${user.disabled})" class="${disabledButtonColor} text-sm font-semibold">${disabledButtonText}</button>
                        <button onclick="window.module.deleteUser('${user.uid}', '${userEmail}')" class="text-red-600 hover:text-red-800 text-sm font-semibold">Delete</button>
                    </div>
                `;
            }).join('');
            
            grid.insertAdjacentHTML('beforeend', userRows);
            renderUserControls();
        }
    
        /**
         * Updates the state of the Load More Users button and displays user count.
         */
        // Ensure you have 'getDoc' imported: import { getFirestore, doc, getDoc, ... }
        
        async function showOrderEditForm(orderId, clientUid) { // 🔑 Accepts both IDs
            if (!orderId || !clientUid) return console.error("Missing Order ID or Client UID for editing.");
            
            let orderRef;
            let orderSnap;
            let path;
            
            try {
                const adminUserId = await waitForUserId(); // Ensures admin user ID is available
                const collectionPathFn = window.module.getOrdersCollectionPath;
                
                if (typeof collectionPathFn !== 'function') {
                     throw new Error("Collection path helper is missing or not a function.");
                }
                
                path = collectionPathFn(clientUid);
                
                orderRef = doc(db, path, orderId);
                
                // 4. Fetch the document data directly from Firebase
                orderSnap = await getDoc(orderRef);
                
                // --- DEBUG LOGGING: CHECK THIS IN YOUR CONSOLE ---
                console.log(`[DEBUG] Attempted path: ${path}/${orderId}`);
                console.log(`[DEBUG] Document Exists: ${orderSnap.exists()}`);
                // --- END DEBUG LOGGING ---
                
                if (!orderSnap.exists()) {
                    // FIX: Show a clear error message instead of returning silently
                    document.getElementById('editModalContainer').innerHTML = `
                        <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" onclick="window.module.closeEditModal()">
                            <div class="relative top-20 mx-auto p-8 border w-3/4 md:w-1/2 shadow-2xl rounded-xl bg-white transform transition-all duration-300 scale-100" onclick="event.stopPropagation()">
                                <h3 class="text-3xl font-bold text-red-700 mb-6">Error: Order Not Found</h3>
                                <p class="text-lg text-gray-700">The order <b>${orderId.slice(0, 8)}...</b> could not be found at the path: <code>${path}</code>. Check the console for permissions errors.</p>
                                <div class="flex justify-end mt-6"><button onclick="window.module.closeEditModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition shadow-md">Close</button></div>
                            </div>
                        </div>
                    `;
                    return; // Exit after showing error
                }
                
                // 5. Construct the orderData object from the fetched snapshot
                const orderData = { id: orderSnap.id, ...orderSnap.data() };
                
                // **NEW CRITICAL STEP: Initialize the draft cart state**
                window.module.initializeDraftCart(orderData.items || []); // Use helper from window.module
                
                // 6. Render the modal using the fetched data
                const modalHtml = window.module.renderOrderEditModal(orderData);
                
                document.getElementById('editModalContainer').innerHTML = modalHtml;
                
                // **NEW CRITICAL STEP: Populate the modal's item list immediately after injection**
                window.module.updateDraftCartDisplay(); 
        
                // RENDER ITEM SELECTOR OPTIONS (Uses existing state.items and state.catalogs)
                const selectorEl = document.getElementById('editItemSelector');
                if(selectorEl) {
                    const items = state.items; 
                    let optionsHtml = '<option value="" disabled selected>-- Add Product --</option>';
                    optionsHtml += items.map(item => {
                        const cat = state.catalogs.find(c => c.id === item.catalogId)?.name || 'Uncategorized';
                        return `<option value="${item.id}">${item.name} (${cat}) - ${formatPriceDisplay(item.price)}</option>`;
                    }).join('');
                    selectorEl.innerHTML = optionsHtml;
                }
        
            } catch (error) {
                console.error("Error fetching order for edit:", error);
                
                if (error.message.includes("Timeout")) {
                    alert("Authorization error: Admin user ID was not detected. Please refresh the page.");
                } else if (error.message.includes("Target User ID is missing")) {
                    alert("Error: Client User ID is missing from the order list data. Check HTML generation.");
                } else {
                    alert("Failed to fetch order details. See console.");
                }
            }
        }
        function renderDayCheckboxes(activeDays = [1, 2, 3, 4, 5]) {
            const days = [
                { label: 'Mon', value: 1 }, { label: 'Tue', value: 2 }, { label: 'Wed', value: 3 }, 
                { label: 'Thu', value: 4 }, { label: 'Fri', value: 5 }, { label: 'Sat', value: 6 }, 
                { label: 'Sun', value: 0 }
            ];
            
            return days.map(day => {
                const isChecked = activeDays.includes(day.value);
                return `
                    <div class="flex items-center">
                        <input type="checkbox" id="chatDay${day.value}" name="chatDay" value="${day.value}" ${isChecked ? 'checked' : ''}
                               class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="chatDay${day.value}" class="ml-2 text-sm text-gray-700">${day.label}</label>
                    </div>
                `;
            }).join('');
        }
                
        function renderOrderEditModal(order) {
            // Basic status options (customize these to your business logic)
            const statuses = ['Pending', 'Processing', 'Shipped', 'Delivered', 'Cancelled'];
            const statusOptions = statuses.map(s => 
                `<option value="${s}" ${order.status === s ? 'selected' : ''}>${s}</option>`
            ).join('');
            
            // ADDED PAYMENT STATUS OPTIONS
            const isPaidOptions = `
                <option value="false" ${!order.isPaid ? 'selected' : ''}>Unpaid</option>
                <option value="true" ${order.isPaid ? 'selected' : ''}>Paid</option>
            `;
        
            // Determine the current language preference
            const currentLang = order.language || order.communicationLang || 'en';
            
            const languageOptions = `
                <option value="en" ${currentLang === 'en' ? 'selected' : ''}>🇺🇸 English</option>
                <option value="es" ${currentLang === 'es' ? 'selected' : ''}>🇪🇸 Español</option>
            `;
        
            // Determine the ID needed for the update path: Use UID for user orders, Admin Email for others
            const updateSourceId = order.uid || order.createdByAdmin || auth.currentUser.email;
            
            return `
                <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" onclick="window.module.closeEditModal()">
                    <div class="relative top-10 mx-auto p-8 border w-11/12 md:w-3/4 lg:w-2/3 shadow-2xl rounded-xl bg-white transform transition-all duration-300 scale-100" onclick="event.stopPropagation()">
                        <h3 class="text-3xl font-bold text-indigo-700 mb-6">Edit Order: ${order.id.slice(0, 8)}...</h3>
                        <form id="orderEditForm" onsubmit="window.module.updateOrder(event, '${order.id}', '${updateSourceId}')">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                
                                <div class="lg:col-span-1 space-y-4">
                                    <h4 class="text-xl font-bold text-gray-700 border-b pb-2">Details</h4>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-status">Status</label>
                                        <select id="edit-status" class="w-full p-2 border border-gray-300 rounded-lg text-base">
                                            ${statusOptions}
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-payment-status">Payment Status</label>
                                        <select id="edit-payment-status" class="w-full p-2 border border-gray-300 rounded-lg text-base">
                                            ${isPaidOptions}
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-language">Customer Language</label>
                                        <select id="edit-language" class="w-full p-2 border border-gray-300 rounded-lg text-base">
                                            ${languageOptions}
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-address">Delivery Address</label>
                                        <input type="text" id="edit-address" value="${order.deliveryAddress || ''}" required 
                                               class="w-full p-2 border border-gray-300 rounded-lg text-base">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-notes">Internal Notes (for Admin)</label>
                                        <textarea id="edit-notes" rows="3" class="w-full p-2 border border-gray-300 rounded-lg text-base">${order.adminNotes || ''}</textarea>
                                    </div>
                                </div>
        
                                <div class="lg:col-span-1 space-y-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                    <h4 class="text-xl font-bold text-pink-700 border-b pb-2">Items Ordered (Edit)</h4>
        
                                    <div class="space-y-3 p-3 border border-pink-200 rounded-lg bg-white">
                                        <p class="text-sm font-semibold text-pink-600">Add Product:</p>
                                        <div class="flex space-x-2 items-center">
                                            <select id="editItemSelector" class="flex-grow p-2 border rounded-lg text-sm">
                                                </select>
                                            <input type="number" id="editItemQuantity" value="1" min="1" class="w-14 p-2 border rounded-lg text-center flex-shrink-0 text-sm">
                                        </div>
                                        <button type="button" onclick="window.module.addDraftCartItem()" class="w-full bg-pink-600 text-white py-2 rounded-lg text-sm hover:bg-pink-700">Add to Order</button>
                                    </div>
        
                                    <div class="max-h-60 custom-scrollbar overflow-y-auto pr-2 border-t pt-2">
                                        <div id="editOrderItemsDisplay" class="space-y-1">
                                            </div>
                                    </div>
        
                                    <div class="pt-4 mt-4 border-t border-gray-300">
                                        <div class="flex justify-between font-bold text-xl text-gray-800">
                                            <span>New Total:</span>
                                            <span id="editOrderTotal">$0.00</span>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1 italic">The final total will be recalculated upon saving.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-8 pt-4 border-t border-gray-200">
                                <button type="button" onclick="window.module.closeEditModal()" 
                                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition shadow-md">
                                    Cancel
                                </button>
                                <button type="submit" id="saveOrderBtn"
                                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition shadow-lg">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        function closeEditModal() {
            // Hide the modal by clearing its container
            document.getElementById('editModalContainer').innerHTML = '';
        }
        
        async function updateOrder(e, orderId, sourceId) {
            e.preventDefault();
            
            const saveBtn = document.getElementById('saveOrderBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3 text-white inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Saving...`;
            
            const newStatus = document.getElementById('edit-status').value;
            const newLanguage = document.getElementById('edit-language').value;
            const newAddress = document.getElementById('edit-address').value;
            const newNotes = document.getElementById('edit-notes').value;
            const newIsPaidString = document.getElementById('edit-payment-status').value;
            const newIsPaid = newIsPaidString === 'true';
            
            // **NEW: Get the draft items and calculate the new total**
            const newItemsDraft = Object.values(state.editingOrderDraftCart);
            const newItemsList = newItemsDraft.map(entry => ({
                id: entry.item.id,
                name: entry.item.name,
                sku: entry.item.sku || null,
                price: entry.item.price, // Price in cents
                quantity: entry.quantity
            }));
            const newTotalCents = newItemsDraft.reduce((sum, entry) => sum + entry.item.price * entry.quantity, 0);
        
            // Validate if the cart is empty after editing
            if (newItemsList.length === 0) {
                alert("Cannot save an empty order. Please add at least one item or cancel.");
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
                return;
            }
            // ----------------------------------------------------
        
            const collectionPath = window.module.getOrdersCollectionPath(sourceId);
            const orderRef = doc(db, collectionPath, orderId);
            
            // 1. Get the original order object from local state
            const originalOrder = state.orders.find(o => o.id === orderId); 
            const originalStatus = originalOrder ? originalOrder.status : '';
            const originalItemsMap = originalOrder ? originalOrder.items.reduce((map, item) => { map[item.id] = item.quantity; return map; }, {}) : {};
        
            try {
                // 2. Perform Firestore Update with all fields, INCLUDING ITEMS AND TOTAL
                await updateDoc(orderRef, {
                    status: newStatus,
                    isPaid: newIsPaid,
                    deliveryAddress: newAddress,
                    adminNotes: newNotes,
                    language: newLanguage,
                    communicationLang: newLanguage,
                    items: newItemsList,          // <-- NEW
                    totalCents: newTotalCents,    // <-- NEW
                    updatedAt: serverTimestamp()
                });
        
                // 3. **CRITICAL: Handle Inventory Adjustment**
                const inventoryUpdatePromises = newItemsList.map(async newItem => {
                    const originalQty = originalItemsMap[newItem.id] || 0;
                    const change = newItem.quantity - originalQty; // +ve for added, -ve for removed
        
                    if (change !== 0) {
                        const currentItem = state.items.find(i => i.id === newItem.id);
                        if (currentItem) {
                            const newStock = Math.max(0, (currentItem.stock || 0) - change);
                            const itemRef = doc(db, ITEMS_COLLECTION, newItem.id);
                            await updateDoc(itemRef, { stock: newStock });
                            
                            await logAdminAction('INVENTORY_ADJUSTED_VIA_EDIT', {
                                itemId: newItem.id,
                                item: currentItem.name,
                                orderId,
                                qtyChange: change,
                                oldStock: currentItem.stock,
                                newStock
                            }, newItem.id);
                        }
                    }
                });
        
                // Handle items that were completely removed from the order (inventory must be returned)
                const removedItemPromises = Object.keys(originalItemsMap).filter(id => !newItemsList.some(item => item.id === id)).map(async removedItemId => {
                    const removedQty = originalItemsMap[removedItemId];
                    const currentItem = state.items.find(i => i.id === removedItemId);
                    if (currentItem) {
                        const newStock = (currentItem.stock || 0) + removedQty;
                        const itemRef = doc(db, ITEMS_COLLECTION, removedItemId);
                        await updateDoc(itemRef, { stock: newStock });
        
                        await logAdminAction('INVENTORY_RETURNED_VIA_EDIT', {
                            itemId: removedItemId,
                            item: currentItem.name,
                            orderId,
                            qtyReturned: removedQty,
                            oldStock: currentItem.stock,
                            newStock
                        }, removedItemId);
                    }
                });
                
                await Promise.all([...inventoryUpdatePromises, ...removedItemPromises]);
                // ------------------------------------------
        
                // 4. Notification Trigger Check (status change is separate from item change)
                const requiresNotification = ['Processing', 'Delivered', 'Cancelled'].includes(newStatus) && newStatus !== originalStatus;
                
                if (requiresNotification && originalOrder) {
                    
                    const emailPayload = {
                        ...originalOrder,
                        orderId: orderId,
                        newStatus: newStatus,
                        language: newLanguage,
                        deliveryAddress: newAddress,
                        adminNotes: newNotes,
                        items: newItemsList, // Pass the NEW list of items to the email template
                        totalCents: newTotalCents, // Pass the NEW total to the email template
                    };
                    
                    await fetch(EMAIL_CONFIRMATION_FUNCTION, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(emailPayload)
                    });
                    alert(`Order ${orderId.slice(0, 8)} updated to: ${newStatus}. Notification email triggered.`);
                } else {
                    alert(`Order ${orderId.slice(0, 8)} updated. No status notification sent.`);
                }
                
                closeEditModal();
                // Reload order list which triggers the listener to update the display
                window.module.fetchOrders();
                
            } catch (error) {
                console.error("Error updating document or adjusting inventory/sending email: ", error);
                alert(`Error updating order: ${error.message}. Check console for details.`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }
    
        function renderUserControls() {
            const loadMoreBtn = document.getElementById('loadMoreUsersButton');
            const userCountEl = document.getElementById('userCount');
            const filteredCount = getFilteredAuthUsers().length;
            const totalCount = state.allUsers.length;
            
            if (loadMoreBtn) {
                // Only show "Load More" if there's no search term and a next page token exists
                if (globalNextPageToken && !state.userSearchTerm) {
                    loadMoreBtn.classList.remove('hidden');
                    loadMoreBtn.textContent = 'Load More Users (100)';
                    loadMoreBtn.disabled = false;
                } else {
                    loadMoreBtn.classList.add('hidden');
                }
            }
    
            if (userCountEl) {
                if (state.userSearchTerm) {
                    userCountEl.textContent = `Found ${filteredCount} matching users (from ${totalCount} loaded).`;
                } else {
                    userCountEl.textContent = `Showing ${filteredCount} users total.`;
                }
            }
        }
    
        // ----------------------------------------------------------------------
        // --- RENDERING FUNCTIONS (MODIFIED HTML STRUCTURE) ---
        // ----------------------------------------------------------------------
    
        function renderEditProductForm() {
            if (!state.editingItem) return '';
            const item = state.editingItem;
            const options = state.catalogs.map(c => `<option value="${c.id}" ${c.id === item.catalogId ? 'selected' : ''}>${c.name}</option>`).join('');
            const priceDollars = (item.price / 100).toFixed(2);
            const img = item.imageUrl.includes('placehold.co') ? '' : item.imageUrl;
    
            return `
                <div class="mb-10 p-6 border rounded-xl shadow-2xl bg-yellow-100 border-t-4 border-yellow-500">
                    <h3 class="text-xl font-bold mb-4 text-yellow-700">Edit: ${item.name}</h3>
                    <div class="mb-4 p-3 bg-yellow-200 border border-yellow-300 rounded-lg">
                        <label class="block text-sm font-bold text-yellow-800">SKU:</label>
                        <input type="text" value="${item.sku || 'N/A'}" readonly class="w-full p-2 bg-yellow-50 font-mono text-sm border-yellow-400 rounded-md cursor-not-allowed">
                    </div>
                    <form onsubmit="window.module.handleEditProduct(event)" class="space-y-4">
                        <input type="hidden" name="itemId" value="${item.id}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input name="itemName" value="${item.name}" required class="p-2 border rounded-lg">
                            <select name="catalogId" required class="p-2 border rounded-lg"><option value="">-- Category --</option>${options}</select>
                        </div>
                        <textarea name="itemDescription" rows="2" required class="w-full p-2 border rounded-lg">${item.description}</textarea>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="number" step="0.01" name="itemPrice" value="${priceDollars}" required class="p-2 border rounded-lg">
                            <input type="url" name="itemImageUrl" value="${img}" class="p-2 border rounded-lg">
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="flex-grow bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700">Save Changes</button>
                            <button type="button" onclick="window.module.cancelEdit()" class="flex-grow bg-gray-300 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                        </div>
                    </form>
                </div>`;
        }
    
        function renderProductListSection() {
            const el = document.getElementById('productListContainer');
            if (!el) return;
            const items = getFilteredItems();
    
            el.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-indigo-700">Products (${items.length} / ${state.items.length} total)</h3>
                <div class="overflow-x-auto">
                    <div class="grid gap-x-4 min-w-[850px]" style="grid-template-columns: 1fr 2fr 1fr 1fr 1.5fr 1.5fr 1fr;">
                        <div class="grid-header">SKU</div>
                        <div class="grid-header">Name & Description</div>
                        <div class="grid-header">Price</div>
                        <div class="grid-header">Category</div>
                        <div class="grid-header">Image URL</div>
                        <div class="grid-header">Added At</div>
                        <div class="grid-header">Actions</div>
                        ${items.map(item => {
                            const cat = state.catalogs.find(c => c.id === item.catalogId)?.name || 'Uncategorized';
                            const created = item.createdAt ? formatTime(item.createdAt) : 'N/A';
                            return `
                                <div class="grid-item text-xs font-mono text-gray-700">${item.sku || 'N/A'}</div>
                                <div class="grid-item"><p class="font-semibold">${item.name}</p><p class="text-xs text-gray-500">${item.description.substring(0,50)}${item.description.length>50?'...':''}</p></div>
                                <div class="grid-item font-bold text-green-700">${formatPriceDisplay(item.price)}</div>
                                <div class="grid-item">${cat}</div>
                                <div class="grid-item text-xs text-blue-500 truncate"><a href="${item.imageUrl}" target="_blank" class="hover:underline">${item.imageUrl.substring(0,30)}...</a></div>
                                <div class="grid-item text-xs text-gray-500">${created}</div>
                                <div class="grid-item">
                                    <button onclick="window.module.showEditForm(${JSON.stringify(item).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800 text-sm font-semibold mr-3">Edit</button>
                                    <button onclick="window.module.handleDeleteProduct('${item.id}', '${item.name}')" class="text-red-600 hover:text-red-800 text-sm font-semibold">Delete</button>
                                </div>`;
                        }).join('')}
                    </div>
                    ${items.length === 0 ? '<p class="text-center p-4 text-gray-500">No products found.</p>' : ''}
                </div>`;
        }
    
        function renderPreviewSite() {
            return `
                <section class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500">
                    <h2 class="text-2xl font-bold mb-4 text-green-700">Live Site Preview</h2>
                    <div class="preview-iframe-container border border-gray-300 rounded-lg overflow-hidden">
                        <iframe src="/" class="w-full h-full" frameborder="0" sandbox="allow-forms allow-popups allow-scripts allow-same-origin"></iframe>
                    </div>
                    <p class="text-sm text-gray-500 mt-4">Embedded view of your live site. Functionality may be limited as scripts are blocked to prevent interference with the Admin session.</p>
                </section>`;
        }
        
        function renderInventorySection() {
            const el = document.getElementById('inventoryContent');
            if (!el) return '';
            
            const lowStockThreshold = 10;
            const items = state.items;
        
            const inventoryListHtml = items.map(item => {
                const isLowStock = item.stock <= lowStockThreshold;
                const stockColor = isLowStock ? 'text-red-600 font-bold' : 'text-green-700 font-semibold';
                const rowClass = isLowStock ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200';
        
                return `
                    <div class="grid grid-cols-12 gap-4 items-center p-3 border-b ${rowClass}">
                        <div class="col-span-4 truncate text-sm font-medium">${item.name} <span class="text-xs text-gray-500 ml-2">(${item.sku})</span></div>
                        <div class="col-span-2 text-center ${stockColor}">${item.stock}</div>
                        <div class="col-span-6">
                            <form onsubmit="window.module.handleUpdateStock(event, '${item.id}')" class="flex space-x-2 items-center">
                                <input type="number" name="stockAdjustment" placeholder="Amount" min="1" required class="w-20 p-1 border rounded text-sm">
                                <select name="stockAction" class="p-1 border rounded text-sm">
                                    <option value="add">Add Stock</option>
                                    <option value="remove">Remove Stock</option>
                                </select>
                                <button type="submit" class="px-3 py-1 bg-indigo-500 text-white text-sm rounded hover:bg-indigo-600 transition duration-150">Update</button>
                                <button type="button" onclick="window.module.showPurchaseOrderForm('${item.id}', '${item.name}')" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition duration-150">Order More</button>
                            </form>
                        </div>
                    </div>
                `;
            }).join('');
        
            el.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-12 gap-4 font-bold bg-gray-100 p-3 rounded-lg border-b border-gray-300">
                        <div class="col-span-4">Product Name (SKU)</div>
                        <div class="col-span-2 text-center">Current Stock</div>
                        <div class="col-span-6">Adjust Stock / Order</div>
                    </div>
                    <div id="inventoryList" class="space-y-1 custom-scrollbar max-h-[60vh] overflow-y-auto">
                        ${inventoryListHtml.length > 0 ? inventoryListHtml : '<p class="text-center p-4 text-gray-500">No products found in inventory.</p>'}
                    </div>
                </div>
            `;
            return '';
        }
    
            // --- ORDERS TRACKING FUNCTIONS (Render) ---
        function renderOrdersList() {
            // This logic filters the orders based on state.orderStatusFilter
            const orders = getFilteredOrders();
            
            const tableRows = orders.map(order => {
                
                // 🔑 1. Determine the necessary ID for the Firestore path
                const targetId = order.uid || order.createdByAdmin;
                
                // 2. Set status classes and delivery button logic
                const statusClass = order.status === 'Delivered' ? 'text-green-600 font-bold' :
                                            order.status === 'Pending' ? 'text-red-600 font-bold' :
                                            order.status === 'Processing' ? 'text-blue-600 font-bold' : 'text-gray-600';
                
                let deliveryButton = '';
                if (order.status === 'Pending') {
                     deliveryButton = `<button onclick="window.module.handleRequestDelivery('${order.id}')" class="px-3 py-1 w-full bg-teal-500 text-white text-xs rounded hover:bg-teal-600 transition">Request Delivery</button>`;
                } else if (order.status === 'Processing') {
                     deliveryButton = `<button disabled class="px-3 py-1 w-full bg-gray-400 text-white text-xs rounded">Delivery In Progress</button>`;
                }
                
                const itemListHtml = order.items.map(item => `<p>${item.quantity}x ${item.name.substring(0,20)}${item.name.length > 20 ? '...' : ''}</p>`).join('');
                const isPaid = order.isPaid || false;
                const paymentStatusBadge = isPaid
                    ? `<span class="text-xs font-semibold text-white bg-green-500 px-1 py-0.5 rounded-full ml-1">Paid</span>`
                    : `<span class="text-xs font-semibold text-white bg-red-500 px-1 py-0.5 rounded-full ml-1">Unpaid</span>`;
                
                const editButton = targetId
                    ? `<button onclick="window.module.showOrderEditForm('${order.id}', '${targetId}')" class="px-3 py-1 w-full bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600 transition">Edit Order</button>`
                    : `<span class="text-xs text-red-500 p-1">No Edit Source</span>`;
        
                // The status update dropdown remains for manual updates
                const statusUpdateDropdown = `
                    <select onchange="window.module.handleOrderStatusUpdate('${order.id}', this.value)" class="p-1 border rounded-lg text-xs bg-gray-50 mt-1 w-full">
                        <option value="${order.status}" selected>${order.status}</option>
                        <option value="Pending">Pending</option>
                        <option value="Processing">Processing</option>
                        <option value="Shipped">Shipped</option>
                        <option value="Delivered">Delivered</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                `;
                
                return `
                    <div class="grid grid-cols-12 gap-4 items-center p-3 border-b border-gray-100 hover:bg-gray-50">
                        <div class="col-span-2 text-sm text-gray-800 font-semibold break-all">
                            <p class="font-bold text-lg text-indigo-600">#${order.id.substring(0, 5)}</p>
                            <p class="text-xs text-gray-500 font-mono">${order.id}</p>
                        </div>
                        <div class="col-span-2 text-sm">
                            <p class="font-semibold">${order.buyerName}</p>
                            <p class="text-xs text-gray-500 truncate">${order.buyerEmail}</p>
                            <p class="text-xs text-gray-500 truncate">${order.deliveryAddress}</p>
                        </div>
                        <div class="col-span-3 flex flex-col items-center justify-center space-y-1">    
                            <div class="flex items-center">
                                <span class="text-lg font-bold text-pink-700">${formatPriceDisplay(order.totalCents)}</span>
                                ${paymentStatusBadge}    
                            </div>
                            <span class="text-sm font-bold ${statusClass} flex-shrink-0">${order.status}</span>
                        </div>
                        <div class="col-span-1"></div>
                        <div class="col-span-2 text-xs text-gray-700">
                            ${itemListHtml}    
                        </div>
                        <div class="col-span-2 space-y-1">    
                            <div class="text-xs text-gray-500 font-semibold mb-2">
                                ${formatTime(order.createdAt)}    
                            </div>
                            ${editButton} 
                            ${deliveryButton}
                            ${statusUpdateDropdown}
                        </div>
                    </div>
                `;
            }).join('');
            const contentEl = document.getElementById('ordersListContent');
                if (contentEl) {
                    contentEl.innerHTML = tableRows || '<p class="text-center p-6 text-gray-500">No orders found matching this filter.</p>';
                }
                const statsEl = document.getElementById('ordersStats');
                if (statsEl) {
                    statsEl.innerHTML = window.module.getOrdersStatsHtml();
                    window.module.renderSalesCharts(); // Call the renderer after injecting the HTML
                }
                
                // Clear the loading message after rendering
                const ordersMsgElClear = document.getElementById('ordersMessage');
                if (ordersMsgElClear) ordersMsgElClear.textContent = '';
            }
            
        function renderOrdersStats() {
            const statsEl = document.getElementById('ordersStats');
            if (statsEl) {
                // 1. Inject the entire statistics HTML structure (containing the canvases and the new container)
                statsEl.innerHTML = getOrdersStatsHtml();
                
                // 2. IMPORTANT: Now that the canvases and table container are in the DOM, 
                //    call the chart and table drawing function immediately.
                window.module.renderSalesCharts();
            }
        }
    
        function renderOrderCreateForm() {
            return `
                <section class="space-y-8">
                    <div class="flex justify-between items-center">
                        <h2 class="text-3xl font-extrabold text-indigo-700">Manual Order Creation</h2>
                        <button onclick="window.module.switchOrderPage('list')" class="px-4 py-2 rounded-lg font-semibold text-white bg-gray-500 hover:bg-gray-600 transition">← Back to Tracking</button>
                    </div>
                    <div id="ordersMessage"></div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-8">
                    
                        <div class="md:col-span-5 bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500">
                            <h3 class="text-xl font-bold mb-4 text-purple-700">Enter Customer Details</h3>
                            <form id="createOrderForm" onsubmit="window.module.handleAdminOrderSubmit(event)" class="space-y-4">
                                <input type="text" id="buyerName" placeholder="Customer Name" required class="w-full p-2 border rounded-lg">
                                <input type="email" id="buyerEmail" placeholder="Customer Email (for confirmation)" required class="w-full p-2 border rounded-lg">
                                <input type="tel" id="buyerPhone" placeholder="Customer Phone (Optional)" class="w-full p-2 border rounded-lg">
                                
                                <select id="buyerLanguage" class="w-full p-2 border rounded-lg">
                                    <option value="en" selected>English (Email)</option>
                                    <option value="es">Español (Correo Electrónico)</option>
                                </select>
                                
                                <input type="text" id="deliveryAddress" placeholder="Start typing address for validation..." required 
                                    class="w-full p-2 border rounded-lg address-input address-invalid" 
                                    autocomplete="off" data-validated="false">
                                <p id="addressErrorAdmin" class="text-sm text-red-600 mt-1">
                                    Please select a valid address from the dropdown.
                                </p>
                                <textarea id="orderNotes" rows="2" placeholder="Internal Admin Notes (Optional)" class="w-full p-2 border rounded-lg"></textarea>
                                
                                <div class="pt-4 border-t">
                                    <button type="submit" id="submitOrderButton" disabled
                                        class="w-full bg-purple-600 text-white py-3 rounded-lg font-extrabold hover:bg-purple-700 transition duration-150 shadow-lg disabled:bg-purple-300 disabled:cursor-not-allowed">
                                        SUBMIT ORDER & SEND EMAIL
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="md:col-span-5 bg-white p-6 rounded-xl shadow-lg border-t-4 border-pink-500">
                            <h3 class="text-xl font-bold mb-4 text-pink-700">Build Order Cart</h3>
                            
                            <div class="mb-4">
                                <input type="text" id="orderItemSearch" oninput="window.module.handleOrderSearchInput(event)" 
                                    placeholder="Search products by name or SKU..." class="w-full p-2 border rounded-lg">
                            </div>
                            
                            <div class="space-y-4 mb-4 p-3 bg-pink-50 rounded-lg">
                                <div class="flex space-x-2 items-center">
                                    <select id="itemSelector" class="flex-grow p-2 border rounded-lg">
                                        </select>
                                    <input type="number" id="itemQuantity" value="1" min="1" class="w-14 p-2 border rounded-lg text-center flex-shrink-0">
                                </div>
                                <button type="button" onclick="window.module.addAdminCartItem()" class="w-full bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700">Add to Order</button>
                            </div>
                            
                            <div class="space-y-3 max-h-60 custom-scrollbar overflow-y-auto pr-2" id="adminCartDisplay">
                                </div>
                            
                            <div class="pt-4 mt-4 border-t border-gray-200">
                                <div class="flex justify-between font-bold text-xl text-gray-800">
                                    <span>Total:</span>
                                    <span id="adminCartTotal">$0.00</span>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </section>
            `;
        }
    
        function renderOrderTracker() {
            const statusOptions = ['All', 'Pending', 'Processing', 'Shipped', 'Delivered', 'Cancelled'];
            const deliveryOptions = ['All', 'Ready', 'Scheduled', 'Unscheduled']; // NEW Options
            
            return `
                <section class="space-y-8">
                    <h2 class="text-3xl font-extrabold text-indigo-700">Sales and Delivery Tracking</h2>
                    <div id="ordersMessage" class="text-center font-semibold">Loading orders...</div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                            <h3 class="text-xl font-bold text-indigo-700">Recent Orders List</h3>
                            
                            <input type="text" oninput="window.module.handleOrderListSearchInput(event)" 
                                placeholder="Search name, email, order #, or SKU..." 
                                class="w-full sm:w-80 p-2 border rounded-lg text-sm mb-4 sm:mb-0 sm:mr-4"
                                value="${state.orderListSearchTerm}">
                            
                            <div class="flex space-x-4">
                                <select onchange="window.module.handleStatusFilterChange(event)" class="p-2 border rounded-lg text-sm bg-gray-50">
                                    ${statusOptions.map(s => `<option value="${s}" ${state.orderStatusFilter === s ? 'selected' : ''}>Filter: ${s}</option>`).join('')}
                                </select>
                                
                                <select onchange="window.module.handleDeliveryFilterChange(event)" class="p-2 border rounded-lg text-sm bg-gray-50">
                                    ${deliveryOptions.map(s => `<option value="${s}" ${state.deliveryStatusFilter === s ? 'selected' : ''}>Delivery: ${s}</option>`).join('')}
                                </select>
                                
                                <button onclick="window.module.switchOrderPage('create')" class="px-4 py-2 rounded-lg font-semibold text-white bg-green-600 hover:bg-green-700 transition">Create Manual Order</button>
                            </div>
                        </div>
                        <div class="bg-gray-100 p-3 rounded-t-lg font-bold text-sm grid grid-cols-12 gap-4">
                            <div class="col-span-2">Order # / ID</div>        
                            <div class="col-span-2">Buyer/Address</div>
                            <div class="col-span-3 text-center">Total / Paid</div>
                            <div class="col-span-1"></div>
                            <div class="col-span-2 text-center">Items</div>
                            <div class="col-span-2 text-center">Actions / Time</div>    
                        </div>
                        <div id="ordersListContent" class="max-h-[70vh] custom-scrollbar overflow-y-auto">
                            </div>
                    </div>
                    
                    <div id="ordersStatsContainer" class="space-y-6">
                        <div id="ordersStats" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-pink-500">
                            </div>
                    </div>
                </section>
            `;
        }
    
        function renderAdminTabs() {
            const catOpts = state.catalogs.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            if (state.activeTab === 'catalog') {
                return `
                    <section class="space-y-10">
                        <div id="catalogMessage"></div>
                        
                        ${renderEditProductForm()}
    
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <input type="text" oninput="window.module.handleSearchInput(event)" placeholder="Search products, SKUs, or category..." class="p-2 border rounded-lg w-full max-w-md">
                            </div>
                            <div id="productListContainer">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
                                <h3 class="text-xl font-bold mb-4 text-indigo-700">Manage Categories</h3>
                                <form onsubmit="window.module.handleAddCatalog(event)" class="space-y-4">
                                    <input type="text" name="catalogName" placeholder="New Category Name (e.g., 'Electronics')" required class="w-full p-2 border rounded-lg">
                                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Add New Category</button>
                                </form>
                                <div class="mt-4 space-y-2 max-h-40 custom-scrollbar overflow-y-auto">
                                    ${state.catalogs.map(c => `
                                        <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded-lg">
                                            <span class="font-medium">${c.name}</span>
                                            <button onclick="window.module.handleDeleteCatalog('${c.id}', '${c.name}')" class="text-red-500 hover:text-red-700 text-xs font-semibold">Delete</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500">
                                <h3 class="text-xl font-bold mb-4 text-green-700">Add New Product</h3>
                                <form onsubmit="window.module.handleAddProduct(event)" class="space-y-4">
                                    <input type="text" name="itemName" placeholder="Product Name" required class="w-full p-2 border rounded-lg">
                                    <textarea name="itemDescription" rows="2" placeholder="Product Description" required class="w-full p-2 border rounded-lg"></textarea>
                                    <div class="grid grid-cols-2 gap-4">
                                        <input type="number" step="0.01" name="itemPrice" placeholder="Price (e.g., 19.99)" required min="0.01" class="w-full p-2 border rounded-lg">
                                        <select name="catalogId" required class="w-full p-2 border rounded-lg">
                                            <option value="">-- Select Category --</option>
                                            ${catOpts}
                                        </select>
                                    </div>
                                    <input type="url" name="itemImageUrl" placeholder="Image URL (Optional)" class="w-full p-2 border rounded-lg">
                                    <input type="number" name="initialStock" placeholder="Initial Stock (Units)" min="0" value="0" class="w-full p-2 border rounded-lg">
                                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Add Product</button>
                                </form>
                            </div>
                        </div>
    
                        
                    </section>
                `;
            } else if (state.activeTab === 'config') {
            // Use default times if config doesn't have them
            const enableTime = globalConfig.chatSchedule?.enableTime || '08:00';
            const disableTime = globalConfig.chatSchedule?.disableTime || '20:00';
            const activeDays = globalConfig.chatSchedule?.activeDays || [1, 2, 3, 4, 5]; // Default Mon-Fri
            
            return `
                <section class="space-y-8">
                    <div id="configMessage"></div>
                    <h2 class="text-2xl font-bold text-indigo-700">Global System Configuration</h2>
    
                    <div class="p-6 border rounded-xl bg-blue-50 border-blue-200">
                        <h3 class="text-xl font-bold mb-4 text-blue-700">Chat Widget Schedule</h3>
                        <p class="text-sm text-gray-600 mb-4">Set the window (in UTC-5 / Colombia Time) when the chat widget should be automatically enabled.</p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Enable Time (UTC-5)</label>
                                <input type="time" id="chatEnableTime" required class="w-full p-2 border rounded-lg" value="${enableTime}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Disable Time (UTC-5)</label>
                                <input type="time" id="chatDisableTime" required class="w-full p-2 border rounded-lg" value="${disableTime}">
                            </div>
                        </div>
    
                        <label class="block text-sm font-medium text-gray-700 mb-2">Active Days</label>
                        <div id="chatActiveDays" class="flex flex-wrap space-x-4">
                            ${renderDayCheckboxes(activeDays)}
                        </div>
                    </div>
                    <div class="p-4 bg-blue-50 rounded-xl shadow-inner border border-blue-300">
                        <div class="flex items-center justify-between">
                            <label for="chatWidgetToggle" class="text-lg font-medium text-gray-700">Enable Site Chat Widget (Manual Override)</label>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="chatWidgetToggle" id="chatWidgetToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                                <label for="chatWidgetToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <p class="text-sm text-blue-600 mt-2">Controls visibility of the customer support chat widget on the public site.</p>
                    </div>
                    <div class="p-4 bg-red-100 rounded-xl shadow-inner border border-red-300">
                        <p class="text-sm font-semibold text-red-700 mb-3">User Management Utility (Global Action):</p>
                        <button id="clearAnonButtonConfig" onclick="window.module.handleClearAnonymousUsers()" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700 transition duration-150 shadow-md">
                            Clear All Anonymous Users
                        </button>
                        <p class="text-xs text-red-500 mt-2">Warning: This action is irreversible and should only be performed after careful consideration.</p>
                    </div>
                    
                    <form id="configForm" onsubmit="window.module.handleUpdateConfig(event)" class="bg-white p-6 rounded-xl shadow-lg space-y-6">
                        
                        <div class="flex items-center justify-between p-4 border rounded-lg bg-red-50 border-red-200">
                            <label for="maintenanceToggle" class="text-lg font-medium text-gray-700">Maintenance Mode</label>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="maintenanceToggle" id="maintenanceToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                                <label for="maintenanceToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-red-300 cursor-pointer"></label>
                            </div>
                            <p class="text-sm text-red-600">Disables store functionality for public users.</p>
                                    </div>
    
                            <div>
                                <h3 class="text-xl font-bold mb-2 text-gray-700">Dynamic Admin IP Whitelist (Stored in Firestore)</h3>
                                <p class="text-sm text-gray-500 mb-4">Users from these IPs can access the Admin Login page even if Maintenance Mode is active. One IP address per line.</p>
                                <textarea id="dynamicIpList" rows="4" placeholder="123.45.67.89&#10;98.76.54.32" class="w-full p-3 border rounded-lg font-mono text-sm"></textarea>
                                <p id="configLastUpdated" class="text-xs text-gray-500 mt-2"></p>
                            </div>
    
                            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <h3 class="text-xl font-bold mb-2 text-gray-700">Static Client IP Whitelist (Codebase)</h3>
                                <p class="text-sm text-gray-500 mb-2">This is the list of IP addresses whitelisted to allow access to admin functionality</p>
                                <pre id="staticIpListDisplay" class="bg-white p-3 rounded-lg border font-mono text-sm text-gray-800"></pre>
                            </div>
                            
                            <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">Save Configuration</button>
                        </form>
                    </section>
                `;
            } else if (state.activeTab === 'users') {
                return `
                        <section class="space-y-8">
                            <h2 class="text-2xl font-bold text-indigo-700">Registered Users Management</h2>
                            <div id="usersMessage"></div>
    
                            <div class="flex justify-between items-center mb-4">
                                <input type="text" oninput="window.module.handleUserSearchInput(event)" 
                                    placeholder="Search users by email, ID, or name..." 
                                    class="p-2 border rounded-lg w-full max-w-md">
                                
                                <button id="clearAnonButton" onclick="window.module.handleClearAnonymousUsers()" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700 transition duration-150 shadow-md ml-4">
                                    Clear All Anonymous Users
                                </button>
                            </div>
                            
                            <div class="p-4 bg-gray-200 rounded-lg shadow-inner flex justify-between items-center mb-4">
                                <span class="text-sm font-semibold text-gray-700">
                                    <span id="selectedUserCount">0</span> users selected.
                                </span>
                                <div class="flex space-x-2">
                                    <select id="bulkActionSelect" class="p-2 border rounded-lg text-sm bg-white">
                                        <option value="">-- Select Bulk Action --</option>
                                        <option value="delete">Delete Permanently</option>
                                        <option value="update" data-update='{"disabled": false}'>Enable</option>
                                        <option value="update" data-update='{"disabled": true}'>Disable</option>
                                        <option value="resetPassword">Set New Password</option>
                                    </select>
                                    <button onclick="window.module.handleBulkUserAction()" id="bulkActionButton" disabled class="px-4 py-2 rounded-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300">
                                        Apply to Selected
                                    </button>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                                <div id="usersGrid" class="grid gap-x-4 min-w-[1300px]" style="grid-template-columns: 30px 0.5fr 1.5fr 1fr 1fr 1fr 0.5fr 2fr;">
                                    <div class="grid-header">
                                        <input type="checkbox" onchange="window.module.toggleAllUsers(this.checked)" id="selectAllUsers">
                                    </div>
                                    <div class="grid-header">UID</div>
                                    <div class="grid-header">Email</div>
                                    <div class="grid-header">Display Name</div>
                                    <div class="grid-header">Created</div>
                                    <div class="grid-header">Last Sign-In</div>
                                    <div class="grid-header">Status</div>
                                    <div class="grid-header">Actions</div>
                                    </div>
                                <div class="text-center mt-6">
                                    <button id="loadMoreUsersButton" onclick="window.module.fetchUsers(globalNextPageToken)" class="px-4 py-2 rounded-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150 shadow-md hidden">
                                        Load More Users (100)
                                    </button>
                                    <p id="userCount" class="text-sm text-gray-500 mt-2">Showing 0 users.</p>
                                </div>
                            </div>
                        </section>
                    `;
                } else if (state.activeTab === 'orders') {
                    if (state.orderPage === 'list') {
                        return renderOrderTracker(); // Renders the tracking list and charts
                    } else {
                        return renderOrderCreateForm(); // Renders the manual order creation form
                    }
                } else if (state.activeTab === 'inventory') { // NEW: Inventory tab rendering
                    return `
                        <section class="space-y-8">
                            <h2 class="text-2xl font-bold text-indigo-700">Inventory Management & Stock Control</h2>
                            <div id="inventoryMessage"></div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-orange-500">
                                <div id="inventoryContent">
                                    </div>
                            </div>
                        </section>
                    `;
                }
            }
    
        function renderAdminPage(userName) {
            document.getElementById('app').innerHTML = `
                    <header class="flex justify-between items-center mb-10 pb-4 border-b-4 border-indigo-600">
                        <h1 class="text-4xl font-extrabold text-indigo-700">Admin Dashboard</h1>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-600 font-medium text-sm hidden sm:inline">Welcome, ${userName}</span>
                            ${state.previewMode
                                ? `<button onclick="window.module.togglePreviewMode(false)" class="px-4 py-2 rounded-lg font-semibold text-white bg-indigo-500 hover:bg-indigo-600">Exit Preview</button>`
                                : `<button onclick="window.module.togglePreviewMode(true)" class="px-4 py-2 rounded-lg font-semibold text-white bg-green-500 hover:bg-green-600">Preview Site</button>`
                            }
                            <button id="signOutButton" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600">Sign Out</button>
                        </div>
                    </header>
                    <div class="md:flex md:space-x-8">
                        <nav class="w-full md:w-1/4 mb-6 md:mb-0">
                            <div class="bg-white p-4 rounded-xl shadow-lg space-y-2 sticky top-4 ${state.previewMode ? 'opacity-50 pointer-events-none' : ''}">
                                <button onclick="window.module.switchAdminTab('catalog')" class="tab-button w-full text-left p-3 rounded-lg font-semibold ${state.activeTab === 'catalog' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">Category & Products</button>
                                <button onclick="window.module.switchAdminTab('inventory')" class="tab-button w-full text-left p-3 rounded-lg font-semibold ${state.activeTab === 'inventory' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">Inventory</button>
                                <button onclick="window.module.switchAdminTab('orders')" class="tab-button w-full text-left p-3 rounded-lg font-semibold ${state.activeTab === 'orders' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">Orders</button>
                                <button onclick="window.module.switchAdminTab('users')" class="tab-button w-full text-left p-3 rounded-lg font-semibold ${state.activeTab === 'users' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">Registered Users</button>
                                <button onclick="window.module.switchAdminTab('config')" class="tab-button w-full text-left p-3 rounded-lg font-semibold ${state.activeTab === 'config' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">Configuration</button>
                            </div>
                        </nav>
                        <main class="w-full md:w-3/4 space-y-12">
                            ${state.previewMode ? renderPreviewSite() : renderAdminTabs()}
                        </main>
                    </div>
                `;
    
            document.getElementById('signOutButton')?.addEventListener('click', () => {
                clearTimeout(idleTimer);
                signOut(auth).then(() => location.href = '/');
            });
    
            // Initial render logic after DOM is updated
            if (state.activeTab === 'catalog' && !state.previewMode) renderProductListSection();
            if (state.activeTab === 'config' && !state.previewMode) { window.module.fetchAdminConfig(); window.module.displayStaticIps(); }
            if (state.activeTab === 'users' && !state.previewMode) { 
                const grid = document.getElementById('usersGrid');
                // Only fetch users if the list is empty
                if (grid && state.allUsers.length === 0) window.module.fetchUsers();
            }
            if (state.activeTab === 'orders' && !state.previewMode) {
                 if (state.orderPage === 'list') {
                     window.module.fetchOrders();
                 } else {
                     window.module.updateAdminCartDisplay();
                 }
            }
            if (state.activeTab === 'inventory' && !state.previewMode) window.module.renderInventorySection(); // NEW
        }
    
        // --- EXPOSE TO WINDOW (ONLY ONCE!) ---
        window.module = {
                    globalNextPageToken,
                    globalConfig,
                    fetchUsers,
                    renderUserList, 
                    orders,
                    userId,
                    getOrdersCollectionPath,
            
                    fetchAdminConfig,
                    displayStaticIps,
                    handleUpdateConfig, 
            
                    switchAdminTab,
                    switchOrderPage, 
                    handleAddCatalog,
                    handleDeleteCatalog,
                    handleAddProduct,
                    handleDeleteProduct,
                    handleSearchInput, 
                    handleUserSearchInput, 
                    handleOrderSearchInput, 
                    handleOrderListSearchInput, 
                    showEditForm,
                    cancelEdit,
                    handleEditProduct,
                    renderProductListSection,
                    togglePreviewMode,
                    logAdminAction,
            
                    handleBulkUserAction, 
                    handleUserAction, 
                    toggleUserSelection, 
                    toggleAllUsers, 
                    
                    promptForPasswordReset,
                    deleteUser,
                    disableUser,
                    handleClearAnonymousUsers,
                    loadGoogleMapsScript,
            
                    handleAdminOrderSubmit, 
                    addAdminCartItem,
                    removeAdminCartItem,
                    updateAdminCartDisplay, 
                    updateItemSelector, 
                    
                    // NEW Orders Tracking Functions
                    fetchOrders,
                    handleStatusFilterChange,
                    handleOrderStatusUpdate,
                    handleRequestDelivery,
                    renderOrdersList,
                    renderOrderCreateForm,
                    renderOrdersStats,
                    getOrdersStatsHtml,
                    renderSalesCharts,
                    handleSalesTimeFilterChange,
                    renderCategorySalesTable,
                    downloadCategorySalesCsv,
                    handleDeliveryFilterChange, 
                    downloadIndividualItemSalesCsv,
            
                    // <<< NEW ORDER EDIT FUNCTIONS
                    showOrderEditForm,
                    closeEditModal,
                    updateOrder,
                    renderOrderEditModal,
                    // NEW ORDER EDIT FUNCTIONS >>>

                    // NEW DRAFT CART FUNCTIONS
                    initializeDraftCart,      
                    updateDraftCartDisplay,    
                    addDraftCartItem,         
                    removeDraftCartItem,      
                    updateDraftItemQuantity,   
                    
                    // NEW Inventory Functions
                    renderInventorySection,
                    handleUpdateStock,
                    showPurchaseOrderForm 
                };
    
        document.addEventListener('DOMContentLoaded', setupFirebase);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>autoInx Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .grid-header { font-weight: bold; background-color: #f3f4f6; padding: 10px; text-align: left; }
        .grid-item { padding: 10px; border-bottom: 1px solid #e5e7eb; word-break: break-all; }
        .admin-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .tab-button { transition: background-color 0.15s, color 0.15s; }
        .preview-iframe-container {
            height: 80vh;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div id="loadingState" class="text-center p-20">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600">Checking authentication and loading configuration...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & STATE ---
        let auth;
        let db;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let globalNextPageToken = null;
        let globalConfig = { maintenanceMode: false };
        const IDLE_TIMEOUT_MS = 15 * 60 * 1000; // 15 minutes
        let idleTimer;

        const state = {
            activeTab: 'catalog',
            catalogs: [],
            items: [],
            searchTerm: '',
            editingItem: null,
            previewMode: false, 
            adminCart: {}, // <-- NEW state for admin order creation
        };

        // --- FIRESTORE COLLECTION PATHS ---
        const CATALOGS_COLLECTION = `artifacts/${appId}/public/data/catalogs`;
        const ITEMS_COLLECTION = `artifacts/${appId}/public/data/items`;
        const CONFIG_FUNCTION = '/.netlify/functions/getAdminConfig';
        const UPDATE_CONFIG_FUNCTION = '/.netlify/functions/updateAdminConfig';
        const LIST_USERS_FUNCTION = '/.netlify/functions/listUsers';
        const GET_IP_WHITELIST_FUNCTION = '/.netlify/functions/getIpWhitelist';
        const LOG_ACTION_FUNCTION = '/.netlify/functions/logAdminAction';
        const MANAGE_USER_FUNCTION = '/.netlify/functions/manageUser'; 
        const CLEAR_ANON_FUNCTION = '/.netlify/functions/clearAnonymousUsers'; 
        const ADMIN_CREATE_ORDER_FUNCTION = '/.netlify/functions/adminCreateOrder'; // <-- NEW CONSTANT

        // --- CORE FIREBASE SETUP ---
        async function loadFirebaseConfig() {
            try {
                const response = await fetch('/.netlify/functions/getClientFirebaseConfig');
                if (!response.ok) throw new Error(`Failed to fetch config (Status: ${response.status})`);
                return await response.json();
            } catch (error) {
                console.error("Failed to load Firebase configuration:", error);
                return {};
            }
        }

        async function setupFirebase() {
            const firebaseConfig = await loadFirebaseConfig();
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                return;
            }
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            checkAuthAndRender();
        }

        // --- IDLE TIMEOUT LOGIC ---
        function autoLogout() {
            if (auth.currentUser && !auth.currentUser.isAnonymous) {
                console.log("Admin idle timeout — logging out.");
                signOut(auth).then(() => {
                    logAdminAction('ADMIN_AUTO_LOGOUT', { reason: 'Idle Timeout (15m)' });
                    window.location.href = '/?error=idle_timeout';
                });
            }
        }

        function resetTimer() {
            clearTimeout(idleTimer);
            if (auth?.currentUser && !auth.currentUser.isAnonymous) {
                idleTimer = setTimeout(autoLogout, IDLE_TIMEOUT_MS);
            }
        }

        // --- AUTHENTICATION CHECK & REDIRECT ---
        function checkAuthAndRender() {
            onAuthStateChanged(auth, user => {
                if (user && !user.isAnonymous) {
                    user.getIdTokenResult(true).then(idTokenResult => {
                        if (idTokenResult.claims.admin === true) {
                            // Start idle timer
                            document.onmousemove = document.onkeydown = document.onclick = resetTimer;
                            resetTimer();

                            setupRealtimeListeners();
                            renderAdminPage(user.email || 'Admin');
                        } else {
                            signOut(auth);
                            window.location.href = '/?error=unauthorized';
                        }
                    }).catch(err => {
                        console.error("Token error:", err);
                        signOut(auth);
                        window.location.href = '/?error=auth_failed';
                    });
                } else {
                    window.location.href = '/';
                }
            });
        }

        // --- FIRESTORE REALTIME LISTENERS ---
        function setupRealtimeListeners() {
            if (!db) return;

            onSnapshot(collection(db, CATALOGS_COLLECTION), snap => {
                state.catalogs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (state.activeTab === 'catalog' && !state.previewMode) renderProductListSection();
            }, err => {
                console.error("Error listening to catalogs:", err);
                showMessage('error', 'Failed to fetch catalogs.');
            });

            onSnapshot(collection(db, ITEMS_COLLECTION), snap => {
                state.items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (state.activeTab === 'catalog' && !state.previewMode) renderProductListSection();
                // If on the orders tab, update the item selector
                if (state.activeTab === 'orders' && !state.previewMode) renderAdminOrderSection();
            }, err => {
                console.error("Error listening to items:", err);
                showMessage('error', 'Failed to fetch items.');
            });
        }

        // --- HELPER FUNCTIONS ---
        function formatPriceDisplay(cents) {
            return `$${(cents / 100).toFixed(2)}`;
        }

        function formatTime(ts) {
            if (!ts) return 'N/A';
            const date = ts.toDate ? ts.toDate() : new Date(ts);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function showMessage(type, text, duration = 5000) {
            const id = state.activeTab === 'config' ? 'configMessage' : state.activeTab === 'orders' ? 'ordersMessage' : 'catalogMessage';
            const el = document.getElementById(id);
            if (!el) return;
            el.className = `mt-4 text-center text-sm font-medium ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
            el.textContent = text;
            setTimeout(() => el.textContent = '', duration);
        }

        async function logAdminAction(actionType, details, objectId = null) {
            try {
                await fetch(LOG_ACTION_FUNCTION, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        actionType,
                        details,
                        performedByEmail: auth.currentUser?.email || 'Unknown',
                        objectId
                    })
                });
            } catch (e) { console.error("Log failed:", e); }
        }

        function generateUniqueSku() {
            const t = Date.now().toString(36).toUpperCase();
            const r = Math.random().toString(36).substring(2, 4).toUpperCase();
            return `AX-${t}${r}`;
        }

        function getFilteredItems() {
            if (!state.searchTerm) return state.items;
            const term = state.searchTerm.toLowerCase();
            return state.items.filter(item => {
                const catName = state.catalogs.find(c => c.id === item.catalogId)?.name || 'Uncategorized';
                return item.name.toLowerCase().includes(term) ||
                       item.description.toLowerCase().includes(term) ||
                       catName.toLowerCase().includes(term) ||
                       (item.sku && item.sku.toLowerCase().includes(term));
            });
        }

        // --- UI ACTIONS ---
        function togglePreviewMode(enable) {
            state.previewMode = enable;
            renderAdminPage(auth.currentUser?.email || 'Admin');
            resetTimer();
        }

        function switchAdminTab(tab) {
            state.activeTab = tab;
            state.editingItem = null;
            state.previewMode = false; // Ensure preview is off when switching tabs
            renderAdminPage(auth.currentUser?.email || 'Admin');
            resetTimer();

            if (tab === 'config') {
                window.module.fetchAdminConfig();
                window.module.displayStaticIps();
            } else if (tab === 'users') {
                const grid = document.getElementById('usersGrid');
            } else if (tab === 'orders') {
                // Ensure cart display is updated when switching to Orders tab
                updateAdminCartDisplay(); 
            }
        }

        function handleSearchInput(e) {
            state.searchTerm = e.target.value;
            renderProductListSection();
            resetTimer();
        }

        function showEditForm(item) {
            state.editingItem = item;
            renderAdminPage(auth.currentUser?.email || 'Admin');
            resetTimer();
        }

        function cancelEdit() {
            state.editingItem = null;
            renderAdminPage(auth.currentUser?.email || 'Admin');
            resetTimer();
        }

        // --- CATALOG & PRODUCT CRUD (omitted for brevity, assume contents are present) ---
        // ...

        // --- USER MANAGEMENT ACTIONS (omitted for brevity, assume contents are present) ---
        // ...

        // --- ANONYMOUS USER CLEANUP (omitted for brevity, assume contents are present) ---
        // ...

        // --- ADMIN ORDER CREATION FUNCTIONS ---

        function getTotalAdminCartPrice() {
            return Object.values(state.adminCart).reduce((total, entry) => total + (entry.item.price || 0) * entry.quantity, 0);
        }
        
        function renderAdminCart() {
            const cartEntries = Object.values(state.adminCart);
            if (cartEntries.length === 0) {
                return '<p class="text-gray-500 italic">No items added to this order yet.</p>';
            }

            return cartEntries.map(entry => {
                return `
                    <div class="flex justify-between items-center border-b pb-1">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${entry.item.name}</p>
                            <p class="text-xs text-gray-500">${formatPriceDisplay(entry.item.price)} x ${entry.quantity}</p>
                        </div>
                        <span class="text-sm font-bold ml-4 text-pink-600">${formatPriceDisplay(entry.item.price * entry.quantity)}</span>
                        <button type="button" onclick="window.module.removeAdminCartItem('${entry.item.id}')"
                                class="text-red-500 hover:text-red-700 ml-2 text-sm">×</button>
                    </div>
                `;
            }).join('');
        }

        function renderItemSelectorOptions() {
            return state.items.map(item => `<option value="${item.id}">${item.name} (${formatPriceDisplay(item.price)})</option>`).join('');
        }
        
        function updateAdminCartDisplay() {
            const cartEl = document.getElementById('adminCartDisplay');
            const totalEl = document.getElementById('adminCartTotal');
            const selectorEl = document.getElementById('itemSelector');
            
            if (cartEl) cartEl.innerHTML = renderAdminCart();
            if (totalEl) totalEl.textContent = formatPriceDisplay(getTotalAdminCartPrice());
            if (selectorEl) selectorEl.innerHTML = `<option value="">-- Select Product --</option>${renderItemSelectorOptions()}`;
            
            // Disable submit button if cart is empty
            const submitBtn = document.getElementById('submitOrderButton');
            if (submitBtn) submitBtn.disabled = Object.keys(state.adminCart).length === 0;
            
            resetTimer();
        }

        function addAdminCartItem() {
            const selector = document.getElementById('itemSelector');
            const quantityInput = document.getElementById('itemQuantity');
            const itemId = selector.value;
            const quantity = parseInt(quantityInput.value);

            if (!itemId || isNaN(quantity) || quantity <= 0) {
                showMessage('error', 'Please select an item and enter a valid quantity.', 3000);
                return;
            }

            const item = state.items.find(i => i.id === itemId);
            if (!item) return;

            // Add or overwrite the item in the cart
            state.adminCart = {
                ...state.adminCart,
                [itemId]: { item, quantity }
            };

            showMessage('success', `Added ${quantity}x ${item.name} to the order.`, 2000);
            quantityInput.value = 1;
            selector.value = '';
            updateAdminCartDisplay();
        }

        function removeAdminCartItem(itemId) {
            const item = state.adminCart[itemId]?.item;
            const newCart = { ...state.adminCart };
            delete newCart[itemId];
            state.adminCart = newCart;
            showMessage('info', `${item.name} removed from order.`, 2000);
            updateAdminCartDisplay();
        }
        
        async function handleAdminOrderSubmit(event) {
            event.preventDefault();
            resetTimer();

            if (Object.keys(state.adminCart).length === 0) {
                showMessage('error', 'The order cart is empty!', 3000);
                return;
            }

            const buyerName = document.getElementById('buyerName').value.trim();
            const buyerEmail = document.getElementById('buyerEmail').value.trim();
            const buyerPhone = document.getElementById('buyerPhone').value.trim();
            const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
            const notes = document.getElementById('orderNotes').value.trim();
            const totalCents = getTotalAdminCartPrice();

            const submitBtn = document.getElementById('submitOrderButton');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            const orderDetails = {
                buyerName,
                buyerEmail,
                buyerPhone,
                deliveryAddress,
                notes,
                items: Object.values(state.adminCart).map(entry => ({
                    id: entry.item.id,
                    name: entry.item.name,
                    price: entry.item.price, // in cents
                    quantity: entry.quantity,
                    catalog: state.catalogs.find(c => c.id === entry.item.catalogId)?.name || 'N/A'
                })),
                totalCents
            };

            try {
                const idToken = await auth.currentUser.getIdToken();

                const response = await fetch(ADMIN_CREATE_ORDER_FUNCTION, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderDetails)
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.details || result.error || response.statusText);
                }

                showMessage('success', `Order ${result.orderId.slice(0, 8)}... created and email sent.`, 8000);
                await logAdminAction('ORDER_CREATED', { orderId: result.orderId, buyer: buyerEmail });
                
                // Clear form and cart on success
                document.getElementById('createOrderForm').reset();
                state.adminCart = {};
                updateAdminCartDisplay();

            } catch (error) {
                console.error("Admin Order creation failed:", error);
                showMessage('error', `Order failed: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'SUBMIT ORDER & SEND EMAIL';
            }
        }
        
        function renderAdminOrderSection() {
            // This function ensures the order form is updated with the latest items
            const orderSectionEl = document.getElementById('ordersSection');
            if (!orderSectionEl || state.activeTab !== 'orders') return;
            
            // This is a minimal update to re-render the dynamic parts
            const itemSelector = document.getElementById('itemSelector');
            const cartTotal = document.getElementById('adminCartTotal');
            
            if (itemSelector) itemSelector.innerHTML = `<option value="">-- Select Product --</option>${renderItemSelectorOptions()}`;
            if (cartTotal) cartTotal.textContent = formatPriceDisplay(getTotalAdminCartPrice());
        }

        // --- RENDERING ---
        
        // ... (renderEditProductForm, renderProductListSection, renderPreviewSite omitted for brevity)

        function renderAdminTabs() {
            const catOpts = state.catalogs.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            return `
                <section id="catalogSection" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500 ${state.activeTab === 'catalog' ? '' : 'hidden'}">
                    <h2 class="text-2xl font-bold mb-6 text-indigo-700">Catalog & Product Management</h2>
                    <div id="catalogMessage" class="mt-4 text-center text-sm font-medium"></div>
                    ${state.editingItem ? renderEditProductForm() : ''}
                    <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                        <h3 class="text-xl font-semibold mb-3 text-indigo-600">Search Products</h3>
                        <input type="text" id="productSearch" placeholder="Search by name, description, category, SKU..." oninput="window.module.handleSearchInput(event)" value="${state.searchTerm}" class="w-full p-2 border rounded-lg">
                    </div>
                    <div id="productListContainer"></div>
                    <div class="mb-8 p-4 border rounded-lg bg-gray-50">
                        <h3 class="text-xl font-semibold mb-3 text-indigo-600">Create New Catalog Category</h3>
                        <form onsubmit="window.module.handleAddCatalog(event)" class="flex space-x-3">
                            <input name="catalogName" placeholder="e.g., T-Shirts" required class="flex-grow p-2 border rounded-lg">
                            <button type="submit" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600">Add</button>
                        </form>
                        <div class="mt-3 text-sm text-gray-700">
                            Current: ${state.catalogs.length ? state.catalogs.map(c => `<span class="inline-flex items-center bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-2">${c.name} <button onclick="window.module.handleDeleteCatalog('${c.id}','${c.name}')" class="ml-1 text-red-500 hover:text-red-700">×</button></span>`).join('') : 'None'}
                        </div>
                    </div>
                    <div class="mb-10 p-6 border rounded-xl shadow-md bg-white">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Add New Product</h3>
                        <form onsubmit="window.module.handleAddProduct(event)" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input name="itemName" placeholder="Product Name" required class="p-2 border rounded-lg">
                                <select name="catalogId" required class="p-2 border rounded-lg"><option value="">-- Category --</option>${catOpts}</select>
                            </div>
                            <textarea name="itemDescription" placeholder="Description" rows="2" required class="w-full p-2 border rounded-lg"></textarea>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="number" step="0.01" name="itemPrice" placeholder="Price (e.g., 19.99)" required class="p-2 border rounded-lg">
                                <input type="url" name="itemImageUrl" placeholder="Image URL (optional)" class="p-2 border rounded-lg">
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Save Product</button>
                        </form>
                    </div>
                </section>

                <section id="configSection" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-yellow-500 ${state.activeTab === 'config' ? '' : 'hidden'}">
                    <h2 class="text-2xl font-bold mb-4 text-yellow-700">System Configuration</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="font-semibold text-lg mb-2">Maintenance Mode</h3>
                            <p class="text-sm text-gray-500 mb-3">Locks the site for regular users.</p>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="maintenanceModeToggle" class="sr-only peer">
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                                <span class="ms-3 text-sm font-medium text-gray-900" id="maintenanceStatus">Loading...</span>
                            </label>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg mb-2">Admin IP Whitelist (Static)</h3>
                            <p class="text-sm text-gray-500 mb-3">Loaded from Netlify function.</p>
                            <div id="staticIpList" class="p-2 bg-gray-50 border rounded-lg text-sm text-gray-700">Loading IPs...</div>
                        </div>
                    </div>
                    <div id="configMessage" class="mt-4 text-center text-sm font-medium"></div>
                    
                    <div class="pt-6 mt-6 border-t border-gray-200 col-span-full">
                        <h3 class="font-semibold text-lg mb-2 text-red-600">Maintenance: Anonymous Users</h3>
                        <button id="clearAnonButton" onclick="window.module.handleClearAnonymousUsers()" class="px-4 py-2 bg-red-600 text-white rounded-lg disabled:bg-red-300 hover:bg-red-700">Clear All Anonymous Users</button>
                        <p class="text-xs text-gray-500 mt-2">Removes all Firebase Auth users who have not registered with a permanent provider.</p>
                    </div>
                </section>

                <section id="usersSection" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500 ${state.activeTab === 'users' ? '' : 'hidden'}">
                    <h2 class="text-2xl font-bold mb-4 text-indigo-700">Registered Users</h2>
                    <div id="usersGrid" class="grid gap-x-4 admin-grid">
                        <div class="grid-header">Email</div><div class="grid-header">UID</div><div class="grid-header">Verified</div>
                        <div class="grid-header">Created</div><div class="grid-header">Last Sign-In</div><div class="grid-header">Status</div>
                        <div class="grid-header">Actions</div>
                    </div>
                    <div id="noUsersMessage" class="text-center p-4 text-gray-500 hidden">No registered users found.</div>
                    <div id="loadingMessage" class="text-center p-4 hidden">Loading...</div>
                    <div class="flex justify-end mt-6">
                        <button id="nextPageButton" onclick="window.module.fetchUsers(window.module.globalNextPageToken)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg disabled:bg-indigo-300">Load Next 100 Users</button>
                    </div>
                </section>

                <section id="ordersSection" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-pink-500 ${state.activeTab === 'orders' ? '' : 'hidden'}">
                    <h2 class="text-2xl font-bold mb-4 text-pink-700">Order Management</h2>
                    <div id="ordersMessage" class="mt-4 text-center text-sm font-medium"></div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        <div class="lg:col-span-2 p-6 border rounded-xl shadow-md bg-gray-50">
                            <h3 class="text-xl font-semibold mb-4 text-pink-600">Create New Manual Order</h3>
                            <form id="createOrderForm" onsubmit="window.module.handleAdminOrderSubmit(event)" class="space-y-4">
                                
                                <h4 class="font-bold pt-2 border-t text-gray-700">Buyer Details</h4>
                                <input type="text" id="buyerName" placeholder="Full Name" required class="w-full p-2 border rounded-lg">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="email" id="buyerEmail" placeholder="Email Address" required class="p-2 border rounded-lg">
                                    <input type="tel" id="buyerPhone" placeholder="Phone Number (Optional)" class="p-2 border rounded-lg">
                                </div>
                                <textarea id="deliveryAddress" placeholder="Delivery Address" rows="2" required class="w-full p-2 border rounded-lg"></textarea>
                                <textarea id="orderNotes" placeholder="Internal/Delivery Notes (Optional)" rows="2" class="w-full p-2 border rounded-lg"></textarea>

                                <h4 class="font-bold pt-4 border-t text-gray-700">Items & Total</h4>
                                <div id="adminCartDisplay" class="space-y-3 p-3 bg-white rounded-lg border">
                                    ${Object.keys(state.adminCart).length === 0 ? '<p class="text-gray-500 italic">No items added to this order yet.</p>' : ''}
                                </div>
                                <div class="flex justify-between items-center font-bold text-lg pt-2">
                                    <span>TOTAL:</span>
                                    <span id="adminCartTotal">${formatPriceDisplay(getTotalAdminCartPrice())}</span>
                                </div>
                                
                                <h4 class="font-bold pt-4 border-t text-gray-700">Add Item to Order</h4>
                                <div class="flex space-x-3">
                                    <select id="itemSelector" class="flex-grow p-2 border rounded-lg">
                                        <option value="">-- Select Product --</option>
                                        ${state.items.map(item => `<option value="${item.id}">${item.name} (${formatPriceDisplay(item.price)})</option>`).join('')}
                                    </select>
                                    <input type="number" id="itemQuantity" placeholder="Qty" value="1" min="1" required class="w-16 p-2 border rounded-lg">
                                    <button type="button" onclick="window.module.addAdminCartItem()" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600">Add</button>
                                </div>

                                <button type="submit" id="submitOrderButton" disabled
                                    class="w-full bg-pink-600 text-white py-3 rounded-lg font-extrabold hover:bg-pink-700 transition duration-150 shadow-md disabled:bg-pink-300 disabled:cursor-not-allowed">
                                    SUBMIT ORDER & SEND EMAIL
                                </button>
                            </form>
                        </div>

                        <div class="lg:col-span-1 p-6 border rounded-xl shadow-md bg-white">
                            <h3 class="text-xl font-semibold mb-4 text-pink-600">Recent Admin Orders (Placeholder)</h3>
                            <p class="text-gray-500">Functionality to view recent orders will be implemented here.</p>
                        </div>
                    </div>
                </section>
            `;
        }

        function renderAdminPage(userName) {
            document.getElementById('app').innerHTML = `
                <header class="flex justify-between items-center mb-10 pb-4 border-b-4 border-indigo-600">
                    <h1 class="text-4xl font-extrabold text-indigo-700">Admin Dashboard</h1>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600 font-medium text-sm hidden sm:inline">Welcome, ${userName}</span>
                        ${state.previewMode
                            ? `<button onclick="window.module.togglePreviewMode(false)" class="px-4 py-2 rounded-lg font-semibold text-white bg-indigo-500 hover:bg-indigo-600">Exit Preview</button>`
                            : `<button onclick="window.module.togglePreviewMode(true)" class="px-4 py-2 rounded-lg font-semibold text-white bg-green-500 hover:bg-green-600">Preview Site</button>`
                        }
                        <button id="signOutButton" class="px-4 py-2 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600">Sign Out</button>
                    </div>
                </header>

                <div class="md:flex md:space-x-8">
                    <nav class="w-full md:w-1/4 mb-6 md:mb-0">
                        <div class="bg-white p-4 rounded-xl shadow-lg space-y-2 sticky top-4 ${state.previewMode ? 'opacity-50 pointer-events-none' : ''}">
                            <button onclick="window.module.switchAdminTab('catalog')" class="tab-button w-full text-left p-3 rounded-lg font-semibold ${state.activeTab === 'catalog' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">Catalog & Products</button>
                            <button onclick="window.module.switchAdminTab('config')" class="tab-button w-full text-left p-3 rounded-lg font-semibold ${state.activeTab === 'config' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">Configuration</button>
                            <button onclick="window.module.switchAdminTab('users')" class="tab-button w-full text-left p-3 rounded-lg font-semibold ${state.activeTab === 'users' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">Registered Users</button>
                            <button onclick="window.module.switchAdminTab('orders')" class="tab-button w-full text-left p-3 rounded-lg font-semibold ${state.activeTab === 'orders' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">Orders</button>
                        </div>
                    </nav>
                    <main class="w-full md:w-3/4 space-y-12">
                        ${state.previewMode ? renderPreviewSite() : renderAdminTabs()}
                    </main>
                </div>
            `;

            document.getElementById('signOutButton')?.addEventListener('click', () => {
                clearTimeout(idleTimer);
                signOut(auth).then(() => location.href = '/');
            });

            if (state.activeTab === 'catalog' && !state.previewMode) renderProductListSection();
            if (state.activeTab === 'config' && !state.previewMode) { window.module.fetchAdminConfig(); window.module.displayStaticIps(); }
            if (state.activeTab === 'users' && !state.previewMode && document.getElementById('usersGrid')?.children.length <= 7) window.module.fetchUsers();
            if (state.activeTab === 'orders' && !state.previewMode) window.module.updateAdminCartDisplay();
        }

        // --- CONFIG & USERS (omitted for brevity, assume contents are present) ---
        // ...

        // --- EXPOSE TO WINDOW ---
        window.module = {
            globalNextPageToken, globalConfig,
            fetchUsers, displayUsers, fetchAdminConfig, updateMaintenanceMode, displayStaticIps,
            switchAdminTab, handleAddCatalog, handleDeleteCatalog, handleAddProduct, handleDeleteProduct,
            handleSearchInput, showEditForm, cancelEdit, handleEditProduct, renderProductListSection,
            togglePreviewMode, logAdminAction,
            handleUserAction, promptForPasswordReset, deleteUser, disableUser,
            handleClearAnonymousUsers,
            // ADDED ADMIN ORDER FUNCTIONS:
            handleAdminOrderSubmit, addAdminCartItem, removeAdminCartItem, updateAdminCartDisplay
        };

        document.addEventListener('DOMContentLoaded', setupFirebase);
    </script>
</body>
</html>
